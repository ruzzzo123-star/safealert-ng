<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
  <title>SafeAlert NG</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#FF375F">
  <meta name="description" content="SafeAlert NG - Emergency Response & Safety App for Nigeria. SOS alerts, trip monitoring, incident reporting, and community safety.">
  <meta name="keywords" content="safety, emergency, Nigeria, SOS, security, alert, Lagos, kidnapping, robbery">
  <meta name="author" content="SafeAlert NG">
  
  <!-- iOS PWA Support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SafeAlert">
  <link rel="apple-touch-icon" href="apple-touch-icon.png">
  <link rel="apple-touch-icon" sizes="180x180" href="apple-touch-icon.png">
  
  <!-- Android PWA Support -->
  <link rel="manifest" href="manifest.json">
  
  <!-- Favicon -->
  <link rel="icon" type="image/png" sizes="192x192" href="web-app-manifest-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="web-app-manifest-192x192.png">
  
  <!-- Microsoft Tiles -->
  <meta name="msapplication-TileColor" content="#FF375F">
  <meta name="msapplication-TileImage" content="web-app-manifest-192x192.png">
  
  <!-- Open Graph / Social Sharing -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="SafeAlert NG - Stay Safe in Nigeria">
  <meta property="og:description" content="Emergency Response & Safety App. SOS alerts, trip monitoring, incident reporting.">
  <meta property="og:image" content="web-app-manifest-512x512.png">
  <meta property="og:url" content="https://safealert-ng.vercel.app">
  
  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="SafeAlert NG">
  <meta name="twitter:description" content="Emergency Response & Safety App for Nigeria">
  <meta name="twitter:image" content="web-app-manifest-512x512.png">
  
  <style>
    /* =============================================
       CSS VARIABLES SYSTEM
       ============================================= */
    :root {
      /* Colors */
      --color-safe: #32D74B;
      --color-safe-glow: rgba(50, 215, 75, 0.4);
      --color-warning: #FF9F0A;
      --color-warning-glow: rgba(255, 159, 10, 0.4);
      --color-danger: #FF375F;
      --color-danger-glow: rgba(255, 55, 95, 0.5);
      --color-info: #64D2FF;
      --color-info-glow: rgba(100, 210, 255, 0.4);
      --color-purple: #BF5AF2;
      --color-purple-glow: rgba(191, 90, 242, 0.4);
      --color-card: #1C1C1E;
      --color-card-border: rgba(255, 255, 255, 0.06);
      --color-divider: #2C2C2E;
      --color-text-secondary: #8E8E93;
      --color-text-tertiary: #636366;
      
      /* Spring Physics */
      --spring-bounce: cubic-bezier(0.175, 0.885, 0.32, 1.275);
      --spring-smooth: cubic-bezier(0.4, 0, 0.2, 1);
      --spring-snap: cubic-bezier(0.68, -0.55, 0.265, 1.55);
      --spring-gentle: cubic-bezier(0.25, 0.46, 0.45, 0.94);
      
      /* Timing */
      --duration-fast: 0.15s;
      --duration-normal: 0.3s;
      --duration-slow: 0.5s;
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
      background: #000;
      color: #fff;
      min-height: 100vh;
      overflow-x: hidden;
    }
    
    /* Hide scrollbars but keep scroll functionality (iOS style) */
    * {
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE and Edge */
    }
    
    *::-webkit-scrollbar {
      display: none; /* Chrome, Safari, Opera */
    }
    
    /* =============================================
       PWA SPECIFIC STYLES
       ============================================= */
    /* Safe area padding for notched devices */
    @supports (padding-top: env(safe-area-inset-top)) {
      .static-header {
        padding-top: calc(12px + env(safe-area-inset-top));
      }
      
      .bottom-nav {
        padding-bottom: calc(10px + env(safe-area-inset-bottom));
      }
    }
    
    /* PWA mode adjustments */
    .pwa-mode .static-header {
      padding-top: calc(12px + env(safe-area-inset-top, 0px));
    }
    
    .pwa-mode .bottom-nav {
      padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
    }
    
    /* Offline mode indicator */
    .offline-mode::after {
      content: 'ðŸ“¡ Offline Mode';
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      background: linear-gradient(135deg, #FF9F0A, #e08900);
      color: #000;
      text-align: center;
      padding: 4px;
      font-size: 12px;
      font-weight: 600;
      z-index: 10001;
    }
    
    .offline-mode .static-header {
      margin-top: 24px;
    }
    
    /* Install banner animation */
    @keyframes slideUp {
      from { transform: translateY(100px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .app {
      max-width: 430px;
      margin: 0 auto;
      min-height: 100vh;
      position: relative;
      overflow: hidden;
    }
    
    /* =============================================
       AMBIENT LIGHTING SYSTEM
       ============================================= */
    .ambient-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      max-width: 430px;
      margin: 0 auto;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    
    .glow-orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.4;
      animation: orbFloat 20s ease-in-out infinite;
    }
    
    .glow-orb.primary {
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, var(--color-safe-glow) 0%, transparent 70%);
      top: -100px;
      right: -100px;
      animation-delay: 0s;
    }
    
    .glow-orb.secondary {
      width: 250px;
      height: 250px;
      background: radial-gradient(circle, var(--color-info-glow) 0%, transparent 70%);
      bottom: 200px;
      left: -80px;
      animation-delay: -7s;
    }
    
    .glow-orb.accent {
      width: 200px;
      height: 200px;
      background: radial-gradient(circle, var(--color-purple-glow) 0%, transparent 70%);
      top: 40%;
      right: -60px;
      animation-delay: -14s;
    }
    
    @keyframes orbFloat {
      0%, 100% { transform: translate(0, 0) scale(1); }
      25% { transform: translate(30px, -20px) scale(1.1); }
      50% { transform: translate(-20px, 30px) scale(0.9); }
      75% { transform: translate(20px, 20px) scale(1.05); }
    }
    
    /* Danger mode orbs */
    .app.danger-mode .glow-orb.primary,
    .app.danger-mode .glow-orb.secondary,
    .app.danger-mode .glow-orb.accent {
      background: radial-gradient(circle, var(--color-danger-glow) 0%, transparent 70%);
      animation: orbDanger 1.5s ease-in-out infinite;
      opacity: 0.6;
    }
    
    @keyframes orbDanger {
      0%, 100% { transform: scale(1); opacity: 0.4; }
      50% { transform: scale(1.2); opacity: 0.7; }
    }
    
    /* =============================================
       GLASSMORPHISM COMPONENTS
       ============================================= */
    .glass {
      background: rgba(28, 28, 30, 0.7);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.08);
    }
    
    .glass-light {
      background: rgba(255, 255, 255, 0.05);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .glass-heavy {
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(40px);
      -webkit-backdrop-filter: blur(40px);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    /* =============================================
       SCREEN TRANSITIONS
       ============================================= */
    .screen {
      display: none;
      min-height: 100vh;
      padding-bottom: 120px;
      position: relative;
      z-index: 1;
    }
    
    .screen.active {
      display: block;
      animation: screenEnter var(--duration-slow) var(--spring-smooth) forwards;
    }
    
    @keyframes screenEnter {
      from { opacity: 0; transform: translateX(20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    /* Staggered children animation */
    .screen.active .stagger-item {
      opacity: 0;
      transform: translateY(15px);
      animation: staggerIn var(--duration-normal) var(--spring-bounce) forwards;
    }
    
    .screen.active .stagger-item:nth-child(1) { animation-delay: 0.05s; }
    .screen.active .stagger-item:nth-child(2) { animation-delay: 0.1s; }
    .screen.active .stagger-item:nth-child(3) { animation-delay: 0.15s; }
    .screen.active .stagger-item:nth-child(4) { animation-delay: 0.2s; }
    .screen.active .stagger-item:nth-child(5) { animation-delay: 0.25s; }
    .screen.active .stagger-item:nth-child(6) { animation-delay: 0.3s; }
    .screen.active .stagger-item:nth-child(7) { animation-delay: 0.35s; }
    .screen.active .stagger-item:nth-child(8) { animation-delay: 0.4s; }
    
    @keyframes staggerIn {
      to { opacity: 1; transform: translateY(0); }
    }
    
    .screen.fullscreen {
      padding: 0;
      padding-bottom: 90px;
    }
    
    /* =============================================
       STATIC HEADER STYLES
       ============================================= */
    .static-header {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      max-width: 430px;
      margin: 0 auto;
      z-index: 100;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 12px 0 8px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .scrollable-content {
      padding-top: 125px; /* Reduced - no fake status bar */
      padding-bottom: 100px;
    }
    
    /* =============================================
       ENHANCED STATUS BAR
       ============================================= */
    .status-bar {
      display: none; /* Hidden - phone shows real status bar */
      justify-content: space-between;
      align-items: center;
      padding: 8px 20px;
      font-size: 14px;
      font-weight: 600;
    }
    
    .status-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .status-time {
      font-weight: 600;
      font-variant-numeric: tabular-nums;
    }
    
    .status-right {
      display: flex;
      align-items: center;
      gap: 5px;
    }
    
    .signal-bars {
      display: flex;
      align-items: flex-end;
      gap: 1.5px;
      height: 12px;
    }
    
    .signal-bar {
      width: 3px;
      background: #fff;
      border-radius: 1px;
    }
    
    .signal-bar:nth-child(1) { height: 4px; }
    .signal-bar:nth-child(2) { height: 6px; }
    .signal-bar:nth-child(3) { height: 8px; }
    .signal-bar:nth-child(4) { height: 11px; }
    
    .wifi-icon {
      font-size: 15px;
      margin-left: 2px;
    }
    
    .battery-container {
      display: flex;
      align-items: center;
      gap: 2px;
      margin-left: 3px;
    }
    
    .battery-body {
      width: 24px;
      height: 11px;
      border: 1.5px solid #fff;
      border-radius: 3px;
      padding: 1.5px;
      position: relative;
    }
    
    .battery-level {
      height: 100%;
      width: 80%;
      background: var(--color-safe);
      border-radius: 1px;
      transition: width 0.3s, background 0.3s;
    }
    
    .battery-cap {
      width: 2px;
      height: 5px;
      background: #fff;
      border-radius: 0 1px 1px 0;
    }
    
    /* Dynamic Island - Hidden by default, shown only during emergency/trip */
    .island {
      width: calc(100% - 40px);
      height: 70px;
      background: linear-gradient(135deg, rgba(255,55,95,0.25), rgba(255,55,95,0.1));
      border-radius: 24px;
      margin: 10px auto;
      transition: all 0.4s var(--spring-smooth);
      display: none;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
    }
    
    /* Animated border gradient */
    .island::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 24px;
      padding: 1.5px;
      background: linear-gradient(135deg, var(--color-danger), var(--color-warning), var(--color-danger));
      background-size: 200% 200%;
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      animation: borderGradient 3s linear infinite;
      opacity: 0.8;
    }
    
    @keyframes borderGradient {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    
    .island.expanded {
      display: flex;
      width: calc(100% - 40px);
      height: 70px;
      border-radius: 24px;
      background: linear-gradient(135deg, rgba(255,55,95,0.25), rgba(255,55,95,0.1));
      animation: islandPulse 2s ease-in-out infinite;
    }
    
    @keyframes islandPulse {
      0%, 100% { box-shadow: 0 0 20px rgba(255, 55, 95, 0.2); }
      50% { box-shadow: 0 0 40px rgba(255, 55, 95, 0.4); }
    }
    
    .island.trip-active {
      display: flex;
      width: calc(100% - 40px);
      height: 70px;
      border-radius: 24px;
      background: linear-gradient(135deg, rgba(100,210,255,0.25), rgba(100,210,255,0.1));
    }
    
    .island.trip-active::before {
      background: linear-gradient(135deg, var(--color-info), var(--color-safe), var(--color-info));
      background-size: 200% 200%;
    }
    
    .island-content {
      display: none;
      align-items: center;
      gap: 14px;
      padding: 0 20px;
      width: 100%;
      position: relative;
      z-index: 1;
    }
    
    .island.expanded .island-content,
    .island.trip-active .island-content {
      display: flex;
    }
    
    .island-icon {
      width: 40px;
      height: 40px;
      background: #FF375F;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      box-shadow: 0 0 15px rgba(255, 55, 95, 0.5);
    }
    
    .island.trip-active .island-icon {
      background: #64D2FF;
      box-shadow: 0 0 15px rgba(100, 210, 255, 0.5);
    }
    
    .island-title { font-weight: 700; color: #FF375F; font-size: 14px; }
    .island.trip-active .island-title { color: #64D2FF; }
    .island-sub { font-size: 11px; color: #8E8E93; }
    
    /* Header */
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 20px;
      margin-bottom: 10px;
    }
    
    .logo {
      width: 44px;
      height: 44px;
      background: linear-gradient(145deg, #FF375F, #c41e3a);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      box-shadow: 0 4px 20px rgba(255,55,95,0.3);
    }
    
    .header h1 { font-size: 22px; }
    .header p { color: #8E8E93; font-size: 12px; }
    
    /* COMPACT Location Banner */
    .location-compact {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #1C1C1E;
      border-radius: 12px;
      padding: 8px 12px;
      margin: 0 20px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    
    .location-compact-icon {
      width: 28px;
      height: 28px;
      background: rgba(100,210,255,0.15);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
    }
    
    .location-compact-text { flex: 1; }
    .location-compact-city { font-weight: 600; font-size: 13px; }
    .location-compact-state { font-size: 11px; color: #8E8E93; }
    .location-compact-change { color: #64D2FF; font-size: 12px; cursor: pointer; }
    
    /* State Selector Modal */
    .state-selector-modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.95);
      z-index: 200;
      display: none;
      flex-direction: column;
      padding: 20px;
    }
    
    .state-selector-modal.show {
      display: flex;
    }
    
    .state-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .state-modal-title {
      font-size: 20px;
      font-weight: 700;
    }
    
    .state-modal-close {
      width: 32px;
      height: 32px;
      background: #2C2C2E;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    
    .state-search {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #1C1C1E;
      border-radius: 12px;
      padding: 12px 16px;
      margin-bottom: 16px;
    }
    
    .state-search input {
      flex: 1;
      background: none;
      border: none;
      color: #fff;
      font-size: 16px;
      outline: none;
    }
    
    .state-search input::placeholder {
      color: #636366;
    }
    
    .state-list {
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    .state-region-header {
      font-size: 12px;
      color: #8E8E93;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 12px 0 8px;
      font-weight: 600;
      position: sticky;
      top: 0;
      background: rgba(0,0,0,0.95);
    }
    
    .state-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      cursor: pointer;
    }
    
    .state-item:active {
      background: rgba(255,255,255,0.05);
    }
    
    .state-item-icon {
      font-size: 20px;
    }
    
    .state-item-name {
      flex: 1;
      font-size: 16px;
    }
    
    .state-item-check {
      color: #64D2FF;
      font-size: 18px;
      display: none;
    }
    
    .state-item.selected .state-item-check {
      display: block;
    }
    
    /* Ambient Glow */
    .glow {
      position: fixed;
      top: -100px;
      right: -100px;
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, rgba(50,215,75,0.3) 0%, transparent 70%);
      pointer-events: none;
      opacity: 0.5;
      transition: all 0.5s ease;
      z-index: 0;
    }
    
    .glow.danger {
      background: radial-gradient(circle, rgba(255,55,95,0.4) 0%, transparent 70%);
      opacity: 0.8;
      animation: pulse-glow 1s infinite;
    }
    
    @keyframes pulse-glow {
      0%, 100% { opacity: 0.6; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.1); }
    }
    
    /* Screens */
    .screen {
      display: none;
      min-height: 100vh;
      padding-bottom: 120px; /* Space for bottom nav */
    }
    
    .screen.active {
      display: block;
    }
    
    .screen.fullscreen {
      padding: 0;
      padding-bottom: 90px;
    }
    
    /* Safety Card */
    .safety {
      background: linear-gradient(135deg, rgba(50,215,75,0.15), rgba(50,215,75,0.05));
      border: 1px solid rgba(50,215,75,0.3);
      border-radius: 20px;
      padding: 16px;
      margin: 0 20px 20px;
      display: flex;
      align-items: center;
      gap: 14px;
      transition: all 0.3s var(--spring-smooth);
      position: relative;
      overflow: hidden;
    }
    
    .safety::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 20px;
      width: 60px;
      height: 60px;
      transform: translateY(-50%);
      border-radius: 50%;
      border: 2px solid rgba(50,215,75,0.2);
      animation: safetyRing 3s ease-out infinite;
      pointer-events: none;
    }
    
    @keyframes safetyRing {
      0% { width: 48px; height: 48px; opacity: 0.5; }
      100% { width: 100px; height: 100px; opacity: 0; }
    }
    
    .safety.danger {
      background: linear-gradient(135deg, rgba(255,55,95,0.2), rgba(255,55,95,0.05));
      border-color: rgba(255,55,95,0.4);
    }
    
    .safety.danger::before {
      border-color: rgba(255,55,95,0.3);
      animation: safetyRingDanger 1.5s ease-out infinite;
    }
    
    @keyframes safetyRingDanger {
      0% { width: 48px; height: 48px; opacity: 0.6; }
      100% { width: 120px; height: 120px; opacity: 0; }
    }
    
    .safety-icon {
      width: 48px;
      height: 48px;
      background: linear-gradient(145deg, #32D74B, #28a745);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      box-shadow: 0 0 20px rgba(50,215,75,0.3);
      position: relative;
      z-index: 1;
      animation: safetyIconPulse 3s ease-in-out infinite;
    }
    
    @keyframes safetyIconPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(50,215,75,0.3); }
      50% { transform: scale(1.05); box-shadow: 0 0 30px rgba(50,215,75,0.5); }
    }
    
    .safety.danger .safety-icon {
      background: linear-gradient(145deg, #FF375F, #c41e3a);
      box-shadow: 0 0 20px rgba(255,55,95,0.4);
      animation: dangerIconPulse 1s ease-in-out infinite;
    }
    
    @keyframes dangerIconPulse {
      0%, 100% { transform: scale(1); box-shadow: 0 0 20px rgba(255,55,95,0.4); }
      50% { transform: scale(1.1); box-shadow: 0 0 40px rgba(255,55,95,0.6); }
    }
    
    .safety-title { font-size: 16px; font-weight: 700; }
    .safety-sub { font-size: 12px; color: #8E8E93; margin-top: 2px; }
    
    .safety-badge {
      display: inline-block;
      margin-top: 4px;
      padding: 4px 8px;
      background: rgba(50,215,75,0.15);
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
      color: #32D74B;
    }
    
    .safety.danger .safety-badge {
      background: rgba(255,55,95,0.15);
      color: #FF375F;
    }
    
    /* KIDNAPPING ALERT BANNER - More Prominent */
    .kidnap-alert-banner {
      background: linear-gradient(135deg, rgba(255,55,95,0.3), rgba(255,55,95,0.1));
      border: 2px solid rgba(255,55,95,0.5);
      border-radius: 16px;
      padding: 14px 16px;
      margin: 0 20px 16px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: pulse-kidnap 2s infinite;
      cursor: pointer;
      /* Swipe to dismiss */
      transition: transform 0.3s ease, opacity 0.3s ease;
      position: relative;
      touch-action: pan-x;
    }
    
    .kidnap-alert-banner.swiping {
      animation: none;
      transition: none;
    }
    
    .kidnap-alert-banner.dismissed {
      transform: translateX(120%);
      opacity: 0;
      pointer-events: none;
    }
    
    .kidnap-alert-banner.dismissed-left {
      transform: translateX(-120%);
      opacity: 0;
      pointer-events: none;
    }
    
    .kidnap-alert-banner.hiding {
      height: 0;
      margin: 0;
      padding: 0;
      border: none;
      overflow: hidden;
    }
    
    /* Swipe hint indicator */
    .swipe-hint {
      position: absolute;
      right: -40px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 20px;
      opacity: 0;
      transition: opacity 0.2s, right 0.2s;
    }
    
    .swipe-hint.left {
      right: auto;
      left: -40px;
    }
    
    .kidnap-alert-banner.swiping .swipe-hint {
      opacity: 0.8;
    }
    
    @keyframes pulse-kidnap {
      0%, 100% { box-shadow: 0 0 0 0 rgba(255,55,95,0.4); }
      50% { box-shadow: 0 0 20px 5px rgba(255,55,95,0.3); }
    }
    
    .kidnap-alert-icon {
      width: 44px;
      height: 44px;
      background: #FF375F;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
      animation: shake 0.5s infinite;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-2px); }
      75% { transform: translateX(2px); }
    }
    
    .kidnap-alert-content { flex: 1; }
    .kidnap-alert-title { 
      font-size: 14px; 
      font-weight: 700; 
      color: #FF375F;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    .kidnap-alert-sub { font-size: 12px; color: #ccc; margin-top: 2px; }
    .kidnap-alert-count {
      background: #FF375F;
      color: #fff;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 700;
    }
    
    /* SOS Button */
    .sos-wrap {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 12px 0 20px;
    }
    
    .sos-outer {
      position: relative;
      width: 180px;
      height: 180px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* Multi-ring SOS system */
    .sos-ring {
      position: absolute;
      width: 100%;
      height: 100%;
      border: 2px dashed rgba(255,55,95,0.2);
      border-radius: 50%;
      animation: spin 20s linear infinite;
    }
    
    .sos-ring-2 {
      position: absolute;
      width: 90%;
      height: 90%;
      border: 1px solid rgba(255,55,95,0.1);
      border-radius: 50%;
      animation: spin 15s linear infinite reverse;
    }
    
    .sos-ring-3 {
      position: absolute;
      width: 115%;
      height: 115%;
      border: 1px dotted rgba(255,55,95,0.15);
      border-radius: 50%;
      animation: spin 25s linear infinite;
    }
    
    /* Pulse rings on hold */
    .sos-pulse-ring {
      position: absolute;
      width: 150px;
      height: 150px;
      border-radius: 50%;
      border: 3px solid rgba(255,55,95,0.5);
      opacity: 0;
      transform: scale(1);
      pointer-events: none;
    }
    
    .sos-outer.holding .sos-pulse-ring {
      animation: sosPulseRing 1s ease-out infinite;
    }
    
    .sos-outer.holding .sos-pulse-ring:nth-child(2) {
      animation-delay: 0.3s;
    }
    
    .sos-outer.holding .sos-pulse-ring:nth-child(3) {
      animation-delay: 0.6s;
    }
    
    @keyframes sosPulseRing {
      0% { opacity: 0.6; transform: scale(1); }
      100% { opacity: 0; transform: scale(1.8); }
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    #sosBtn {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      background: linear-gradient(145deg, #FF375F, #c41e3a, #9b1b30);
      border: none;
      color: white;
      cursor: pointer;
      box-shadow: 
        0 10px 40px rgba(255,55,95,0.4),
        inset 0 -5px 20px rgba(0,0,0,0.2),
        inset 0 5px 20px rgba(255,255,255,0.1);
      transition: all 0.2s var(--spring-smooth);
      -webkit-user-select: none;
      user-select: none;
      touch-action: none;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2;
    }
    
    #sosBtn::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.25), transparent);
      animation: shimmer 3s infinite;
    }
    
    /* Inner glow effect */
    #sosBtn::after {
      content: '';
      position: absolute;
      top: 10%;
      left: 10%;
      width: 30%;
      height: 30%;
      background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
    }
    
    @keyframes shimmer { 0% { left: -100%; } 100% { left: 100%; } }
    
    .sos-count {
      font-size: 40px;
      font-weight: 800;
      line-height: 1;
      position: relative;
      z-index: 1;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .sos-label {
      display: block;
      font-size: 10px;
      font-weight: 500;
      margin-top: 6px;
      position: relative;
      z-index: 1;
      opacity: 0.9;
      letter-spacing: 0.5px;
    }
    
    #sosBtn.holding {
      transform: scale(0.92);
      box-shadow: 
        0 5px 30px rgba(255,55,95,0.7),
        inset 0 -5px 20px rgba(0,0,0,0.3),
        inset 0 5px 20px rgba(255,255,255,0.15);
    }
    
    #sosBtn.holding .sos-count {
      font-size: 56px;
      animation: pulse-count 0.5s infinite;
    }
    
    @keyframes pulse-count {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    
    /* Triggered state */
    #sosBtn.triggered {
      animation: sosTriggered 0.8s ease-in-out infinite;
    }
    
    @keyframes sosTriggered {
      0%, 100% { 
        box-shadow: 0 0 30px rgba(255,55,95,0.5);
        transform: scale(1);
      }
      50% { 
        box-shadow: 0 0 60px rgba(255,55,95,0.8);
        transform: scale(1.03);
      }
    }
    
    /* End Emergency Button */
    .end-emergency-btn {
      width: 100%;
      max-width: 260px;
      margin: 16px auto 0;
      padding: 14px 20px;
      background: linear-gradient(135deg, #32D74B, #28a745);
      border: none;
      border-radius: 30px;
      color: #fff;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      box-shadow: 0 8px 30px rgba(50,215,75,0.4);
      animation: pulse-safe 1.5s infinite;
      transition: all 0.2s var(--spring-bounce);
    }
    
    .end-emergency-btn:active {
      transform: scale(0.97);
    }
    
    @keyframes pulse-safe {
      0%, 100% { box-shadow: 0 8px 30px rgba(50,215,75,0.3); }
      50% { box-shadow: 0 8px 50px rgba(50,215,75,0.6); }
    }

    /* Quick Actions */
    .quick-actions {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      padding: 0 20px;
      margin-bottom: 20px;
    }
    
    .quick-action {
      background: var(--color-card);
      border-radius: 14px;
      padding: 12px 6px;
      text-align: center;
      border: 1px solid var(--color-card-border);
      cursor: pointer;
      transition: all 0.25s var(--spring-bounce);
      position: relative;
      overflow: hidden;
    }
    
    .quick-action::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(180deg, rgba(255,255,255,0.05) 0%, transparent 100%);
      opacity: 0;
      transition: opacity 0.3s;
    }
    
    .quick-action:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.4);
      border-color: rgba(255,255,255,0.1);
    }
    
    .quick-action:hover::before {
      opacity: 1;
    }
    
    .quick-action:active {
      transform: scale(0.95) translateY(0);
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    
    .quick-action-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin: 0 auto 6px;
      transition: transform 0.3s var(--spring-bounce);
    }
    
    .quick-action:hover .quick-action-icon {
      transform: scale(1.1);
    }
    
    .quick-action-label {
      font-size: 10px;
      color: var(--color-text-secondary);
      font-weight: 500;
      transition: color 0.3s;
    }
    
    .quick-action:hover .quick-action-label {
      color: #fff;
    }
    
    /* Section Header */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin: 16px 20px 10px;
    }
    
    .section-title {
      color: #8E8E93;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 600;
    }
    
    .section-action {
      color: #64D2FF;
      font-size: 13px;
      cursor: pointer;
    }
    
    /* Contacts */
    .contact {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #1C1C1E;
      border-radius: 14px;
      padding: 12px 14px;
      margin: 0 20px 8px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    
    .contact-avatar {
      position: relative;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
    }
    
    .contact-status {
      position: absolute;
      bottom: 0;
      right: 0;
      width: 10px;
      height: 10px;
      background: #32D74B;
      border: 2px solid #1C1C1E;
      border-radius: 50%;
    }
    
    .contact-info { flex: 1; }
    .contact-name { font-weight: 600; font-size: 14px; }
    .contact-type { font-size: 11px; color: #8E8E93; margin-top: 1px; }
    
    .contact-call {
      width: 36px;
      height: 36px;
      background: rgba(50,215,75,0.15);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      cursor: pointer;
    }
    
    /* Footer */
    .footer {
      text-align: center;
      padding: 20px;
    }
    
    .footer-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: #1C1C1E;
      border-radius: 16px;
      font-size: 10px;
      color: #8E8E93;
    }
    
    /* Bottom Navigation */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-width: 430px;
      margin: 0 auto;
      background: rgba(28, 28, 30, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.08);
      display: flex;
      justify-content: space-around;
      padding: 10px 0 28px;
      z-index: 50;
    }
    
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 8px 16px;
      color: var(--color-text-tertiary);
      text-decoration: none;
      font-size: 10px;
      font-weight: 500;
      transition: all 0.25s var(--spring-smooth);
      cursor: pointer;
      position: relative;
    }
    
    .nav-item.active {
      color: var(--color-danger);
    }
    
    /* Indicator pill for active nav item */
    .nav-item::before {
      content: '';
      position: absolute;
      top: -10px;
      left: 50%;
      transform: translateX(-50%) scaleX(0);
      width: 24px;
      height: 3px;
      background: var(--color-danger);
      border-radius: 2px;
      transition: transform 0.3s var(--spring-bounce);
    }
    
    .nav-item.active::before {
      transform: translateX(-50%) scaleX(1);
    }
    
    .nav-icon {
      font-size: 22px;
      line-height: 1;
      transition: transform 0.25s var(--spring-bounce);
    }
    
    .nav-item.active .nav-icon {
      transform: scale(1.1);
    }
    
    .nav-item:hover:not(.active) {
      color: var(--color-text-secondary);
    }
    
    .nav-item:hover .nav-icon {
      transform: scale(1.05);
    }
    
    /* Modal */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 100;
      padding: 20px;
      opacity: 0;
    }
    
    .modal.show { 
      display: flex;
      animation: modalFadeIn 0.3s ease forwards;
    }
    
    @keyframes modalFadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    .modal-box {
      background: var(--color-card);
      border-radius: 24px;
      padding: 28px 20px;
      max-width: 320px;
      width: 100%;
      text-align: center;
      border: 1px solid rgba(255,55,95,0.2);
      transform: scale(0.8) translateY(20px);
      opacity: 0;
      animation: modalBounceIn 0.4s var(--spring-bounce) 0.1s forwards;
    }
    
    @keyframes modalBounceIn {
      0% { transform: scale(0.8) translateY(20px); opacity: 0; }
      60% { transform: scale(1.02) translateY(-5px); opacity: 1; }
      100% { transform: scale(1) translateY(0); opacity: 1; }
    }
    
    .modal-icon { 
      font-size: 56px; 
      margin-bottom: 14px;
      animation: iconPop 0.5s var(--spring-bounce) 0.3s both;
    }
    
    @keyframes iconPop {
      0% { transform: scale(0); }
      60% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
    
    .modal-title { font-size: 20px; font-weight: 700; margin-bottom: 10px; }
    .modal-text { color: var(--color-text-secondary); font-size: 14px; margin-bottom: 16px; line-height: 1.5; }
    
    .countdown {
      font-size: 72px;
      font-weight: 800;
      color: var(--color-danger);
      text-shadow: 0 0 40px var(--color-danger-glow);
      margin-bottom: 20px;
      animation: pulse-count 0.5s infinite;
    }
    
    .modal-btn {
      flex: 1;
      padding: 14px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 700;
      border: none;
      cursor: pointer;
      transition: all 0.2s var(--spring-bounce);
    }
    
    .modal-btn:active {
      transform: scale(0.97);
    }
    
    .modal-btn.cancel { background: var(--color-divider); color: #fff; }
    .modal-btn.send { background: var(--color-danger); color: #fff; }
    .modal-btn.done { 
      background: var(--color-safe); 
      color: #fff; 
      width: 100%; 
      margin-top: 16px;
      box-shadow: 0 4px 20px rgba(50,215,75,0.3);
    }
    .modal-btn.end-emergency { 
      background: transparent; 
      border: 2px solid var(--color-info); 
      color: var(--color-info); 
      width: 100%; 
      margin-top: 10px; 
    }
    
    .modal-btn.end-emergency:hover {
      background: rgba(100,210,255,0.1);
    }
    
    .sent {
      background: rgba(50,215,75,0.1);
      border: 1px solid rgba(50,215,75,0.3);
      border-radius: 12px;
      padding: 12px;
      margin-bottom: 8px;
      text-align: left;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: sentSlideIn 0.4s var(--spring-smooth) both;
    }
    
    .sent:nth-child(1) { animation-delay: 0.2s; }
    .sent:nth-child(2) { animation-delay: 0.3s; }
    .sent:nth-child(3) { animation-delay: 0.4s; }
    
    @keyframes sentSlideIn {
      from { transform: translateX(-20px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    .sent-icon { font-size: 20px; }
    .sent-name { font-weight: 600; font-size: 14px; }
    .sent-status { font-size: 11px; color: var(--color-safe); }
</style>
</head>
<style>
    /* =============================================
       MAP SCREEN STYLES
       ============================================= */
    .map-container {
      position: relative;
      width: 100%;
      height: 100vh;
      background: #0a0a0a;
      overflow: hidden;
      touch-action: none;
    }
    
    .map-svg {
      width: 100%;
      height: 100%;
      cursor: grab;
      transition: transform 0.1s ease-out;
    }
    
    .map-svg:active {
      cursor: grabbing;
    }
    
    .map-svg.animating {
      transition: transform 0.4s ease-out;
    }
    
    .map-header {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
      padding: 14px 20px;
      background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
    }
    
    .map-search {
      position: absolute;
      top: 60px;
      left: 16px;
      right: 70px;
      z-index: 15;
    }
    
    .search-input-wrap {
      display: flex;
      align-items: center;
      gap: 10px;
      background: rgba(28,28,30,0.95);
      backdrop-filter: blur(20px);
      border-radius: 14px;
      padding: 12px 16px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .search-input-wrap input {
      flex: 1;
      background: none;
      border: none;
      color: #fff;
      font-size: 16px;
      outline: none;
    }
    
    .search-input-wrap input::placeholder {
      color: #636366;
    }
    
    .search-clear {
      color: #636366;
      cursor: pointer;
      font-size: 14px;
      display: none;
    }
    
    .search-suggestions {
      display: none;
      background: rgba(28,28,30,0.98);
      backdrop-filter: blur(20px);
      border-radius: 14px;
      margin-top: 8px;
      border: 1px solid rgba(255,255,255,0.1);
      overflow: hidden;
    }
    
    .search-suggestions.show {
      display: block;
    }
    
    .suggestion-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      cursor: pointer;
    }
    
    .suggestion-item:last-child {
      border-bottom: none;
    }
    
    .suggestion-name { font-weight: 600; font-size: 15px; }
    .suggestion-desc { font-size: 12px; color: #8E8E93; }
    
    .map-road {
      stroke: #2C2C2E;
      stroke-width: 3;
      fill: none;
    }
    
    .map-road-main {
      stroke: #3a3a3c;
      stroke-width: 5;
    }
    
    .map-area {
      fill: #1C1C1E;
      stroke: #2C2C2E;
      stroke-width: 1;
      cursor: pointer;
      transition: fill 0.2s;
    }
    
    .map-area:hover {
      fill: #252528;
    }
    
    .route-path-glow {
      stroke: rgba(100,210,255,0.2);
      stroke-width: 20;
      fill: none;
      stroke-linecap: round;
    }
    
    .alert-marker {
      cursor: pointer;
      transition: transform 0.2s;
    }
    
    .alert-marker:hover {
      transform: scale(1.15);
    }
    
    .marker-pulse {
      animation: marker-pulse 2s infinite;
    }
    
    @keyframes marker-pulse {
      0%, 100% { r: 20; opacity: 0.3; }
      50% { r: 28; opacity: 0; }
    }
    
    .user-location {
      filter: drop-shadow(0 0 10px rgba(100,210,255,0.5));
    }
    
    .user-pulse {
      animation: user-pulse 2s infinite;
    }
    
    @keyframes user-pulse {
      0%, 100% { r: 20; opacity: 0.3; }
      50% { r: 30; opacity: 0; }
    }
    
    .map-controls {
      position: absolute;
      right: 16px;
      top: 60px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 20;
    }
    
    .map-btn {
      width: 44px;
      height: 44px;
      background: rgba(28,28,30,0.95);
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      backdrop-filter: blur(10px);
    }
    
    .map-btn:active {
      transform: scale(0.95);
      background: rgba(50,50,52,0.95);
    }
    
    .map-btn.active {
      background: rgba(100,210,255,0.2);
      border-color: rgba(100,210,255,0.4);
    }
    
    .zoom-indicator {
      position: absolute;
      top: 120px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(28,28,30,0.9);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
      opacity: 0;
      transition: opacity 0.3s;
      z-index: 15;
    }
    
    .zoom-indicator.show {
      opacity: 1;
    }
    
    .map-legend {
      position: absolute;
      left: 16px;
      bottom: 280px;
      background: rgba(28,28,30,0.95);
      backdrop-filter: blur(20px);
      border-radius: 14px;
      padding: 14px 16px;
      font-size: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 10;
    }
    
    .legend-title {
      font-weight: 600;
      margin-bottom: 10px;
      color: #8E8E93;
      font-size: 11px;
      text-transform: uppercase;
    }
    
    .legend-item {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 8px;
    }
    
    .legend-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
    }
    
    .marker-popup {
      position: absolute;
      bottom: 280px;
      left: 16px;
      right: 16px;
      background: rgba(28,28,30,0.98);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 25;
      display: none;
      animation: slideUp 0.3s ease;
    }
    
    .marker-popup.show {
      display: block;
    }
    
    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    
    .popup-close {
      position: absolute;
      top: 16px;
      right: 16px;
      width: 28px;
      height: 28px;
      background: #2C2C2E;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      color: #8E8E93;
    }
    
    .popup-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 12px;
    }
    
    .popup-badge.danger { background: rgba(255,55,95,0.15); color: #FF375F; }
    .popup-badge.warning { background: rgba(255,159,10,0.15); color: #FF9F0A; }
    .popup-badge.safe { background: rgba(50,215,75,0.15); color: #32D74B; }
    
    .popup-title { font-size: 20px; font-weight: 700; margin-bottom: 8px; }
    .popup-location { font-size: 14px; color: #8E8E93; margin-bottom: 4px; }
    .popup-time { font-size: 12px; color: #636366; margin-bottom: 12px; }
    .popup-desc { font-size: 15px; line-height: 1.5; margin-bottom: 16px; }
    
    .popup-actions { display: flex; gap: 10px; }
    
    .popup-btn {
      flex: 1;
      padding: 14px;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      background: #64D2FF;
      color: #000;
    }
    
    .popup-btn.secondary {
      background: #2C2C2E;
      color: #fff;
    }
    
    /* Trip Panels - Collapsible Design */
    .trip-panel, .start-trip-panel {
      position: absolute;
      bottom: 90px;
      left: 16px;
      right: 16px;
      background: rgba(28,28,30,0.98);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      border: 1px solid rgba(255,255,255,0.1);
      z-index: 20;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 70vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }
    
    /* Collapsed state - just shows header */
    .trip-panel.collapsed, .start-trip-panel.collapsed {
      max-height: 70px;
      padding: 0;
    }
    
    .trip-panel.hidden, .start-trip-panel.hidden {
      display: none;
    }
    
    /* Collapse handle */
    .panel-collapse-handle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      cursor: pointer;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    
    .panel-collapse-handle:active {
      background: rgba(255,255,255,0.03);
    }
    
    .panel-handle-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .panel-handle-icon {
      font-size: 20px;
    }
    
    .panel-handle-title {
      font-size: 16px;
      font-weight: 700;
    }
    
    .panel-handle-subtitle {
      font-size: 12px;
      color: #8E8E93;
    }
    
    .panel-collapse-arrow {
      font-size: 18px;
      color: #8E8E93;
      transition: transform 0.3s ease;
    }
    
    .collapsed .panel-collapse-arrow {
      transform: rotate(180deg);
    }
    
    .panel-content {
      padding: 16px 20px;
      flex: 1;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
    }
    
    /* Always visible footer with button at bottom */
    .panel-footer {
      padding: 12px 20px 16px;
      border-top: 1px solid rgba(255,255,255,0.06);
      background: rgba(28,28,30,0.98);
      flex-shrink: 0;
    }
    
    .collapsed .panel-content,
    .collapsed .panel-footer {
      display: none;
    }
    
    /* AI Safety Badge on Trip */
    .ai-safety-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      margin-left: auto;
    }
    
    .ai-safety-badge.safe {
      background: rgba(50,215,75,0.15);
      color: #32D74B;
    }
    
    .ai-safety-badge.caution {
      background: rgba(255,159,10,0.15);
      color: #FF9F0A;
    }
    
    .ai-safety-badge.danger {
      background: rgba(255,55,95,0.15);
      color: #FF375F;
    }
    
    .ai-safety-badge.analyzing {
      background: rgba(191,90,242,0.15);
      color: #BF5AF2;
    }
    
    /* AI Route Analysis Card */
    .ai-route-analysis {
      background: linear-gradient(135deg, rgba(191,90,242,0.1), rgba(100,210,255,0.05));
      border: 1px solid rgba(191,90,242,0.2);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 16px;
    }
    
    .ai-route-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .ai-route-icon {
      font-size: 20px;
    }
    
    .ai-route-title {
      font-size: 13px;
      font-weight: 600;
      color: #BF5AF2;
    }
    
    .ai-route-body {
      font-size: 13px;
      color: #ccc;
      line-height: 1.5;
    }
    
    .ai-route-tips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 10px;
    }
    
    .ai-tip {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 10px;
      background: rgba(0,0,0,0.3);
      border-radius: 8px;
      font-size: 11px;
      color: #8E8E93;
    }
    
    .start-trip-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 16px;
      text-align: center;
    }
    
    /* AI Destination Search */
    .destination-input {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #1C1C1E;
      border-radius: 14px;
      padding: 14px 16px;
      margin-bottom: 12px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .destination-input input {
      flex: 1;
      background: none;
      border: none;
      color: #fff;
      font-size: 16px;
      outline: none;
    }
    
    .dest-voice-btn {
      width: 36px;
      height: 36px;
      background: linear-gradient(145deg, #BF5AF2, #9945D6);
      border: none;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      cursor: pointer;
    }
    
    .dest-voice-btn.listening {
      animation: aiPulse 0.5s ease-in-out infinite;
    }
    
    .recent-destinations { margin-bottom: 16px; }
    
    .recent-title {
      font-size: 12px;
      color: #8E8E93;
      margin-bottom: 10px;
      text-transform: uppercase;
    }
    
    .recent-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: #1C1C1E;
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
    }
    
    .recent-icon { font-size: 20px; }
    .recent-name { font-weight: 600; font-size: 15px; }
    .recent-address { font-size: 12px; color: #8E8E93; }
    .recent-distance { font-size: 13px; color: #64D2FF; font-weight: 600; }
    
    .start-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #64D2FF, #4AB8E8);
      border: none;
      border-radius: 14px;
      color: #000;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .trip-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .trip-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #32D74B;
      font-weight: 600;
    }
    
    .trip-status-dot {
      width: 8px;
      height: 8px;
      background: #32D74B;
      border-radius: 50%;
      animation: blink 1s infinite;
    }
    
    @keyframes blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }
    
    .trip-share { font-size: 13px; color: #64D2FF; cursor: pointer; }
    
    .trip-destination {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 16px;
    }
    
    .trip-icon {
      width: 48px;
      height: 48px;
      background: rgba(50,215,75,0.15);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .trip-info { flex: 1; }
    .trip-label { font-size: 12px; color: #8E8E93; }
    .trip-place { font-size: 18px; font-weight: 700; }
    
    .trip-progress-ring {
      position: relative;
      width: 50px;
      height: 50px;
    }
    
    .trip-progress-ring span {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 11px;
      font-weight: 700;
      color: #64D2FF;
    }
    
    .trip-stats {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
    }
    
    .trip-stat {
      flex: 1;
      background: #1C1C1E;
      border-radius: 14px;
      padding: 14px 12px;
      text-align: center;
    }
    
    .trip-stat-value { font-size: 24px; font-weight: 700; color: #64D2FF; }
    .trip-stat-label { font-size: 11px; color: #8E8E93; margin-top: 4px; }
    
    .trip-watchers-list {
      display: flex;
      gap: 16px;
      margin-bottom: 16px;
      padding: 12px;
      background: #1C1C1E;
      border-radius: 14px;
    }
    
    .watcher {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    
    .watcher-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: 700;
    }
    
    .watcher span { font-size: 11px; color: #8E8E93; }
    
    .trip-actions { display: flex; gap: 12px; }
    
    .trip-btn {
      flex: 1;
      padding: 14px;
      border-radius: 14px;
      font-size: 15px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }
    
    .trip-btn.primary { background: #64D2FF; color: #000; }
    .trip-btn.secondary { background: #2C2C2E; color: #fff; }
    .trip-btn.danger { background: rgba(255,55,95,0.15); color: #FF375F; }
    
    .toast {
      position: absolute;
      top: 120px;
      left: 50%;
      transform: translateX(-50%) translateY(-20px);
      background: rgba(50,215,75,0.95);
      color: #000;
      padding: 12px 24px;
      border-radius: 30px;
      font-size: 14px;
      font-weight: 600;
      opacity: 0;
      transition: all 0.3s;
      z-index: 30;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }
    
    /* =============================================
       HUB SCREEN STYLES
       ============================================= */
    .page-title {
      font-size: 26px;
      font-weight: 700;
      padding: 0 20px;
      margin-bottom: 16px;
    }
    
    .page-title-sticky {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      max-width: 430px;
      margin: 0 auto;
      z-index: 100;
      background: rgba(0, 0, 0, 0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      padding: 16px 20px;
      font-size: 28px;
      font-weight: 700;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
    }
    
    .page-content-sticky {
      padding-top: 70px;
      padding-left: 20px;
      padding-right: 20px;
      position: relative;
      z-index: 1;
    }
    
    .hub-tabs {
      display: flex;
      background: #1C1C1E;
      border-radius: 12px;
      padding: 4px;
      margin: 0 0 16px;
    }
    
    .hub-tab {
      flex: 1;
      padding: 12px;
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      color: #8E8E93;
      border-radius: 10px;
      cursor: pointer;
    }
    
    .hub-tab.active {
      background: #2C2C2E;
      color: #fff;
    }
    
    .hub-content { display: none; padding: 0 20px; }
    .hub-content.active { display: block; }
    
    .region-filter {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 12px;
      margin-bottom: 12px;
      -webkit-overflow-scrolling: touch;
    }
    
    .region-filter::-webkit-scrollbar { display: none; }
    
    .region-pill {
      flex-shrink: 0;
      padding: 8px 14px;
      background: #1C1C1E;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      color: #8E8E93;
      border: 1px solid transparent;
      cursor: pointer;
    }
    
    .region-pill.active {
      background: rgba(255,55,95,0.15);
      color: #FF375F;
      border-color: rgba(255,55,95,0.3);
    }
    
    .alert-card {
      background: #1C1C1E;
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 10px;
      border: 1px solid rgba(255,255,255,0.06);
    }
    
    .alert-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
    }
    
    .alert-badge {
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
    }
    
    .alert-badge.danger { background: rgba(255,55,95,0.15); color: #FF375F; }
    .alert-badge.warning { background: rgba(255,159,10,0.15); color: #FF9F0A; }
    .alert-badge.kidnap { 
      background: rgba(255,55,95,0.25); 
      color: #FF375F; 
      animation: pulse-badge 1s infinite;
    }
    
    @keyframes pulse-badge {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .alert-region { font-size: 12px; color: #8E8E93; }
    .alert-time { font-size: 11px; color: #636366; margin-left: auto; }
    .alert-content { font-size: 14px; line-height: 1.5; margin-bottom: 10px; }
    .alert-location { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #8E8E93; }
    
    .history-stats {
      display: flex;
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .history-stat {
      flex: 1;
      background: #1C1C1E;
      border-radius: 14px;
      padding: 14px;
      text-align: center;
    }
    
    .history-stat-value { font-size: 26px; font-weight: 700; }
    .history-stat-value.green { color: #32D74B; }
    .history-stat-value.orange { color: #FF9F0A; }
    .history-stat-value.blue { color: #64D2FF; }
    .history-stat-label { font-size: 10px; color: #8E8E93; margin-top: 4px; }
    
    .history-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #1C1C1E;
      border-radius: 14px;
      padding: 12px;
      margin-bottom: 8px;
    }
    
    .history-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .history-icon.sos { background: rgba(255,55,95,0.15); }
    .history-icon.trip { background: rgba(100,210,255,0.15); }
    .history-icon.timer { background: rgba(255,159,10,0.15); }
    .history-icon.report { background: rgba(50,215,75,0.15); }
    
    .history-info { flex: 1; }
    .history-title { font-weight: 600; font-size: 14px; }
    .history-meta { font-size: 11px; color: #8E8E93; margin-top: 2px; }
    
    .history-outcome {
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 600;
    }
    
    .history-outcome.resolved { background: rgba(50,215,75,0.15); color: #32D74B; }
    .history-outcome.cancelled { background: rgba(142,142,147,0.15); color: #8E8E93; }
</style>
<style>
    /* =============================================
       CHECK-IN TIMER STYLES
       ============================================= */
    .screen-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      margin-bottom: 8px;
    }
    
    .back-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #64D2FF;
      font-size: 16px;
      cursor: pointer;
      padding: 8px 0;
    }
    
    .back-btn span:first-child {
      font-size: 22px;
      font-weight: 300;
    }
    
    .checkin-intro {
      text-align: center;
      padding: 20px 16px;
      background: linear-gradient(135deg, rgba(255,159,10,0.1), rgba(255,159,10,0.02));
      border: 1px solid rgba(255,159,10,0.2);
      border-radius: 18px;
      margin: 0 20px 20px;
    }
    
    .checkin-intro-icon { font-size: 44px; margin-bottom: 10px; }
    .checkin-intro p { color: #8E8E93; font-size: 13px; line-height: 1.5; }
    
    .duration-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 8px;
      padding: 0 20px;
      margin-bottom: 12px;
    }
    
    .duration-option {
      background: #1C1C1E;
      border: 2px solid transparent;
      border-radius: 14px;
      padding: 14px 6px;
      text-align: center;
      cursor: pointer;
    }
    
    .duration-option.selected {
      background: rgba(255,159,10,0.15);
      border-color: #FF9F0A;
    }
    
    .duration-value { display: block; font-size: 26px; font-weight: 700; }
    .duration-option.selected .duration-value { color: #FF9F0A; }
    .duration-unit { display: block; font-size: 11px; color: #8E8E93; margin-top: 2px; }
    
    .custom-duration {
      display: flex;
      align-items: center;
      gap: 10px;
      background: #1C1C1E;
      border-radius: 12px;
      padding: 10px 14px;
      margin: 0 20px 20px;
      font-size: 13px;
      color: #8E8E93;
    }
    
    .custom-duration input {
      width: 50px;
      background: #2C2C2E;
      border: none;
      border-radius: 8px;
      padding: 8px 10px;
      color: #fff;
      font-size: 15px;
      text-align: center;
      outline: none;
    }
    
    .custom-set-btn {
      margin-left: auto;
      background: #2C2C2E;
      border: none;
      border-radius: 8px;
      padding: 8px 14px;
      color: #64D2FF;
      font-weight: 600;
      cursor: pointer;
    }
    
    .reason-chips {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      padding: 0 20px;
      margin-bottom: 10px;
    }
    
    .reason-chip {
      background: #1C1C1E;
      border: 1px solid transparent;
      border-radius: 18px;
      padding: 8px 14px;
      font-size: 12px;
      cursor: pointer;
    }
    
    .reason-chip.selected {
      background: rgba(100,210,255,0.15);
      border-color: rgba(100,210,255,0.3);
      color: #64D2FF;
    }
    
    .reason-input-wrap {
      padding: 0 20px;
      margin-bottom: 20px;
    }
    
    .reason-input-wrap input {
      width: 100%;
      background: #1C1C1E;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      padding: 12px 14px;
      color: #fff;
      font-size: 14px;
      outline: none;
    }
    
    .notify-contacts {
      display: flex;
      gap: 16px;
      padding: 14px;
      background: #1C1C1E;
      border-radius: 14px;
      margin: 0 20px 20px;
    }
    
    .notify-contact {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
    }
    
    .notify-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      font-weight: 700;
    }
    
    .notify-contact span { font-size: 11px; color: #8E8E93; }
    
    .checkin-start-btn {
      width: calc(100% - 40px);
      margin: 0 20px;
      padding: 16px;
      background: linear-gradient(135deg, #FF9F0A, #e08900);
      border: none;
      border-radius: 14px;
      color: #000;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
    }
    
    .timer-display {
      display: flex;
      justify-content: center;
      padding: 16px 0 24px;
    }
    
    .timer-ring {
      position: relative;
      width: 200px;
      height: 200px;
    }
    
    .timer-ring svg { transform: scaleX(-1); }
    
    .timer-center {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
    }
    
    .timer-time {
      font-size: 44px;
      font-weight: 700;
      color: #FF9F0A;
      font-variant-numeric: tabular-nums;
    }
    
    .timer-label { font-size: 13px; color: #8E8E93; }
    
    .timer-reason {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px 18px;
      background: #1C1C1E;
      border-radius: 24px;
      margin: 0 auto 16px;
      width: fit-content;
      font-size: 14px;
    }
    
    .timer-warning {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      background: rgba(255,159,10,0.1);
      border: 1px solid rgba(255,159,10,0.2);
      border-radius: 12px;
      margin: 0 20px 20px;
      font-size: 12px;
      color: #FF9F0A;
    }
    
    .checkin-confirm-btn {
      width: calc(100% - 40px);
      margin: 0 20px 14px;
      padding: 18px;
      background: linear-gradient(135deg, #32D74B, #28a745);
      border: none;
      border-radius: 14px;
      color: #fff;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 8px 30px rgba(50,215,75,0.3);
    }
    
    .checkin-confirm-btn.pulse {
      animation: pulse-btn 1s infinite;
    }
    
    @keyframes pulse-btn {
      0%, 100% { box-shadow: 0 8px 30px rgba(50,215,75,0.3); }
      50% { box-shadow: 0 8px 50px rgba(50,215,75,0.5); }
    }
    
    .timer-actions {
      display: flex;
      gap: 10px;
      padding: 0 20px;
    }
    
    .timer-action-btn {
      flex: 1;
      padding: 12px 8px;
      background: #1C1C1E;
      border: none;
      border-radius: 12px;
      color: #fff;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    
    .timer-action-btn span:first-child { font-size: 16px; font-weight: 700; color: #64D2FF; }
    .timer-action-btn.danger span:first-child { color: #FF375F; }
    
    .expired-display { text-align: center; padding: 30px 20px; }
    .expired-icon { font-size: 70px; margin-bottom: 16px; animation: shake 0.5s infinite; }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .expired-title { font-size: 26px; font-weight: 700; color: #FF375F; margin-bottom: 10px; }
    .expired-text { color: #8E8E93; font-size: 14px; line-height: 1.5; margin-bottom: 24px; }
    
    .expired-countdown {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px 20px;
      background: rgba(255,55,95,0.1);
      border: 1px solid rgba(255,55,95,0.3);
      border-radius: 14px;
      margin-bottom: 24px;
      font-size: 14px;
      color: #FF375F;
    }
    
    .expired-seconds { font-size: 28px; font-weight: 800; animation: pulse-count 0.5s infinite; }
    
    .checkin-safe-btn {
      width: 100%;
      padding: 18px;
      background: linear-gradient(135deg, #32D74B, #28a745);
      border: none;
      border-radius: 14px;
      color: #fff;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      animation: pulse-btn 0.8s infinite;
    }
    
    /* =============================================
       EVIDENCE RECORDER STYLES
       ============================================= */
    .stealth-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: #1C1C1E;
      border-radius: 18px;
      font-size: 12px;
      color: #8E8E93;
      cursor: pointer;
    }
    
    .stealth-toggle.active {
      background: rgba(50,215,75,0.15);
      color: #32D74B;
    }
    
    .recorder-intro {
      text-align: center;
      padding: 20px 16px;
      background: linear-gradient(135deg, rgba(255,55,95,0.1), rgba(255,55,95,0.02));
      border: 1px solid rgba(255,55,95,0.2);
      border-radius: 18px;
      margin: 0 20px 20px;
    }
    
    .recorder-intro-icon { font-size: 44px; margin-bottom: 10px; }
    .recorder-intro p { color: #8E8E93; font-size: 13px; line-height: 1.5; }
    
    .record-type-toggle {
      display: flex;
      background: #1C1C1E;
      border-radius: 12px;
      padding: 4px;
      margin: 0 20px 20px;
    }
    
    .record-type {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 600;
      color: #8E8E93;
      cursor: pointer;
    }
    
    .record-type.active {
      background: #2C2C2E;
      color: #FF375F;
    }
    
    .record-type span:first-child { font-size: 18px; }
    
    .quality-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 0 20px;
      margin-bottom: 20px;
    }
    
    .quality-option {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 14px;
      background: #1C1C1E;
      border: 2px solid transparent;
      border-radius: 12px;
      cursor: pointer;
    }
    
    .quality-option.selected {
      background: rgba(255,55,95,0.1);
      border-color: rgba(255,55,95,0.3);
    }
    
    .quality-name { font-weight: 600; font-size: 14px; }
    .quality-option.selected .quality-name { color: #FF375F; }
    .quality-desc { font-size: 11px; color: #636366; }
    
    .auto-settings {
      background: #1C1C1E;
      border-radius: 14px;
      overflow: hidden;
      margin: 0 20px 16px;
    }
    
    .auto-setting {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    
    .auto-setting:last-child { border-bottom: none; }
    
    .auto-setting-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    
    .auto-setting-icon { font-size: 22px; }
    .auto-setting-label { font-size: 14px; font-weight: 500; }
    .auto-setting-desc { font-size: 11px; color: #636366; margin-top: 2px; }
    
    .toggle-switch {
      position: relative;
      width: 48px;
      height: 28px;
    }
    
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      inset: 0;
      background: #39393D;
      border-radius: 28px;
      transition: 0.3s;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 24px;
      width: 24px;
      left: 2px;
      bottom: 2px;
      background: white;
      border-radius: 50%;
      transition: 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    
    .toggle-switch input:checked + .toggle-slider { background: #32D74B; }
    .toggle-switch input:checked + .toggle-slider:before { transform: translateX(20px); }
    
    .storage-info {
      background: #1C1C1E;
      border-radius: 12px;
      padding: 12px 14px;
      margin: 0 20px 16px;
    }
    
    .storage-bar {
      height: 6px;
      background: #2C2C2E;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }
    
    .storage-used {
      height: 100%;
      background: linear-gradient(90deg, #64D2FF, #32D74B);
      border-radius: 3px;
    }
    
    .storage-text {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: #8E8E93;
    }
    
    .record-start-btn {
      width: calc(100% - 40px);
      margin: 0 20px;
      padding: 16px;
      background: linear-gradient(135deg, #FF375F, #c41e3a);
      border: none;
      border-radius: 14px;
      color: #fff;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 8px 30px rgba(255,55,95,0.3);
    }
    
    .record-btn-icon { font-size: 22px; animation: pulse-rec 1.5s infinite; }
    
    @keyframes pulse-rec {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    .recordings-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      padding: 0 20px;
    }
    
    .recording-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      background: #1C1C1E;
      border-radius: 12px;
    }
    
    .recording-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .recording-icon.audio { background: rgba(255,55,95,0.15); }
    .recording-icon.video { background: rgba(100,210,255,0.15); }
    
    .recording-info { flex: 1; }
    .recording-name { font-weight: 600; font-size: 14px; }
    .recording-meta { font-size: 11px; color: #636366; margin-top: 2px; }
    .recording-status { font-size: 14px; }
    .recording-actions { display: flex; gap: 10px; font-size: 16px; }
    .recording-actions span { cursor: pointer; padding: 4px; }
    
    .recording-display { text-align: center; padding: 16px 0; }
    
    .recording-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 14px;
      background: rgba(255,55,95,0.15);
      border-radius: 18px;
      margin-bottom: 16px;
    }
    
    .rec-dot {
      width: 10px;
      height: 10px;
      background: #FF375F;
      border-radius: 50%;
      animation: blink 1s infinite;
    }
    
    .recording-indicator span {
      color: #FF375F;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    
    .recording-timer {
      font-size: 56px;
      font-weight: 700;
      color: #fff;
      font-variant-numeric: tabular-nums;
      margin-bottom: 20px;
    }
    
    .waveform-container {
      height: 80px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .waveform {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 3px;
      height: 70px;
    }
    
    .wave-bar {
      width: 5px;
      background: linear-gradient(to top, #FF375F, #FF6B8A);
      border-radius: 2px;
      animation: wave 0.5s ease-in-out infinite alternate;
    }
    
    @keyframes wave {
      0% { transform: scaleY(0.5); }
      100% { transform: scaleY(1.2); }
    }
    
    .waveform.paused .wave-bar {
      animation: none;
      transform: scaleY(0.3);
      opacity: 0.5;
    }
    
    .video-preview {
      height: 160px;
      background: #1C1C1E;
      border-radius: 14px;
      margin: 0 20px 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .video-placeholder {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      color: #636366;
    }
    
    .video-placeholder span:first-child { font-size: 40px; }
    
    .recording-meta-info {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-bottom: 16px;
    }
    
    .meta-item { text-align: center; }
    .meta-label { display: block; font-size: 10px; color: #636366; text-transform: uppercase; }
    .meta-value { display: block; font-size: 14px; font-weight: 600; margin-top: 4px; }
    
    .upload-status {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 14px;
      background: rgba(50,215,75,0.1);
      border-radius: 10px;
      margin: 0 20px 20px;
      font-size: 12px;
      color: #32D74B;
    }
    
    .upload-icon { font-size: 18px; }
    
    .upload-progress {
      flex: 1;
      height: 4px;
      background: rgba(50,215,75,0.2);
      border-radius: 2px;
      overflow: hidden;
      margin-left: auto;
      max-width: 70px;
    }
    
    .upload-progress-bar {
      height: 100%;
      background: #32D74B;
      border-radius: 2px;
      width: 0%;
      transition: width 0.3s;
    }
    
    .recording-controls {
      display: flex;
      justify-content: center;
      gap: 14px;
      margin-bottom: 16px;
      padding: 0 20px;
    }
    
    .rec-control-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 14px 20px;
      border: none;
      border-radius: 14px;
      font-size: 11px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .rec-control-btn span:first-child { font-size: 22px; }
    .rec-control-btn.pause { background: #2C2C2E; color: #fff; }
    .rec-control-btn.pause.active { background: rgba(255,159,10,0.15); color: #FF9F0A; }
    .rec-control-btn.stop { background: rgba(255,55,95,0.15); color: #FF375F; }
    .rec-control-btn.send { background: rgba(100,210,255,0.15); color: #64D2FF; }
    
    .rec-emergency-note {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      background: #1C1C1E;
      border-radius: 10px;
      margin: 0 20px;
      font-size: 11px;
      color: #8E8E93;
    }
    
    .complete-display { text-align: center; padding: 24px 20px; }
    .complete-icon { font-size: 56px; margin-bottom: 14px; }
    .complete-title { font-size: 22px; font-weight: 700; margin-bottom: 20px; }
    
    .complete-preview {
      display: flex;
      align-items: center;
      gap: 14px;
      padding: 14px;
      background: #1C1C1E;
      border-radius: 14px;
      margin-bottom: 16px;
    }
    
    .preview-icon {
      width: 50px;
      height: 50px;
      background: rgba(255,55,95,0.15);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .preview-info { flex: 1; text-align: left; }
    .preview-duration { font-size: 22px; font-weight: 700; }
    .preview-size { font-size: 12px; color: #8E8E93; }
    
    .preview-play {
      width: 44px;
      height: 44px;
      background: #32D74B;
      border: none;
      border-radius: 50%;
      font-size: 18px;
      cursor: pointer;
    }
    
    .complete-status {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-bottom: 20px;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 10px;
      background: #1C1C1E;
      border-radius: 10px;
      font-size: 13px;
      color: #8E8E93;
    }
    
    .status-item.success { background: rgba(50,215,75,0.1); color: #32D74B; }
    
    .complete-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
    }
    
    .complete-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .complete-btn.primary { background: #64D2FF; color: #000; }
    .complete-btn.secondary { background: #2C2C2E; color: #fff; }
    
    .complete-done-btn {
      width: 100%;
      padding: 14px;
      background: transparent;
      border: 1px solid #2C2C2E;
      border-radius: 12px;
      color: #8E8E93;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
</style>
<style>
    /* =============================================
       REPORT INCIDENT STYLES
       ============================================= */
    .emergency-hotlines {
      background: linear-gradient(135deg, rgba(255,55,95,0.15), rgba(255,55,95,0.05));
      border: 1px solid rgba(255,55,95,0.3);
      border-radius: 14px;
      padding: 12px 14px;
      margin: 0 20px 16px;
    }
    
    .hotline-header {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      font-weight: 600;
      color: #FF375F;
      margin-bottom: 10px;
    }
    
    .hotline-numbers { display: flex; gap: 10px; }
    
    .hotline-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      padding: 10px;
      background: rgba(255,55,95,0.2);
      border-radius: 10px;
      color: #fff;
      text-decoration: none;
      font-size: 14px;
      font-weight: 700;
    }
    
    .hotline-btn.nscdc { font-size: 11px; }
    
    .incident-types {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      padding: 0 20px;
      margin-bottom: 20px;
    }
    
    .incident-type {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px 6px;
      background: #1C1C1E;
      border: 2px solid transparent;
      border-radius: 14px;
      cursor: pointer;
    }
    
    .incident-type.selected {
      background: rgba(255,55,95,0.1);
      border-color: #FF375F;
    }
    
    .incident-type.urgent {
      background: linear-gradient(135deg, rgba(255,55,95,0.08), rgba(255,55,95,0.02));
      border: 1px solid rgba(255,55,95,0.2);
    }
    
    .incident-type.urgent .incident-label { color: #FF6B8A; }
    
    .incident-type.urgent.selected {
      background: rgba(255,55,95,0.15);
      border-color: #FF375F;
      box-shadow: 0 0 20px rgba(255,55,95,0.2);
    }
    
    .incident-icon { font-size: 24px; }
    .incident-label { font-size: 10px; font-weight: 600; text-align: center; color: #8E8E93; line-height: 1.2; }
    .incident-type.selected .incident-label { color: #FF375F; }
    
    .severity-options {
      display: flex;
      gap: 10px;
      padding: 0 20px;
      margin-bottom: 20px;
    }
    
    .severity-option {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      padding: 12px 8px;
      background: #1C1C1E;
      border: 2px solid transparent;
      border-radius: 12px;
      cursor: pointer;
      font-size: 12px;
      font-weight: 600;
    }
    
    .severity-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-bottom: 4px;
    }
    
    .severity-option.low .severity-dot { background: #32D74B; }
    .severity-option.medium .severity-dot { background: #FF9F0A; }
    .severity-option.high .severity-dot { background: #FF375F; }
    
    .severity-desc { font-size: 9px; font-weight: 400; color: #636366; }
    
    .severity-option.low.selected { background: rgba(50,215,75,0.1); border-color: rgba(50,215,75,0.3); }
    .severity-option.medium.selected { background: rgba(255,159,10,0.1); border-color: rgba(255,159,10,0.3); }
    .severity-option.high.selected { background: rgba(255,55,95,0.1); border-color: rgba(255,55,95,0.3); }
    
    .location-input-group {
      padding: 0 20px;
      margin-bottom: 20px;
    }
    
    .location-current {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      background: #1C1C1E;
      border: 2px solid transparent;
      border-radius: 12px;
      cursor: pointer;
    }
    
    .location-current.selected {
      background: rgba(100,210,255,0.1);
      border-color: rgba(100,210,255,0.3);
    }
    
    .location-icon { font-size: 22px; }
    .location-info { flex: 1; }
    .location-label { font-size: 14px; font-weight: 600; }
    .location-address { font-size: 11px; color: #636366; margin-top: 2px; }
    .location-current.selected .location-address { color: #64D2FF; }
    .location-check { color: #64D2FF; font-size: 18px; font-weight: 700; }
    
    .location-divider {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 12px 0;
      font-size: 11px;
      color: #636366;
    }
    
    .location-divider::before,
    .location-divider::after {
      content: '';
      flex: 1;
      height: 1px;
      background: #2C2C2E;
      margin: 0 12px;
    }
    
    .location-manual-input {
      width: 100%;
      padding: 12px 14px;
      background: #1C1C1E;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      outline: none;
    }
    
    .location-manual-input:focus { border-color: rgba(100,210,255,0.4); }
    
    .report-description {
      width: calc(100% - 40px);
      margin: 0 20px 20px;
      padding: 12px 14px;
      background: #1C1C1E;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 14px;
      font-family: inherit;
      resize: none;
      outline: none;
    }
    
    .report-description:focus { border-color: rgba(100,210,255,0.4); }
    .report-description::placeholder { color: #636366; }
    
    .evidence-attach {
      display: flex;
      gap: 10px;
      padding: 0 20px;
      margin-bottom: 12px;
    }
    
    .evidence-option {
      flex: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      padding: 12px;
      background: #1C1C1E;
      border: 1px dashed rgba(255,255,255,0.15);
      border-radius: 12px;
      cursor: pointer;
      font-size: 11px;
      color: #8E8E93;
    }
    
    .evidence-option span:first-child { font-size: 22px; }
    
    .attached-files {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      padding: 0 20px;
      margin-bottom: 12px;
    }
    
    .attached-file {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      background: rgba(50,215,75,0.1);
      border: 1px solid rgba(50,215,75,0.2);
      border-radius: 10px;
      font-size: 12px;
    }
    
    .attached-file-remove { color: #FF375F; cursor: pointer; font-size: 14px; }
    
    .anonymous-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      background: #1C1C1E;
      border-radius: 12px;
      margin: 0 20px 20px;
    }
    
    .anonymous-info { display: flex; align-items: center; gap: 10px; }
    .anonymous-icon { font-size: 22px; }
    .anonymous-label { font-size: 14px; font-weight: 600; }
    .anonymous-desc { font-size: 11px; color: #636366; margin-top: 2px; }
    
    .report-submit-btn {
      width: calc(100% - 40px);
      margin: 0 20px;
      padding: 16px;
      background: linear-gradient(135deg, #FF375F, #c41e3a);
      border: none;
      border-radius: 14px;
      color: #fff;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      box-shadow: 0 8px 30px rgba(255,55,95,0.3);
    }
    
    .report-submit-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    .report-disclaimer {
      text-align: center;
      font-size: 10px;
      color: #636366;
      margin: 14px 20px 0;
      line-height: 1.4;
    }
    
    .submitted-display { text-align: center; padding: 16px 20px; }
    .submitted-icon { font-size: 56px; margin-bottom: 14px; }
    .submitted-title { font-size: 22px; font-weight: 700; margin-bottom: 10px; }
    .submitted-text { font-size: 13px; color: #8E8E93; line-height: 1.5; margin-bottom: 20px; }
    
    .submitted-card {
      background: #1C1C1E;
      border-radius: 14px;
      padding: 14px;
      text-align: left;
      margin-bottom: 16px;
    }
    
    .submitted-card-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 10px;
    }
    
    .submitted-type-icon { font-size: 28px; }
    .submitted-type { font-weight: 700; font-size: 15px; }
    .submitted-location { font-size: 12px; color: #8E8E93; }
    
    .submitted-severity {
      margin-left: auto;
      padding: 4px 10px;
      border-radius: 8px;
      font-size: 10px;
      font-weight: 700;
      text-transform: uppercase;
    }
    
    .submitted-severity.low { background: rgba(50,215,75,0.15); color: #32D74B; }
    .submitted-severity.medium { background: rgba(255,159,10,0.15); color: #FF9F0A; }
    .submitted-severity.high { background: rgba(255,55,95,0.15); color: #FF375F; }
    
    .submitted-desc { font-size: 13px; color: #ccc; line-height: 1.5; margin-bottom: 10px; }
    .submitted-meta { display: flex; gap: 14px; font-size: 11px; color: #636366; }
    
    .submitted-stats {
      display: flex;
      gap: 16px;
      justify-content: center;
      margin-bottom: 20px;
    }
    
    .stat-item { text-align: center; }
    .stat-value { display: block; font-size: 22px; font-weight: 700; color: #64D2FF; }
    .stat-label { display: block; font-size: 10px; color: #636366; margin-top: 4px; }
    
    .submitted-actions {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
    }
    
    .submitted-btn {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px;
      border: none;
      border-radius: 12px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
    }
    
    .submitted-btn.primary { background: #25D366; color: #fff; }
    .submitted-btn.secondary { background: #2C2C2E; color: #fff; }
    
    .submitted-done-btn {
      width: 100%;
      padding: 12px;
      background: transparent;
      border: 1px solid #2C2C2E;
      border-radius: 12px;
      color: #8E8E93;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
    }
    
    /* =============================================
       SETTINGS SCREEN STYLES
       ============================================= */
    .settings-group {
      margin-bottom: 20px;
    }
    
    .settings-group-title {
      font-size: 11px;
      color: #8E8E93;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      padding-left: 4px;
    }
    
    .settings-item {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #1C1C1E;
      padding: 12px 14px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      cursor: pointer;
      transition: background 0.15s ease;
    }
    
    .settings-item:active {
      background: #2C2C2E;
    }
    
    .settings-item:first-of-type { border-radius: 12px 12px 0 0; }
    .settings-item:last-of-type { border-radius: 0 0 12px 12px; border-bottom: none; }
    .settings-item:only-of-type { border-radius: 12px; }
    
    .settings-icon {
      width: 30px;
      height: 30px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
    .settings-info { flex: 1; }
    .settings-label { font-size: 15px; }
    .settings-desc { font-size: 11px; color: #8E8E93; margin-top: 2px; }
    .settings-arrow { color: #636366; font-size: 16px; }
    
    /* Settings Sub-Screens */
    .settings-subscreen {
      position: fixed;
      inset: 0;
      background: #000;
      z-index: 150;
      display: none;
      flex-direction: column;
      max-width: 430px;
      margin: 0 auto;
    }
    
    .settings-subscreen.show {
      display: flex;
    }
    
    .settings-subscreen-header {
      display: flex;
      align-items: center;
      padding: 14px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .settings-subscreen-back {
      display: flex;
      align-items: center;
      gap: 4px;
      color: #64D2FF;
      font-size: 16px;
      cursor: pointer;
    }
    
    .settings-subscreen-title {
      flex: 1;
      text-align: center;
      font-size: 17px;
      font-weight: 600;
      margin-right: 50px;
    }
    
    .settings-subscreen-content {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
    }
    
    .settings-form-group {
      margin-bottom: 20px;
    }
    
    .settings-form-label {
      font-size: 12px;
      color: #8E8E93;
      text-transform: uppercase;
      margin-bottom: 8px;
      display: block;
    }
    
    .settings-form-input {
      width: 100%;
      padding: 14px 16px;
      background: #1C1C1E;
      border: 1px solid rgba(255,255,255,0.1);
      border-radius: 12px;
      color: #fff;
      font-size: 16px;
      outline: none;
    }
    
    .settings-form-input:focus {
      border-color: rgba(100,210,255,0.4);
    }
    
    .settings-save-btn {
      width: 100%;
      padding: 16px;
      background: #32D74B;
      border: none;
      border-radius: 14px;
      color: #fff;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 20px;
    }
    
    .settings-danger-btn {
      width: 100%;
      padding: 16px;
      background: transparent;
      border: 1px solid #FF375F;
      border-radius: 14px;
      color: #FF375F;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      margin-top: 10px;
    }
    
    /* Premium Feature Card */
    .premium-card {
      background: linear-gradient(135deg, rgba(191,90,242,0.2), rgba(191,90,242,0.05));
      border: 1px solid rgba(191,90,242,0.3);
      border-radius: 16px;
      padding: 20px;
      text-align: center;
      margin-bottom: 20px;
    }
    
    .premium-icon { font-size: 48px; margin-bottom: 12px; }
    .premium-title { font-size: 20px; font-weight: 700; color: #BF5AF2; margin-bottom: 8px; }
    .premium-desc { font-size: 13px; color: #8E8E93; line-height: 1.5; margin-bottom: 16px; }
    
    .premium-features {
      text-align: left;
      margin-bottom: 16px;
    }
    
    .premium-feature {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 0;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    
    .premium-feature:last-child { border-bottom: none; }
    .premium-feature-icon { color: #BF5AF2; }
    
    .premium-btn {
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, #BF5AF2, #9945FF);
      border: none;
      border-radius: 14px;
      color: #fff;
      font-size: 17px;
      font-weight: 700;
      cursor: pointer;
    }
    
    .premium-price {
      font-size: 12px;
      color: #8E8E93;
      margin-top: 10px;
    }
    
    /* Language Selector */
    .language-option {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: #1C1C1E;
      border-radius: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s ease;
    }
    
    .language-option:hover {
      background: #2C2C2E;
      transform: translateX(4px);
    }
    
    .language-option:active {
      transform: scale(0.98);
    }
    
    .language-option.selected {
      border-color: #64D2FF;
      background: rgba(100,210,255,0.1);
    }
    
    .language-flag { font-size: 24px; }
    .language-name { flex: 1; font-size: 16px; font-weight: 500; }
    .language-check { color: #64D2FF; display: none; font-size: 18px; }
    .language-option.selected .language-check { display: block; }
    
    /* How It Works */
    .how-step {
      display: flex;
      gap: 14px;
      margin-bottom: 20px;
    }
    
    .how-step-number {
      width: 36px;
      height: 36px;
      background: #FF375F;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      flex-shrink: 0;
    }
    
    .how-step-content { flex: 1; }
    .how-step-title { font-weight: 600; margin-bottom: 4px; }
    .how-step-desc { font-size: 13px; color: #8E8E93; line-height: 1.5; }
    
    /* =============================================
       AI FLOATING BUTTON
       ============================================= */
    .ai-float-btn {
      position: fixed;
      bottom: 100px;
      right: 20px;
      width: 56px;
      height: 56px;
      background: linear-gradient(145deg, #BF5AF2, #9945D6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      box-shadow: 
        0 8px 30px rgba(191,90,242,0.5),
        inset 0 2px 4px rgba(255,255,255,0.2);
      z-index: 90;
      animation: aiFloat 3s ease-in-out infinite;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      border: none;
    }
    
    @keyframes aiFloat {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-5px); }
    }
    
    .ai-float-btn:active {
      transform: scale(0.9);
    }
    
    .ai-float-btn.listening {
      animation: aiPulse 0.5s ease-in-out infinite;
      box-shadow: 0 0 0 0 rgba(191,90,242,0.7);
    }
    
    @keyframes aiPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(191,90,242,0.7), 0 8px 30px rgba(191,90,242,0.5); }
      50% { box-shadow: 0 0 0 20px rgba(191,90,242,0), 0 8px 30px rgba(191,90,242,0.5); }
    }
    
    .ai-float-btn .ai-status {
      position: absolute;
      top: -4px;
      right: -4px;
      width: 16px;
      height: 16px;
      background: #32D74B;
      border-radius: 50%;
      border: 2px solid #000;
      font-size: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    /* =============================================
       AI CHATBOT SCREEN
       ============================================= */
    #aiScreen {
      background: #000;
    }
    
    .ai-header {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 60px 20px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    
    .ai-avatar {
      width: 48px;
      height: 48px;
      background: linear-gradient(145deg, #BF5AF2, #9945D6);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .ai-info h2 {
      font-size: 20px;
      font-weight: 700;
    }
    
    .ai-info p {
      font-size: 13px;
      color: #8E8E93;
    }
    
    .ai-close {
      width: 32px;
      height: 32px;
      background: #2C2C2E;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 16px;
    }
    
    .ai-header-actions {
      margin-left: auto;
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .ai-new-chat {
      width: 32px;
      height: 32px;
      background: #2C2C2E;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s ease;
    }
    
    .ai-new-chat:active {
      transform: scale(0.9);
      background: rgba(191,90,242,0.3);
    }
    
    .ai-chat-container {
      height: calc(100vh - 200px); /* Account for header and input area */
      overflow-y: auto;
      padding: 20px;
      padding-bottom: 80px; /* Extra space for scrolling above input */
    }
    
    .ai-message {
      max-width: 85%;
      padding: 14px 16px;
      border-radius: 18px;
      margin-bottom: 12px;
      font-size: 15px;
      line-height: 1.5;
      animation: messageFade 0.3s ease;
    }
    
    @keyframes messageFade {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .ai-message.assistant {
      background: #1C1C1E;
      border: 1px solid rgba(191,90,242,0.2);
      margin-right: auto;
    }
    
    .ai-message.user {
      background: linear-gradient(135deg, #BF5AF2, #9945D6);
      margin-left: auto;
    }
    
    .ai-quick-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    
    .ai-quick-btn {
      padding: 10px 16px;
      background: rgba(191,90,242,0.15);
      border: 1px solid rgba(191,90,242,0.3);
      border-radius: 20px;
      color: #BF5AF2;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .ai-quick-btn:active {
      transform: scale(0.95);
      background: rgba(191,90,242,0.25);
    }
    
    .ai-input-area {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-width: 430px;
      margin: 0 auto;
      padding: 16px 20px 32px;
      background: rgba(0,0,0,0.95);
      backdrop-filter: blur(20px);
      border-top: 1px solid rgba(255,255,255,0.1);
      z-index: 55;
    }
    
    .ai-input-wrap {
      display: flex;
      align-items: center;
      gap: 12px;
      background: #1C1C1E;
      border-radius: 24px;
      padding: 8px 16px;
      border: 1px solid rgba(255,255,255,0.1);
    }
    
    .ai-input-wrap input {
      flex: 1;
      background: none;
      border: none;
      color: #fff;
      font-size: 16px;
      outline: none;
      min-height: 24px;
      -webkit-appearance: none;
      appearance: none;
    }
    
    .ai-input-wrap input:focus {
      outline: none;
    }
    
    .ai-input-wrap input::placeholder {
      color: #636366;
    }
    
    .ai-voice-btn {
      width: 40px;
      height: 40px;
      background: linear-gradient(145deg, #BF5AF2, #9945D6);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
    }
    
    .ai-voice-btn:active {
      transform: scale(0.9);
    }
    
    .ai-voice-btn.listening {
      animation: voicePulse 0.5s ease-in-out infinite;
    }
    
    @keyframes voicePulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(191,90,242,0.7); }
      50% { box-shadow: 0 0 0 15px rgba(191,90,242,0); }
    }
    
    .ai-send-btn {
      width: 40px;
      height: 40px;
      background: #32D74B;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      border: none;
      transition: all 0.2s ease;
    }
    
    .ai-send-btn:active {
      transform: scale(0.9);
    }
    
    /* Voice Report Button on Report Screen */
    .voice-report-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      width: 100%;
      padding: 16px;
      background: linear-gradient(135deg, rgba(191,90,242,0.2), rgba(191,90,242,0.1));
      border: 1px solid rgba(191,90,242,0.4);
      border-radius: 14px;
      color: #BF5AF2;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      margin-bottom: 20px;
      transition: all 0.2s ease;
    }
    
    .voice-report-btn:active {
      transform: scale(0.98);
      background: linear-gradient(135deg, rgba(191,90,242,0.3), rgba(191,90,242,0.2));
    }
    
    .voice-report-btn.listening {
      animation: voiceReportPulse 0.5s ease-in-out infinite;
    }
    
    @keyframes voiceReportPulse {
      0%, 100% { border-color: rgba(191,90,242,0.4); }
      50% { border-color: rgba(191,90,242,1); box-shadow: 0 0 20px rgba(191,90,242,0.3); }
    }
    
    /* AI Thinking Animation */
    .ai-thinking {
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .ai-thinking::after {
      content: '';
      width: 20px;
      height: 20px;
      border: 2px solid rgba(191,90,242,0.3);
      border-top-color: #BF5AF2;
      border-radius: 50%;
      animation: aiSpin 1s linear infinite;
    }
    
    @keyframes aiSpin {
      to { transform: rotate(360deg); }
    }
    
    /* AI Powered Badge */
    .ai-powered-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: linear-gradient(135deg, rgba(191,90,242,0.2), rgba(191,90,242,0.1));
      border: 1px solid rgba(191,90,242,0.3);
      border-radius: 20px;
      font-size: 11px;
      color: #BF5AF2;
      font-weight: 600;
    }
    
    .ai-powered-badge::before {
      content: 'âœ¨';
    }
  </style>
<body>
  <div class="app" id="app">
    <!-- Ambient Lighting System -->
    <div class="ambient-container">
      <div class="glow-orb primary"></div>
      <div class="glow-orb secondary"></div>
      <div class="glow-orb accent"></div>
    </div>
    
    <div class="glow" id="glow"></div>
    
    <!-- =============================================
         HOME SCREEN
         ============================================= -->
    <div class="screen active" id="homeScreen">
      
      <!-- STATIC HEADER - Does NOT scroll -->
      <div class="static-header glass-heavy">
        <!-- Status Bar at TOP -->
        <div class="status-bar">
          <div class="status-left">
            <span class="status-time" id="time">9:41</span>
          </div>
          <div class="status-right">
            <div class="signal-bars">
              <div class="signal-bar"></div>
              <div class="signal-bar"></div>
              <div class="signal-bar"></div>
              <div class="signal-bar"></div>
            </div>
            <span class="wifi-icon">ðŸ“¶</span>
            <div class="battery-container">
              <div class="battery-body">
                <div class="battery-level"></div>
              </div>
              <div class="battery-cap"></div>
            </div>
          </div>
        </div>
        
        <!-- SafeAlert Banner below time -->
        <div class="header stagger-item">
          <div class="logo">ðŸ›¡ï¸</div>
          <div>
            <h1>SafeAlert</h1>
            <p>ðŸ‡³ðŸ‡¬ Nationwide Protection</p>
          </div>
        </div>
        
        <!-- COMPACT Location Bar -->
        <div class="location-compact stagger-item" onclick="openStateSelector()">
          <div class="location-compact-icon">ðŸ“</div>
          <div class="location-compact-text">
            <div class="location-compact-city" id="currentCity">Ikeja</div>
            <div class="location-compact-state" id="currentState">Lagos State, Nigeria</div>
          </div>
          <span class="location-compact-change">Change</span>
        </div>
      </div>
      
      <!-- Hidden Dynamic Island for emergency state (appears when active) -->
      <div class="island" id="island" style="display: none;">
        <div class="island-content">
          <div class="island-icon">ðŸš¨</div>
          <div>
            <div class="island-title">Emergency Active</div>
            <div class="island-sub">Help is on the way â€¢ 3 contacts notified</div>
          </div>
        </div>
      </div>
      
      <!-- SCROLLABLE CONTENT -->
      <div class="scrollable-content">
        
      <!-- KIDNAPPING ALERT BANNER - More Prominent (Swipe to dismiss) -->
        <div class="kidnap-alert-banner stagger-item" id="kidnapBanner">
          <div class="kidnap-alert-icon">ðŸš¨</div>
          <div class="kidnap-alert-content" onclick="switchScreen('hubScreen')">
            <div class="kidnap-alert-title">âš ï¸ Kidnapping Alert</div>
            <div class="kidnap-alert-sub">3 incidents reported in your region today</div>
            <div style="font-size: 10px; color: #8E8E93; margin-top: 4px;">â† Swipe to dismiss</div>
          </div>
          <div class="kidnap-alert-count" onclick="switchScreen('hubScreen')">3</div>
        </div>
        
        <div class="safety stagger-item" id="safety" onclick="onSafetyCardTap()" style="cursor:pointer;">
          <div class="safety-icon" id="safetyIcon">âœ“</div>
          <div>
            <div class="safety-title" id="safetyTitle">All Clear</div>
            <div class="safety-sub" id="safetySub">No threats detected in your area</div>
            <span class="safety-badge" id="safetyBadge">ðŸŸ¢ Safe Zone</span>
          </div>
        </div>
        
        <div class="sos-wrap stagger-item">
          <div class="sos-outer" id="sosOuter">
            <div class="sos-ring-3"></div>
            <div class="sos-ring"></div>
            <div class="sos-ring-2"></div>
            <div class="sos-pulse-ring"></div>
            <div class="sos-pulse-ring"></div>
            <div class="sos-pulse-ring"></div>
            <button id="sosBtn" class="sos-button">
              <span class="sos-count" id="sosCount">SOS</span>
              <span class="sos-label" id="sosLabel">Hold for 3 seconds</span>
            </button>
          </div>
          
          <button class="end-emergency-btn" id="endEmergencyBtn2" onclick="endEmergency()" style="display:none;">
            <span>âœ“</span>
            <span>I'm Safe â€” End Emergency</span>
          </button>
        </div>
        
        <div class="quick-actions stagger-item">
          <div class="quick-action" onclick="switchScreen('checkinScreen')">
            <div class="quick-action-icon" style="background: rgba(255,159,10,0.15)">â±ï¸</div>
            <div class="quick-action-label">Check-In</div>
          </div>
          <div class="quick-action" onclick="switchScreen('recordScreen')">
            <div class="quick-action-icon" style="background: rgba(255,55,95,0.15)">ðŸŽ™ï¸</div>
            <div class="quick-action-label">Record</div>
          </div>
          <div class="quick-action" onclick="switchScreen('reportScreen')">
            <div class="quick-action-icon" style="background: rgba(50,215,75,0.15)">ðŸ“¢</div>
            <div class="quick-action-label">Report</div>
          </div>
          <div class="quick-action" onclick="switchScreen('mapScreen')">
            <div class="quick-action-icon" style="background: rgba(100,210,255,0.15)">ðŸ“</div>
            <div class="quick-action-label">Trip</div>
          </div>
        </div>
        
        <div class="section-header stagger-item">
          <span class="section-title">Emergency Contacts</span>
          <span class="section-action" onclick="openSettingsSubscreen('contacts')">Edit</span>
        </div>
        
        <div class="contact stagger-item">
          <div class="contact-avatar" style="background: linear-gradient(145deg, #3498db, #2980b9)">
            MA<div class="contact-status"></div>
          </div>
          <div class="contact-info">
            <div class="contact-name">Mama</div>
            <div class="contact-type">Family â€¢ +234 802 XXX XXXX</div>
          </div>
          <div class="contact-call">ðŸ“ž</div>
        </div>
        
        <div class="contact stagger-item">
          <div class="contact-avatar" style="background: linear-gradient(145deg, #FF9F0A, #e08900)">
            AD<div class="contact-status"></div>
          </div>
          <div class="contact-info">
            <div class="contact-name">Alhaji Danfodio</div>
            <div class="contact-type">Neighbor â€¢ +234 803 XXX XXXX</div>
          </div>
          <div class="contact-call">ðŸ“ž</div>
        </div>
        
        <div class="contact stagger-item">
          <div class="contact-avatar" style="background: linear-gradient(145deg, #32D74B, #28a745)">
            ðŸ›¡ï¸<div class="contact-status"></div>
          </div>
          <div class="contact-info">
            <div class="contact-name">Area Security</div>
            <div class="contact-type">Vigilante â€¢ +234 901 XXX XXXX</div>
          </div>
          <div class="contact-call">ðŸ“ž</div>
        </div>
        
        <div class="footer stagger-item">
          <div class="footer-badge">
            ðŸ‡³ðŸ‡¬ NDPR Compliant â€¢ Serving all 36 States + FCT
          </div>
        </div>
      </div>
    </div>
    
    <!-- STATE SELECTOR MODAL - All 36 States + FCT -->
    <div class="state-selector-modal" id="stateModal">
      <div class="state-modal-header">
        <div class="state-modal-title">Select Your State</div>
        <div class="state-modal-close" onclick="closeStateSelector()">âœ•</div>
      </div>
      
      <div class="state-search">
        <span>ðŸ”</span>
        <input type="text" placeholder="Search states..." id="stateSearchInput" oninput="filterStates()">
      </div>
      
      <div class="state-list" id="stateList">
        <!-- North Central -->
        <div class="state-region-header">North Central</div>
        <div class="state-item" onclick="selectState('Benue', 'Makurdi')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Benue</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('FCT', 'Abuja')"><span class="state-item-icon">ðŸ›ï¸</span><span class="state-item-name">FCT - Abuja</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Kogi', 'Lokoja')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Kogi</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Kwara', 'Ilorin')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Kwara</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Nasarawa', 'Lafia')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Nasarawa</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Niger', 'Minna')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Niger</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Plateau', 'Jos')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Plateau</span><span class="state-item-check">âœ“</span></div>
        
        <!-- North East -->
        <div class="state-region-header">North East</div>
        <div class="state-item" onclick="selectState('Adamawa', 'Yola')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Adamawa</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Bauchi', 'Bauchi')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Bauchi</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Borno', 'Maiduguri')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Borno</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Gombe', 'Gombe')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Gombe</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Taraba', 'Jalingo')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Taraba</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Yobe', 'Damaturu')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Yobe</span><span class="state-item-check">âœ“</span></div>
        
        <!-- North West -->
        <div class="state-region-header">North West</div>
        <div class="state-item" onclick="selectState('Jigawa', 'Dutse')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Jigawa</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Kaduna', 'Kaduna')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Kaduna</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Kano', 'Kano')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Kano</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Katsina', 'Katsina')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Katsina</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Kebbi', 'Birnin Kebbi')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Kebbi</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Sokoto', 'Sokoto')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Sokoto</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Zamfara', 'Gusau')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Zamfara</span><span class="state-item-check">âœ“</span></div>
        
        <!-- South East -->
        <div class="state-region-header">South East</div>
        <div class="state-item" onclick="selectState('Abia', 'Umuahia')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Abia</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Anambra', 'Awka')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Anambra</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Ebonyi', 'Abakaliki')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Ebonyi</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Enugu', 'Enugu')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Enugu</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Imo', 'Owerri')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Imo</span><span class="state-item-check">âœ“</span></div>
        
        <!-- South South -->
        <div class="state-region-header">South South</div>
        <div class="state-item" onclick="selectState('Akwa Ibom', 'Uyo')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Akwa Ibom</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Bayelsa', 'Yenagoa')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Bayelsa</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Cross River', 'Calabar')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Cross River</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Delta', 'Asaba')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Delta</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Edo', 'Benin City')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Edo</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Rivers', 'Port Harcourt')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Rivers</span><span class="state-item-check">âœ“</span></div>
        
        <!-- South West -->
        <div class="state-region-header">South West</div>
        <div class="state-item" onclick="selectState('Ekiti', 'Ado Ekiti')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Ekiti</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item selected" onclick="selectState('Lagos', 'Ikeja')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Lagos</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Ogun', 'Abeokuta')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Ogun</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Ondo', 'Akure')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Ondo</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Osun', 'Osogbo')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Osun</span><span class="state-item-check">âœ“</span></div>
        <div class="state-item" onclick="selectState('Oyo', 'Ibadan')"><span class="state-item-icon">ðŸ“</span><span class="state-item-name">Oyo</span><span class="state-item-check">âœ“</span></div>
      </div>
    </div>
    <!-- =============================================
         MAP SCREEN (Full Screen)
         ============================================= -->
    <div class="screen fullscreen" id="mapScreen">
      <div class="map-container" id="mapContainer">
        <svg class="map-svg" id="mapSvg" viewBox="0 0 400 700">
          <defs>
            <linearGradient id="routeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" style="stop-color:#64D2FF;stop-opacity:1" />
              <stop offset="50%" style="stop-color:#32D74B;stop-opacity:1" />
              <stop offset="100%" style="stop-color:#64D2FF;stop-opacity:1" />
            </linearGradient>
            <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
              <feGaussianBlur stdDeviation="3" result="blur"/>
              <feMerge>
                <feMergeNode in="blur"/>
                <feMergeNode in="SourceGraphic"/>
              </feMerge>
            </filter>
          </defs>
          
          <g id="mapContent">
            <rect width="800" height="1400" fill="#0a0a0a" x="-200" y="-350"/>
            
            <!-- Water/Lagos Lagoon -->
            <ellipse cx="350" cy="550" rx="150" ry="80" fill="#0d1f2d" opacity="0.5"/>
            <ellipse cx="50" cy="100" rx="100" ry="60" fill="#0d1f2d" opacity="0.3"/>
            
            <!-- Districts/Areas -->
            <path class="map-area" d="M30,80 L150,50 L200,100 L160,180 L50,150 Z" id="area-ikeja" data-name="Ikeja"/>
            <path class="map-area" d="M200,100 L320,60 L370,140 L300,200 L200,180 Z" id="area-yaba" data-name="Yaba"/>
            <path class="map-area" d="M50,150 L160,180 L180,280 L80,320 L30,240 Z" id="area-surulere" data-name="Surulere"/>
            <path class="map-area" d="M300,200 L380,180 L400,300 L340,360 L260,320 Z" id="area-maryland" data-name="Maryland"/>
            <path class="map-area" d="M180,280 L260,320 L300,420 L200,460 L120,400 Z" id="area-mushin" data-name="Mushin"/>
            <path class="map-area" d="M80,320 L180,280 L200,460 L100,500 L40,420 Z" id="area-oshodi" data-name="Oshodi"/>
            <path class="map-area" d="M260,320 L340,360 L360,480 L280,520 L200,460 Z" id="area-vi" data-name="Victoria Island"/>
            <path class="map-area" d="M280,520 L360,480 L420,560 L380,620 L300,600 Z" id="area-lekki" data-name="Lekki"/>
            <path class="map-area" d="M200,460 L280,520 L300,600 L220,580 L180,520 Z" id="area-ikoyi" data-name="Ikoyi"/>
            
            <!-- Area labels -->
            <text x="100" y="120" fill="#3a3a3c" font-size="12" font-weight="600">Ikeja</text>
            <text x="270" y="130" fill="#3a3a3c" font-size="12" font-weight="600">Yaba</text>
            <text x="90" y="240" fill="#3a3a3c" font-size="11" font-weight="600">Surulere</text>
            <text x="320" y="280" fill="#3a3a3c" font-size="11" font-weight="600">Maryland</text>
            <text x="200" y="380" fill="#3a3a3c" font-size="11" font-weight="600">Mushin</text>
            <text x="100" y="420" fill="#3a3a3c" font-size="11" font-weight="600">Oshodi</text>
            <text x="290" y="440" fill="#3a3a3c" font-size="11" font-weight="600">V.I.</text>
            <text x="340" y="560" fill="#3a3a3c" font-size="11" font-weight="600">Lekki</text>
            <text x="230" y="540" fill="#3a3a3c" font-size="11" font-weight="600">Ikoyi</text>
            
            <!-- Main roads -->
            <path class="map-road map-road-main" d="M-50,250 Q120,250 200,220 T450,250" id="road-main1"/>
            <path class="map-road map-road-main" d="M200,-50 Q200,150 200,300 T200,750" id="road-main2"/>
            <path class="map-road map-road-main" d="M-50,450 Q100,420 200,460 Q300,500 450,480" id="road-third-mainland"/>
            
            <!-- Secondary roads -->
            <path class="map-road" d="M60,120 Q130,140 200,140"/>
            <path class="map-road" d="M200,140 Q280,140 350,110"/>
            <path class="map-road" d="M80,380 Q150,350 200,380"/>
            <path class="map-road" d="M200,380 Q270,400 350,380"/>
            <path class="map-road" d="M100,200 L160,280"/>
            <path class="map-road" d="M300,280 L340,380"/>
            <path class="map-road" d="M220,480 L280,560"/>
            <path class="map-road" d="M300,520 L360,560"/>
            
            <!-- Route paths -->
            <path class="route-path-glow" d="M200,300 Q220,360 240,420 Q270,480 300,520" id="routeGlow" style="display:none"/>
            <path id="routePath" d="M200,300 Q220,360 240,420 Q270,480 300,520" 
                  fill="none" stroke="#64D2FF" stroke-width="5" stroke-linecap="round"
                  stroke-dasharray="1000" stroke-dashoffset="1000" style="display:none; filter: url(#glow);"/>
            <path id="routeTraveled" d="M200,300 Q220,360 240,420 Q270,480 300,520" 
                  fill="none" stroke="#32D74B" stroke-width="5" stroke-linecap="round"
                  stroke-dasharray="0 1000" style="display:none; filter: url(#glow);"/>
            
            <!-- KIDNAPPING Alert markers - MORE PROMINENT -->
            <g class="alert-marker" id="marker1" transform="translate(130, 140)" onclick="showMarkerInfo(1)" style="cursor:pointer">
              <circle class="marker-pulse" cx="0" cy="0" r="20" fill="#FF375F" opacity="0.3"/>
              <circle cx="0" cy="0" r="14" fill="#FF375F" stroke="#000" stroke-width="2"/>
              <text x="0" y="5" text-anchor="middle" fill="white" font-size="12" font-weight="bold">!</text>
            </g>
            
            <g class="alert-marker" id="marker2" transform="translate(320, 300)" onclick="showMarkerInfo(2)" style="cursor:pointer">
              <circle class="marker-pulse" cx="0" cy="0" r="20" fill="#FF9F0A" opacity="0.3"/>
              <circle cx="0" cy="0" r="14" fill="#FF9F0A" stroke="#000" stroke-width="2"/>
              <text x="0" y="5" text-anchor="middle" fill="white" font-size="11" font-weight="bold">âš </text>
            </g>
            
            <g class="alert-marker" id="marker3" transform="translate(120, 440)" onclick="showMarkerInfo(3)" style="cursor:pointer">
              <circle class="marker-pulse" cx="0" cy="0" r="20" fill="#FF9F0A" opacity="0.3"/>
              <circle cx="0" cy="0" r="14" fill="#FF9F0A" stroke="#000" stroke-width="2"/>
              <text x="0" y="5" text-anchor="middle" fill="white" font-size="11" font-weight="bold">âš </text>
            </g>
            
            <!-- NEW: Kidnapping alert marker -->
            <g class="alert-marker" id="marker5" transform="translate(250, 200)" onclick="showMarkerInfo(5)" style="cursor:pointer">
              <circle class="marker-pulse" cx="0" cy="0" r="24" fill="#FF375F" opacity="0.4"/>
              <circle cx="0" cy="0" r="16" fill="#FF375F" stroke="#fff" stroke-width="2"/>
              <text x="0" y="6" text-anchor="middle" fill="white" font-size="14" font-weight="bold">K</text>
            </g>
            
            <g class="alert-marker" id="marker4" transform="translate(350, 540)" onclick="showMarkerInfo(4)" style="cursor:pointer">
              <circle cx="0" cy="0" r="14" fill="#32D74B" stroke="#000" stroke-width="2"/>
              <text x="0" y="5" text-anchor="middle" fill="white" font-size="12" font-weight="bold">âœ“</text>
            </g>
            
            <!-- Destination marker -->
            <g id="destMarker" transform="translate(300, 520)" style="display:none">
              <circle cx="0" cy="-20" r="8" fill="#32D74B"/>
              <path d="M0,0 L-10,-25 Q0,-35 10,-25 Z" fill="#32D74B" stroke="#000" stroke-width="1"/>
              <circle cx="0" cy="-20" r="4" fill="white"/>
            </g>
            
            <!-- User location -->
            <g class="user-location" id="userMarker" transform="translate(200, 300)">
              <circle class="user-pulse" cx="0" cy="0" r="20" fill="#64D2FF" opacity="0.3"/>
              <circle cx="0" cy="0" r="12" fill="#64D2FF" stroke="#fff" stroke-width="3"/>
              <circle cx="0" cy="0" r="5" fill="white"/>
              <path id="userDirection" d="M0,-18 L5,-10 L-5,-10 Z" fill="#64D2FF" style="display:none"/>
            </g>
          </g>
        </svg>
        
        <!-- Map Header -->
        <div class="map-header">
          <div class="status-bar" style="padding: 0;">
            <span id="time2">9:41</span>
            <span>ðŸ“¶ ðŸ“ ðŸ”‹</span>
          </div>
        </div>
        
        <!-- Search overlay -->
        <div class="map-search" id="mapSearch">
          <div class="search-input-wrap">
            <span>ðŸ”</span>
            <input type="text" placeholder="Search location..." id="mapSearchInput" onfocus="showSearchSuggestions()" oninput="filterSuggestions()">
            <span class="search-clear" onclick="clearSearch()">âœ•</span>
          </div>
          <div class="search-suggestions" id="searchSuggestions">
            <div class="suggestion-item" onclick="goToLocation('ikeja')">
              <span>ðŸ“</span>
              <div><div class="suggestion-name">Ikeja</div><div class="suggestion-desc">Lagos State</div></div>
            </div>
            <div class="suggestion-item" onclick="goToLocation('vi')">
              <span>ðŸ“</span>
              <div><div class="suggestion-name">Victoria Island</div><div class="suggestion-desc">Lagos State</div></div>
            </div>
            <div class="suggestion-item" onclick="goToLocation('lekki')">
              <span>ðŸ“</span>
              <div><div class="suggestion-name">Lekki</div><div class="suggestion-desc">Lagos State</div></div>
            </div>
            <div class="suggestion-item" onclick="goToLocation('yaba')">
              <span>ðŸ“</span>
              <div><div class="suggestion-name">Yaba</div><div class="suggestion-desc">Lagos State</div></div>
            </div>
            <div class="suggestion-item" onclick="goToLocation('ikoyi')">
              <span>ðŸ“</span>
              <div><div class="suggestion-name">Ikoyi</div><div class="suggestion-desc">Lagos State</div></div>
            </div>
          </div>
        </div>
        
        <!-- Map controls -->
        <div class="map-controls">
          <div class="map-btn" onclick="centerOnUser()" id="centerBtn">ðŸ“</div>
          <div class="map-btn" onclick="zoomIn()">+</div>
          <div class="map-btn" onclick="zoomOut()">âˆ’</div>
          <div class="map-btn" onclick="toggleMapStyle()" id="styleBtn">ðŸ—ºï¸</div>
        </div>
        
        <div class="zoom-indicator" id="zoomIndicator">100%</div>
        
        <!-- Legend -->
        <div class="map-legend" id="mapLegend">
          <div class="legend-title">Map Legend</div>
          <div class="legend-item"><div class="legend-dot" style="background:#FF375F"></div><span>High Alert / Kidnap</span></div>
          <div class="legend-item"><div class="legend-dot" style="background:#FF9F0A"></div><span>Caution</span></div>
          <div class="legend-item"><div class="legend-dot" style="background:#32D74B"></div><span>Safe Zone</span></div>
          <div class="legend-item"><div class="legend-dot" style="background:#64D2FF"></div><span>Your Location</span></div>
        </div>
        
        <!-- Marker Info Popup - AI Enhanced -->
        <div class="marker-popup" id="markerPopup">
          <div class="popup-close" onclick="hideMarkerInfo()">âœ•</div>
          <div class="popup-badge" id="popupBadge">ðŸš¨ High Alert</div>
          <div class="popup-title" id="popupTitle">Armed Robbery</div>
          <div class="popup-location" id="popupLocation">ðŸ“ Computer Village, Ikeja</div>
          <div class="popup-time" id="popupTime">18 minutes ago</div>
          <div class="popup-desc" id="popupDesc">Armed robbery reported. Avoid the area.</div>
          
          <!-- AI Analysis Section -->
          <div class="ai-route-analysis" id="markerAiAnalysis" style="margin-top:12px;">
            <div class="ai-route-header">
              <span class="ai-route-icon">ðŸ¤–</span>
              <span class="ai-route-title">AI Safety Advice</span>
            </div>
            <div class="ai-route-body" id="markerAiBody">
              Loading AI analysis...
            </div>
            <div class="ai-route-tips" id="markerAiTips"></div>
          </div>
          
          <div class="popup-actions" style="margin-top:16px;">
            <button class="popup-btn" onclick="askAIAboutMarker()">ðŸ¤– Ask AI</button>
            <button class="popup-btn secondary" onclick="shareAlert()">ðŸ“¤ Share</button>
          </div>
        </div>
        
        <!-- Start Trip Panel - Collapsible -->
        <div class="start-trip-panel collapsed" id="startTripPanel">
          <!-- Collapse Handle -->
          <div class="panel-collapse-handle" onclick="toggleTripPanel()">
            <div class="panel-handle-left">
              <span class="panel-handle-icon">ðŸ—ºï¸</span>
              <div>
                <div class="panel-handle-title">Trip Monitoring</div>
                <div class="panel-handle-subtitle">Tap to plan your route</div>
              </div>
            </div>
            <span class="ai-safety-badge safe">âœ¨ AI Ready</span>
            <span class="panel-collapse-arrow">â–²</span>
          </div>
          
          <!-- Expandable Content -->
          <div class="panel-content">
            <!-- AI Route Analysis (appears after destination selected) -->
            <div class="ai-route-analysis" id="aiRouteAnalysis" style="display:none;">
              <div class="ai-route-header">
                <span class="ai-route-icon">ðŸ¤–</span>
                <span class="ai-route-title">AI Safety Analysis</span>
                <span class="ai-safety-badge analyzing" id="routeSafetyBadge">Analyzing...</span>
              </div>
              <div class="ai-route-body" id="aiRouteBody">
                Analyzing route safety based on time, location, and recent incidents...
              </div>
              <div class="ai-route-tips" id="aiRouteTips"></div>
            </div>
            
            <div class="destination-input">
              <span>ðŸ“</span>
              <input type="text" placeholder="Where are you going?" id="destInput" list="destinations" oninput="onDestinationInput()">
              <button class="dest-voice-btn" id="destVoiceBtn" onclick="toggleDestVoice()">ðŸŽ¤</button>
              <datalist id="destinations">
                <option value="Victoria Island">
                <option value="Lekki">
                <option value="Ikeja">
                <option value="Yaba">
                <option value="Ikoyi">
                <option value="Surulere">
                <option value="Maryland">
              </datalist>
            </div>
            
            <div class="recent-destinations">
              <div class="recent-title">Recent Destinations</div>
              <div class="recent-item" onclick="selectDestination('Victoria Island', 300, 520)">
                <span class="recent-icon">ðŸ’¼</span>
                <div>
                  <div class="recent-name">Work</div>
                  <div class="recent-address">Victoria Island, Lagos</div>
                </div>
                <span class="recent-distance">4.2 km</span>
              </div>
              <div class="recent-item" onclick="selectDestination('Lekki', 350, 580)">
                <span class="recent-icon">ðŸ </span>
                <div>
                  <div class="recent-name">Home</div>
                  <div class="recent-address">Lekki, Lagos</div>
                </div>
                <span class="recent-distance">8.5 km</span>
              </div>
              <div class="recent-item" onclick="selectDestination('Ikeja', 130, 120)">
                <span class="recent-icon">ðŸ›’</span>
                <div>
                  <div class="recent-name">Computer Village</div>
                  <div class="recent-address">Ikeja, Lagos</div>
                </div>
                <span class="recent-distance">2.1 km</span>
              </div>
            </div>
          </div>
          
          <!-- Fixed Footer with Start Button -->
          <div class="panel-footer">
            <button class="start-btn" onclick="startTripWithAI()">
              <span>â–¶ï¸</span>
              <span>Start Trip Monitoring</span>
            </button>
          </div>
        </div>
        
        <!-- Active Trip Panel - Collapsible -->
        <div class="trip-panel hidden" id="tripPanel">
          <!-- Collapse Handle -->
          <div class="panel-collapse-handle" onclick="toggleActiveTripPanel()">
            <div class="panel-handle-left">
              <span class="panel-handle-icon">ðŸ</span>
              <div>
                <div class="panel-handle-title" id="tripPanelTitle">To Victoria Island</div>
                <div class="panel-handle-subtitle" id="tripPanelSubtitle">12 min â€¢ 4.2 km</div>
              </div>
            </div>
            <span class="ai-safety-badge" id="tripSafetyBadge">âœ“ Safe Route</span>
            <span class="panel-collapse-arrow">â–²</span>
          </div>
          
          <!-- Expandable Content -->
          <div class="panel-content">
            <div class="trip-destination">
              <div class="trip-icon">ðŸ</div>
              <div class="trip-info">
                <div class="trip-label">Heading to</div>
                <div class="trip-place" id="tripDest">Victoria Island</div>
              </div>
              <div class="trip-progress-ring">
                <svg width="50" height="50">
                  <circle cx="25" cy="25" r="20" stroke="#2C2C2E" stroke-width="4" fill="none"/>
                  <circle cx="25" cy="25" r="20" stroke="#64D2FF" stroke-width="4" fill="none"
                          stroke-dasharray="125.6" stroke-dashoffset="125.6" id="progressRing"
                          transform="rotate(-90 25 25)"/>
                </svg>
                <span id="progressPercent">0%</span>
              </div>
            </div>
            
            <!-- AI Safety Update -->
            <div class="ai-route-analysis" id="tripAiUpdate" style="display:none;">
              <div class="ai-route-header">
                <span class="ai-route-icon">ðŸ¤–</span>
                <span class="ai-route-title">AI Update</span>
              </div>
              <div class="ai-route-body" id="tripAiBody">Route is clear. Stay safe!</div>
            </div>
            
            <div class="trip-stats">
              <div class="trip-stat">
                <div class="trip-stat-value" id="tripDistance">4.2</div>
                <div class="trip-stat-label">km left</div>
              </div>
              <div class="trip-stat">
                <div class="trip-stat-value" id="tripEta">12</div>
                <div class="trip-stat-label">min ETA</div>
              </div>
              <div class="trip-stat">
                <div class="trip-stat-value" id="tripWatchers">3</div>
                <div class="trip-stat-label">watching</div>
              </div>
            </div>
            
            <div class="trip-watchers-list">
              <div class="watcher">
                <div class="watcher-avatar" style="background: linear-gradient(145deg, #3498db, #2980b9)">MA</div>
                <span>Mama</span>
              </div>
              <div class="watcher">
                <div class="watcher-avatar" style="background: linear-gradient(145deg, #FF9F0A, #e08900)">AD</div>
                <span>Alhaji</span>
              </div>
              <div class="watcher">
                <div class="watcher-avatar" style="background: linear-gradient(145deg, #32D74B, #28a745)">ðŸ›¡ï¸</div>
                <span>Security</span>
              </div>
            </div>
            
            <div class="trip-actions">
              <button class="trip-btn secondary" onclick="sendCheckIn()">
                <span>âœ“</span> Check In
              </button>
              <button class="trip-btn danger" onclick="endTrip()">
                <span>â—¼</span> End Trip
              </button>
            </div>
          </div>
        </div>
        
        <div class="toast" id="toast">âœ“ Check-in sent to 3 watchers</div>
      </div>
    </div>
    <!-- =============================================
         HUB SCREEN (Community + History)
         ============================================= -->
    <div class="screen" id="hubScreen">
      <h1 class="page-title-sticky">Hub</h1>
      
      <div class="page-content-sticky">
        <div class="hub-tabs">
          <div class="hub-tab active" onclick="switchHubTab('community')">ðŸš¨ Alerts</div>
          <div class="hub-tab" onclick="switchHubTab('history')">ðŸ“‹ History</div>
        </div>
        
        <!-- Community Content -->
        <div class="hub-content active" id="communityContent">
          <div class="region-filter" id="regionFilter">
            <div class="region-pill active" onclick="filterByRegion('Lagos')">Lagos</div>
            <div class="region-pill" onclick="filterByRegion('Abuja')">Abuja</div>
            <div class="region-pill" onclick="filterByRegion('Kano')">Kano</div>
            <div class="region-pill" onclick="filterByRegion('Rivers')">Rivers</div>
            <div class="region-pill" onclick="filterByRegion('Oyo')">Oyo</div>
            <div class="region-pill" onclick="filterByRegion('Kaduna')">Kaduna</div>
            <div class="region-pill" onclick="filterByRegion('Borno')">Borno</div>
          </div>
          
          <!-- KIDNAPPING ALERT - MORE PROMINENT -->
          <div class="alert-card" style="border: 2px solid rgba(255,55,95,0.5); background: linear-gradient(135deg, rgba(255,55,95,0.15), rgba(255,55,95,0.05));">
            <div class="alert-header">
              <span class="alert-badge kidnap">ðŸš¨ KIDNAPPING</span>
              <span class="alert-region">Lagos - Yaba</span>
              <span class="alert-time">12 min ago</span>
            </div>
            <div class="alert-content" style="color: #FF6B8A;">
              <strong>âš ï¸ URGENT:</strong> Suspected kidnapping attempt reported near University of Lagos main gate. Black Toyota Sienna involved. If you see this vehicle, do NOT approach - call 112 immediately.
          </div>
          <div class="alert-location">
            <span>ðŸ“</span>
            <span>University Road, Akoka, Yaba</span>
          </div>
        </div>
        
        <div class="alert-card">
          <div class="alert-header">
            <span class="alert-badge danger">ðŸš¨ High Alert</span>
            <span class="alert-region">Ikeja</span>
            <span class="alert-time">18 min ago</span>
          </div>
          <div class="alert-content">
            Armed robbery reported near Computer Village. Multiple victims reported. Police have been dispatched.
          </div>
          <div class="alert-location">
            <span>ðŸ“</span>
            <span>Otigba Street, Computer Village</span>
          </div>
        </div>
        
        <div class="alert-card">
          <div class="alert-header">
            <span class="alert-badge warning">âš ï¸ Caution</span>
            <span class="alert-region">Oshodi</span>
            <span class="alert-time">45 min ago</span>
          </div>
          <div class="alert-content">
            Suspicious activity reported under bridge. Police have been notified. Avoid the area if possible.
          </div>
          <div class="alert-location">
            <span>ðŸ“</span>
            <span>Oshodi Under Bridge</span>
          </div>
        </div>
        
        <!-- Another Kidnapping Alert -->
        <div class="alert-card" style="border: 1px solid rgba(255,55,95,0.3);">
          <div class="alert-header">
            <span class="alert-badge kidnap">ðŸš¨ KIDNAPPING</span>
            <span class="alert-region">Kaduna</span>
            <span class="alert-time">2 hours ago</span>
          </div>
          <div class="alert-content">
            Mass abduction reported on Kaduna-Abuja highway. Security agencies responding. Avoid this route until further notice.
          </div>
          <div class="alert-location">
            <span>ðŸ“</span>
            <span>Kaduna-Abuja Expressway, KM 45</span>
          </div>
        </div>
        
        <div class="alert-card">
          <div class="alert-header">
            <span class="alert-badge warning">âš ï¸ Caution</span>
            <span class="alert-region">VI</span>
            <span class="alert-time">1 hour ago</span>
          </div>
          <div class="alert-content">
            Heavy traffic due to VIP movement. Expect delays on Ozumba Mbadiwe Avenue.
          </div>
          <div class="alert-location">
            <span>ðŸ“</span>
            <span>Ozumba Mbadiwe Avenue</span>
          </div>
        </div>
      </div>
      
      <!-- History Content -->
      <div class="hub-content" id="historyContent">
        <div class="history-stats">
          <div class="history-stat">
            <div class="history-stat-value green">47</div>
            <div class="history-stat-label">Days Safe</div>
          </div>
          <div class="history-stat">
            <div class="history-stat-value orange">3</div>
            <div class="history-stat-label">Alerts</div>
          </div>
          <div class="history-stat">
            <div class="history-stat-value blue">12</div>
            <div class="history-stat-label">Trips</div>
          </div>
        </div>
        
        <div class="section-header">
          <span class="section-title">Recent Activity</span>
        </div>
        
        <div class="history-item">
          <div class="history-icon trip">ðŸ“</div>
          <div class="history-info">
            <div class="history-title">Trip to Victoria Island</div>
            <div class="history-meta">Today, 2:30 PM â€¢ 4.2 km</div>
          </div>
          <div class="history-outcome resolved">âœ“ Safe</div>
        </div>
        
        <div class="history-item">
          <div class="history-icon timer">â±ï¸</div>
          <div class="history-info">
            <div class="history-title">Check-In Timer</div>
            <div class="history-meta">Today, 11:00 AM â€¢ 15 min</div>
          </div>
          <div class="history-outcome resolved">âœ“ Checked In</div>
        </div>
        
        <div class="history-item">
          <div class="history-icon sos">ðŸš¨</div>
          <div class="history-info">
            <div class="history-title">Emergency Alert</div>
            <div class="history-meta">Nov 28 â€¢ Ikeja</div>
          </div>
          <div class="history-outcome cancelled">Cancelled</div>
        </div>
        
        <div class="history-item">
          <div class="history-icon report">ðŸ“¢</div>
          <div class="history-info">
            <div class="history-title">Incident Report</div>
            <div class="history-meta">Nov 25 â€¢ Kidnapping Attempt</div>
          </div>
          <div class="history-outcome resolved">âœ“ Submitted</div>
        </div>
        
        <div class="history-item">
          <div class="history-icon trip">ðŸ“</div>
          <div class="history-info">
            <div class="history-title">Trip to Lekki</div>
            <div class="history-meta">Nov 24 â€¢ 8.5 km</div>
          </div>
          <div class="history-outcome resolved">âœ“ Safe</div>
        </div>
      </div>
      </div>
    </div>
    
    <!-- =============================================
         CHECK-IN TIMER SCREEN
         ============================================= -->
    <div class="screen" id="checkinScreen">
      <div class="status-bar">
        <span id="time5">9:41</span>
        <span>ðŸ“¶ ðŸ“ ðŸ”‹</span>
      </div>
      
      <div class="screen-header">
        <div class="back-btn" onclick="switchScreen('homeScreen')">
          <span>â€¹</span>
          <span>Home</span>
        </div>
      </div>
      
      <h1 class="page-title" style="padding: 0 20px;">Check-In Timer</h1>
      
      <!-- Inactive State -->
      <div id="checkinSetup">
        <div class="checkin-intro">
          <div class="checkin-intro-icon">â±ï¸</div>
          <p>Set a timer. If you don't check in before it expires, your emergency contacts will be alerted automatically.</p>
        </div>
        
        <div class="section-header">
          <span class="section-title">Select Duration</span>
        </div>
        
        <div class="duration-grid">
          <div class="duration-option" onclick="selectDuration(15, this)">
            <span class="duration-value">15</span>
            <span class="duration-unit">min</span>
          </div>
          <div class="duration-option selected" onclick="selectDuration(30, this)">
            <span class="duration-value">30</span>
            <span class="duration-unit">min</span>
          </div>
          <div class="duration-option" onclick="selectDuration(60, this)">
            <span class="duration-value">1</span>
            <span class="duration-unit">hour</span>
          </div>
          <div class="duration-option" onclick="selectDuration(120, this)">
            <span class="duration-value">2</span>
            <span class="duration-unit">hours</span>
          </div>
        </div>
        
        <div class="custom-duration">
          <span>Custom:</span>
          <input type="number" id="customMinutes" placeholder="45" min="5" max="480">
          <span>minutes</span>
          <button class="custom-set-btn" onclick="setCustomDuration()">Set</button>
        </div>
        
        <div class="section-header">
          <span class="section-title">What are you doing? (Optional)</span>
        </div>
        
        <div class="reason-chips">
          <div class="reason-chip" onclick="selectReason('Walking home', this)">ðŸš¶ Walking home</div>
          <div class="reason-chip" onclick="selectReason('Meeting someone', this)">ðŸ¤ Meeting someone</div>
          <div class="reason-chip" onclick="selectReason('Night outing', this)">ðŸŒ™ Night outing</div>
          <div class="reason-chip" onclick="selectReason('Traveling', this)">ðŸš— Traveling</div>
          <div class="reason-chip" onclick="selectReason('At ATM', this)">ðŸ§ At ATM</div>
          <div class="reason-chip" onclick="selectReason('Other', this)">ðŸ“ Other</div>
        </div>
        
        <div class="reason-input-wrap" id="reasonInputWrap" style="display:none;">
          <input type="text" id="customReason" placeholder="Describe your activity...">
        </div>
        
        <div class="section-header">
          <span class="section-title">Will notify if you don't check in</span>
        </div>
        
        <div class="notify-contacts">
          <div class="notify-contact">
            <div class="notify-avatar" style="background: linear-gradient(145deg, #3498db, #2980b9)">MA</div>
            <span>Mama</span>
          </div>
          <div class="notify-contact">
            <div class="notify-avatar" style="background: linear-gradient(145deg, #FF9F0A, #e08900)">AD</div>
            <span>Alhaji</span>
          </div>
          <div class="notify-contact">
            <div class="notify-avatar" style="background: linear-gradient(145deg, #32D74B, #28a745)">ðŸ›¡ï¸</div>
            <span>Security</span>
          </div>
        </div>
        
        <button class="checkin-start-btn" onclick="startCheckinTimer()">
          <span>â–¶ï¸</span>
          <span>Start Timer</span>
        </button>
      </div>
      
      <!-- Active Timer State -->
      <div id="checkinActive" style="display:none;">
        <div class="timer-display">
          <div class="timer-ring">
            <svg width="200" height="200">
              <circle cx="100" cy="100" r="90" stroke="#2C2C2E" stroke-width="8" fill="none"/>
              <circle cx="100" cy="100" r="90" stroke="#FF9F0A" stroke-width="8" fill="none"
                      stroke-dasharray="565" stroke-dashoffset="0" id="timerRing"
                      stroke-linecap="round" transform="rotate(-90 100 100)"/>
            </svg>
            <div class="timer-center">
              <div class="timer-time" id="timerDisplay">30:00</div>
              <div class="timer-label">remaining</div>
            </div>
          </div>
        </div>
        
        <div class="timer-reason" id="timerReasonDisplay">
          <span>ðŸš¶</span>
          <span id="activeReason">Walking home</span>
        </div>
        
        <div class="timer-warning">
          <span>âš ï¸</span>
          <span>If you don't check in, 3 contacts will be alerted</span>
        </div>
        
        <button class="checkin-confirm-btn" id="checkinConfirmBtn" onclick="confirmCheckin()">
          <span class="checkin-icon">âœ“</span>
          <span>I'm Safe - Check In</span>
        </button>
        
        <div class="timer-actions">
          <button class="timer-action-btn" onclick="extendTimer()">
            <span>+5</span>
            <span>Add 5 min</span>
          </button>
          <button class="timer-action-btn" onclick="extendTimer(15)">
            <span>+15</span>
            <span>Add 15 min</span>
          </button>
          <button class="timer-action-btn danger" onclick="cancelCheckinTimer()">
            <span>âœ•</span>
            <span>Cancel</span>
          </button>
        </div>
      </div>
      
      <!-- Timer Expired State -->
      <div id="checkinExpired" style="display:none;">
        <div class="expired-display">
          <div class="expired-icon">ðŸš¨</div>
          <h2 class="expired-title">Timer Expired!</h2>
          <p class="expired-text">You didn't check in. Emergency alerts are being sent to your contacts.</p>
          
          <div class="expired-countdown">
            <span>Sending alerts in</span>
            <span class="expired-seconds" id="expiredSeconds">10</span>
            <span>seconds</span>
          </div>
          
          <button class="checkin-safe-btn" onclick="imSafeCancel()">
            <span>âœ“</span>
            <span>I'm Safe - Cancel Alert</span>
          </button>
        </div>
      </div>
    </div>
    <!-- =============================================
         EVIDENCE RECORDER SCREEN
         ============================================= -->
    <div class="screen" id="recordScreen">
      <div class="status-bar">
        <span id="time6">9:41</span>
        <span>ðŸ“¶ ðŸ“ ðŸ”‹</span>
      </div>
      
      <div class="screen-header">
        <div class="back-btn" onclick="switchScreen('homeScreen')">
          <span>â€¹</span>
          <span>Home</span>
        </div>
        <div class="stealth-toggle" onclick="toggleStealthMode()">
          <span id="stealthIcon">ðŸ‘ï¸</span>
          <span id="stealthLabel">Stealth</span>
        </div>
      </div>
      
      <h1 class="page-title" style="padding: 0 20px;">Evidence Recorder</h1>
      
      <!-- Recorder Inactive State -->
      <div id="recorderSetup">
        <div class="recorder-intro">
          <div class="recorder-intro-icon">ðŸŽ™ï¸</div>
          <p>Record audio or video evidence. Files are automatically saved and can be sent to your emergency contacts.</p>
        </div>
        
        <div class="record-type-toggle">
          <div class="record-type active" id="audioType" onclick="selectRecordType('audio')">
            <span>ðŸŽ¤</span>
            <span>Audio</span>
          </div>
          <div class="record-type" id="videoType" onclick="selectRecordType('video')">
            <span>ðŸ“¹</span>
            <span>Video</span>
          </div>
        </div>
        
        <div class="section-header">
          <span class="section-title">Quality</span>
        </div>
        
        <div class="quality-options">
          <div class="quality-option" onclick="selectQuality('low', this)">
            <span class="quality-name">Low</span>
            <span class="quality-desc">~1MB/min â€¢ Longer recording</span>
          </div>
          <div class="quality-option selected" onclick="selectQuality('medium', this)">
            <span class="quality-name">Medium</span>
            <span class="quality-desc">~3MB/min â€¢ Balanced</span>
          </div>
          <div class="quality-option" onclick="selectQuality('high', this)">
            <span class="quality-name">High</span>
            <span class="quality-desc">~8MB/min â€¢ Best clarity</span>
          </div>
        </div>
        
        <div class="section-header">
          <span class="section-title">Auto Actions</span>
        </div>
        
        <div class="auto-settings">
          <div class="auto-setting">
            <div class="auto-setting-info">
              <span class="auto-setting-icon">â˜ï¸</span>
              <div>
                <div class="auto-setting-label">Auto-Upload</div>
                <div class="auto-setting-desc">Save to secure cloud immediately</div>
              </div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="autoUpload" checked>
              <span class="toggle-slider"></span>
            </label>
          </div>
          <div class="auto-setting">
            <div class="auto-setting-info">
              <span class="auto-setting-icon">ðŸ“¤</span>
              <div>
                <div class="auto-setting-label">Send to Contacts</div>
                <div class="auto-setting-desc">Share with emergency contacts when done</div>
              </div>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="autoSend">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        
        <div class="storage-info">
          <div class="storage-bar">
            <div class="storage-used" style="width: 35%"></div>
          </div>
          <div class="storage-text">
            <span>1.2 GB used</span>
            <span>2 GB available</span>
          </div>
        </div>
        
        <button class="record-start-btn" onclick="startRecording()">
          <div class="record-btn-icon">âº</div>
          <span>Start Recording</span>
        </button>
        
        <div class="section-header" style="margin-top: 20px;">
          <span class="section-title">Recent Recordings</span>
          <span class="section-action" onclick="viewAllRecordings()">See All</span>
        </div>
        
        <div class="recordings-list" id="recordingsList">
          <div class="recording-item">
            <div class="recording-icon audio">ðŸŽ¤</div>
            <div class="recording-info">
              <div class="recording-name">Audio Recording</div>
              <div class="recording-meta">Today, 2:45 PM â€¢ 3:24</div>
            </div>
            <div class="recording-status uploaded">â˜ï¸</div>
            <div class="recording-actions">
              <span onclick="playRecording(1)">â–¶ï¸</span>
              <span onclick="shareRecording(1)">ðŸ“¤</span>
            </div>
          </div>
          <div class="recording-item">
            <div class="recording-icon video">ðŸ“¹</div>
            <div class="recording-info">
              <div class="recording-name">Video Recording</div>
              <div class="recording-meta">Yesterday â€¢ 1:12</div>
            </div>
            <div class="recording-status uploaded">â˜ï¸</div>
            <div class="recording-actions">
              <span onclick="playRecording(2)">â–¶ï¸</span>
              <span onclick="shareRecording(2)">ðŸ“¤</span>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Active Recording State -->
      <div id="recorderActive" style="display:none;">
        <div class="recording-display">
          <div class="recording-indicator">
            <div class="rec-dot"></div>
            <span>REC</span>
          </div>
          
          <div class="recording-timer" id="recordingTimer">00:00</div>
          
          <div class="waveform-container" id="waveformContainer">
            <div class="waveform">
              <div class="wave-bar" style="height: 20%"></div>
              <div class="wave-bar" style="height: 45%"></div>
              <div class="wave-bar" style="height: 70%"></div>
              <div class="wave-bar" style="height: 55%"></div>
              <div class="wave-bar" style="height: 85%"></div>
              <div class="wave-bar" style="height: 60%"></div>
              <div class="wave-bar" style="height: 40%"></div>
              <div class="wave-bar" style="height: 75%"></div>
              <div class="wave-bar" style="height: 50%"></div>
              <div class="wave-bar" style="height: 65%"></div>
              <div class="wave-bar" style="height: 30%"></div>
              <div class="wave-bar" style="height: 80%"></div>
              <div class="wave-bar" style="height: 45%"></div>
              <div class="wave-bar" style="height: 60%"></div>
              <div class="wave-bar" style="height: 35%"></div>
              <div class="wave-bar" style="height: 70%"></div>
              <div class="wave-bar" style="height: 55%"></div>
              <div class="wave-bar" style="height: 40%"></div>
              <div class="wave-bar" style="height: 65%"></div>
              <div class="wave-bar" style="height: 50%"></div>
            </div>
          </div>
          
          <div class="video-preview" id="videoPreview" style="display:none;">
            <div class="video-placeholder">
              <span>ðŸ“¹</span>
              <span>Camera Active</span>
            </div>
          </div>
          
          <div class="recording-meta-info">
            <div class="meta-item">
              <span class="meta-label">Type</span>
              <span class="meta-value" id="recTypeDisplay">Audio</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Quality</span>
              <span class="meta-value" id="recQualityDisplay">Medium</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Size</span>
              <span class="meta-value" id="recSizeDisplay">0 KB</span>
            </div>
          </div>
          
          <div class="upload-status" id="uploadStatus">
            <div class="upload-icon">â˜ï¸</div>
            <span>Uploading to secure cloud...</span>
            <div class="upload-progress">
              <div class="upload-progress-bar" id="uploadProgressBar"></div>
            </div>
          </div>
        </div>
        
        <div class="recording-controls">
          <button class="rec-control-btn pause" id="pauseBtn" onclick="togglePauseRecording()">
            <span>â¸</span>
            <span>Pause</span>
          </button>
          <button class="rec-control-btn stop" onclick="stopRecording()">
            <span>â¹</span>
            <span>Stop</span>
          </button>
          <button class="rec-control-btn send" onclick="sendRecordingNow()">
            <span>ðŸ“¤</span>
            <span>Send</span>
          </button>
        </div>
        
        <div class="rec-emergency-note">
          <span>ðŸ”’</span>
          <span>Recording is being saved. Even if app closes, your evidence is protected.</span>
        </div>
      </div>
      
      <!-- Recording Complete State -->
      <div id="recorderComplete" style="display:none;">
        <div class="complete-display">
          <div class="complete-icon">âœ…</div>
          <h2 class="complete-title">Recording Saved</h2>
          
          <div class="complete-preview">
            <div class="preview-icon" id="completePreviewIcon">ðŸŽ¤</div>
            <div class="preview-info">
              <div class="preview-duration" id="completeDuration">3:24</div>
              <div class="preview-size" id="completeSize">10.2 MB</div>
            </div>
            <button class="preview-play" onclick="playLastRecording()">â–¶ï¸</button>
          </div>
          
          <div class="complete-status">
            <div class="status-item success">
              <span>â˜ï¸</span>
              <span>Uploaded to cloud</span>
            </div>
            <div class="status-item" id="sentStatus" style="display:none;">
              <span>ðŸ“¤</span>
              <span>Sent to contacts</span>
            </div>
          </div>
          
          <div class="complete-actions">
            <button class="complete-btn primary" onclick="sendToContacts()">
              <span>ðŸ“¤</span>
              <span>Send to Contacts</span>
            </button>
            <button class="complete-btn secondary" onclick="newRecording()">
              <span>ðŸŽ™ï¸</span>
              <span>New Recording</span>
            </button>
          </div>
          
          <button class="complete-done-btn" onclick="switchScreen('homeScreen')">Done</button>
        </div>
      </div>
    </div>
    
    <!-- =============================================
         REPORT INCIDENT SCREEN
         ============================================= -->
    <div class="screen" id="reportScreen">
      <div class="status-bar">
        <span id="time7">9:41</span>
        <span>ðŸ“¶ ðŸ“ ðŸ”‹</span>
      </div>
      
      <div class="screen-header">
        <div class="back-btn" onclick="switchScreen('homeScreen')">
          <span>â€¹</span>
          <span>Home</span>
        </div>
      </div>
      
      <h1 class="page-title" style="padding: 0 20px;">Report Security Threat</h1>
      
      <!-- Emergency Hotlines Banner -->
      <div class="emergency-hotlines">
        <div class="hotline-header">
          <span>ðŸ†˜</span>
          <span>Emergency? Call Now:</span>
        </div>
        <div class="hotline-numbers">
          <a href="tel:112" class="hotline-btn">
            <span>ðŸ“ž</span>
            <span>112</span>
          </a>
          <a href="tel:199" class="hotline-btn">
            <span>ðŸš”</span>
            <span>199</span>
          </a>
          <a href="tel:08032003913" class="hotline-btn nscdc">
            <span>ðŸ›¡ï¸</span>
            <span>NSCDC</span>
          </a>
        </div>
      </div>
      
      <!-- Report Form -->
      <div id="reportForm" style="padding: 0 20px 40px;">
        <div class="section-header">
          <span class="section-title">What happened?</span>
        </div>
        
        <div class="incident-types">
          <!-- KIDNAPPING - MORE PROMINENT - First Row -->
          <div class="incident-type urgent" onclick="selectIncidentType('kidnapping', this)">
            <span class="incident-icon">ðŸš¨</span>
            <span class="incident-label">Kidnapping</span>
          </div>
          <div class="incident-type urgent" onclick="selectIncidentType('terrorist', this)">
            <span class="incident-icon">ðŸ’£</span>
            <span class="incident-label">Terrorist Activity</span>
          </div>
          <div class="incident-type urgent" onclick="selectIncidentType('gunmen', this)">
            <span class="incident-icon">ðŸ”«</span>
            <span class="incident-label">Gunmen/Bandits</span>
          </div>
          <div class="incident-type urgent" onclick="selectIncidentType('onechance', this)">
            <span class="incident-icon">ðŸš</span>
            <span class="incident-label">One Chance</span>
          </div>
          <div class="incident-type" onclick="selectIncidentType('missing', this)">
            <span class="incident-icon">ðŸ”</span>
            <span class="incident-label">Missing Person</span>
          </div>
          <div class="incident-type" onclick="selectIncidentType('checkpoint', this)">
            <span class="incident-icon">ðŸš§</span>
            <span class="incident-label">Illegal Checkpoint</span>
          </div>
          <div class="incident-type" onclick="selectIncidentType('cultist', this)">
            <span class="incident-icon">âš”ï¸</span>
            <span class="incident-label">Cultist/Gang</span>
          </div>
          <div class="incident-type" onclick="selectIncidentType('robbery', this)">
            <span class="incident-icon">ðŸ’°</span>
            <span class="incident-label">Armed Robbery</span>
          </div>
          <div class="incident-type" onclick="selectIncidentType('herdsmen', this)">
            <span class="incident-icon">ðŸ„</span>
            <span class="incident-label">Herdsmen Attack</span>
          </div>
          <div class="incident-type" onclick="selectIncidentType('explosion', this)">
            <span class="incident-icon">ðŸ’¥</span>
            <span class="incident-label">Explosion/IED</span>
          </div>
          <div class="incident-type" onclick="selectIncidentType('shooting', this)">
            <span class="incident-icon">ðŸŽ¯</span>
            <span class="incident-label">Shooting</span>
          </div>
          <div class="incident-type" onclick="selectIncidentType('other', this)">
            <span class="incident-icon">ðŸ“</span>
            <span class="incident-label">Other Threat</span>
          </div>
        </div>
        
        <div class="section-header">
          <span class="section-title">Urgency Level</span>
        </div>
        
        <div class="severity-options">
          <div class="severity-option low" onclick="selectSeverity('low', this)">
            <span class="severity-dot"></span>
            <span>Past</span>
            <span class="severity-desc">Already happened</span>
          </div>
          <div class="severity-option medium selected" onclick="selectSeverity('medium', this)">
            <span class="severity-dot"></span>
            <span>Active</span>
            <span class="severity-desc">Happening now</span>
          </div>
          <div class="severity-option high" onclick="selectSeverity('high', this)">
            <span class="severity-dot"></span>
            <span>DANGER</span>
            <span class="severity-desc">Life at risk</span>
          </div>
        </div>
        
        <div class="section-header">
          <span class="section-title">Location</span>
        </div>
        
        <div class="location-input-group">
          <div class="location-current" onclick="useCurrentLocation()">
            <span class="location-icon">ðŸ“</span>
            <div class="location-info">
              <div class="location-label" id="currentLocationLabel">Use Current Location</div>
              <div class="location-address" id="currentLocationAddress">Tap to detect your location</div>
            </div>
            <span class="location-check" id="locationCheck" style="display:none;">âœ“</span>
          </div>
          
          <div class="location-divider">
            <span>or enter manually</span>
          </div>
          
          <input type="text" class="location-manual-input" id="manualLocation" placeholder="e.g., Computer Village, Ikeja" oninput="onManualLocationInput()">
        </div>
        
        <div class="section-header">
          <span class="section-title">Description</span>
        </div>
        
        <textarea class="report-description" id="reportDescription" placeholder="Describe what you saw: number of attackers, weapons, vehicles (color, plate numbers), direction of movement, victim descriptions, etc." rows="4"></textarea>
        
        <div class="section-header">
          <span class="section-title">Attach Evidence (Optional)</span>
        </div>
        
        <div class="evidence-attach">
          <div class="evidence-option" onclick="attachPhoto()">
            <span>ðŸ“·</span>
            <span>Photo</span>
          </div>
          <div class="evidence-option" onclick="attachRecording()">
            <span>ðŸŽ™ï¸</span>
            <span>Recording</span>
          </div>
          <div class="evidence-option" onclick="attachVideo()">
            <span>ðŸ“¹</span>
            <span>Video</span>
          </div>
        </div>
        
        <div class="attached-files" id="attachedFiles" style="display:none;"></div>
        
        <div class="anonymous-toggle">
          <div class="anonymous-info">
            <span class="anonymous-icon">ðŸŽ­</span>
            <div>
              <div class="anonymous-label">Report Anonymously</div>
              <div class="anonymous-desc">Your identity will be hidden from the community</div>
            </div>
          </div>
          <label class="toggle-switch">
            <input type="checkbox" id="anonymousToggle" checked>
            <span class="toggle-slider"></span>
          </label>
        </div>
        
        <button class="report-submit-btn" onclick="submitReport()">
          <span>ðŸ“¢</span>
          <span>Submit Report</span>
        </button>
        
        <p class="report-disclaimer" style="margin-bottom: 30px;">Your report helps protect lives. False reports waste emergency resources and may result in legal action.</p>
      </div>
      
      <!-- Report Submitted State -->
      <div id="reportSubmitted" style="display:none;">
        <div class="submitted-display">
          <div class="submitted-icon">âœ…</div>
          <h2 class="submitted-title">Report Submitted</h2>
          <p class="submitted-text">Your report is being shared with security agencies and the community. This could save lives.</p>
          
          <div class="submitted-card">
            <div class="submitted-card-header">
              <span class="submitted-type-icon" id="submittedTypeIcon">ðŸ”«</span>
              <div>
                <div class="submitted-type" id="submittedType">Armed Robbery</div>
                <div class="submitted-location" id="submittedLocation">Computer Village, Ikeja</div>
              </div>
              <span class="submitted-severity" id="submittedSeverity">High</span>
            </div>
            <div class="submitted-desc" id="submittedDesc">Incident description will appear here...</div>
            <div class="submitted-meta">
              <span>ðŸ• Just now</span>
              <span id="submittedAnon">ðŸŽ­ Anonymous</span>
            </div>
          </div>
          
          <div class="submitted-stats">
            <div class="stat-item">
              <span class="stat-value">2,847</span>
              <span class="stat-label">People will see this</span>
            </div>
            <div class="stat-item">
              <span class="stat-value">~5 min</span>
              <span class="stat-label">Review time</span>
            </div>
          </div>
          
          <div class="submitted-actions">
            <button class="submitted-btn primary" onclick="shareReport()">
              <span>ðŸ“¤</span>
              <span>Share to WhatsApp</span>
            </button>
            <button class="submitted-btn secondary" onclick="newReport()">
              <span>ðŸ“¢</span>
              <span>New Report</span>
            </button>
          </div>
          
          <button class="submitted-done-btn" onclick="switchScreen('homeScreen')">Done</button>
        </div>
      </div>
    </div>
    <!-- =============================================
         SETTINGS SCREEN
         ============================================= -->
    <div class="screen" id="settingsScreen">
      <h1 class="page-title-sticky">Settings</h1>
      
      <div class="page-content-sticky">
        <div class="settings-group">
          <div class="settings-group-title">Account</div>
          <div class="settings-item" onclick="openSettingsSubScreen('personalInfo')">
            <div class="settings-icon" style="background: rgba(100,210,255,0.15)">ðŸ‘¤</div>
            <div class="settings-info">
              <div class="settings-label">Personal Info</div>
              <div class="settings-desc">Name, phone, location</div>
            </div>
            <span class="settings-arrow">â€º</span>
          </div>
          <div class="settings-item" onclick="openSettingsSubScreen('emergencyContacts')">
            <div class="settings-icon" style="background: rgba(50,215,75,0.15)">ðŸ‘¥</div>
            <div class="settings-info">
              <div class="settings-label">Emergency Contacts</div>
              <div class="settings-desc">3 contacts saved</div>
            </div>
            <span class="settings-arrow">â€º</span>
          </div>
          <div class="settings-item" onclick="openSettingsSubScreen('premium')">
            <div class="settings-icon" style="background: rgba(191,90,242,0.15)">â­</div>
            <div class="settings-info">
              <div class="settings-label">SafeAlert Premium</div>
              <div class="settings-desc">Unlock all features</div>
            </div>
            <span class="settings-arrow">â€º</span>
          </div>
        </div>
        
        <div class="settings-group">
          <div class="settings-group-title">Preferences</div>
          <div class="settings-item" onclick="openSettingsSubScreen('language')">
            <div class="settings-icon" style="background: rgba(255,159,10,0.15)">ðŸŒ</div>
            <div class="settings-info">
              <div class="settings-label">Language</div>
              <div class="settings-desc" id="currentLangDisplay">English</div>
            </div>
            <span class="settings-arrow">â€º</span>
          </div>
          <div class="settings-item" onclick="openSettingsSubScreen('notifications')">
            <div class="settings-icon" style="background: rgba(100,210,255,0.15)">ðŸ””</div>
            <div class="settings-info">
              <div class="settings-label">Notifications</div>
              <div class="settings-desc">Alerts, check-ins, updates</div>
            </div>
            <span class="settings-arrow">â€º</span>
          </div>
          <div class="settings-item" onclick="openSettingsSubScreen('locationSettings')">
            <div class="settings-icon" style="background: rgba(50,215,75,0.15)">ðŸ“</div>
            <div class="settings-info">
              <div class="settings-label">Location Settings</div>
              <div class="settings-desc">Background tracking enabled</div>
            </div>
            <span class="settings-arrow">â€º</span>
          </div>
        </div>
        
        <div class="settings-group">
          <div class="settings-group-title">Security</div>
          <div class="settings-item" onclick="openSettingsSubScreen('sosSettings')">
            <div class="settings-icon" style="background: rgba(255,55,95,0.15)">ðŸš¨</div>
            <div class="settings-info">
              <div class="settings-label">SOS Settings</div>
              <div class="settings-desc">Hold duration, auto-call</div>
            </div>
            <span class="settings-arrow">â€º</span>
          </div>
          <div class="settings-item" onclick="openSettingsSubScreen('safeWord')">
            <div class="settings-icon" style="background: rgba(255,159,10,0.15)">ðŸ”</div>
            <div class="settings-info">
              <div class="settings-label">Safe Word</div>
              <div class="settings-desc">Trigger SOS by voice</div>
            </div>
            <span class="settings-arrow">â€º</span>
          </div>
        </div>
        
        <div class="settings-group">
          <div class="settings-group-title">About</div>
          <div class="settings-item" onclick="openSettingsSubScreen('howItWorks')">
            <div class="settings-icon" style="background: rgba(100,210,255,0.15)">ðŸ“–</div>
            <div class="settings-info">
              <div class="settings-label">How SafeAlert Works</div>
            </div>
            <span class="settings-arrow">â€º</span>
          </div>
          <div class="settings-item" onclick="openSettingsSubScreen('privacy')">
            <div class="settings-icon" style="background: rgba(191,90,242,0.15)">ðŸ”’</div>
            <div class="settings-info">
              <div class="settings-label">Privacy Policy</div>
              <div class="settings-desc">NDPR Compliant</div>
            </div>
            <span class="settings-arrow">â€º</span>
          </div>
          <div class="settings-item" onclick="openSettingsSubScreen('terms')">
            <div class="settings-icon" style="background: rgba(142,142,147,0.15)">ðŸ“„</div>
            <div class="settings-info">
              <div class="settings-label">Terms of Service</div>
            </div>
            <span class="settings-arrow">â€º</span>
          </div>
          <div class="settings-item" onclick="openSettingsSubScreen('support')">
            <div class="settings-icon" style="background: rgba(50,215,75,0.15)">ðŸ’¬</div>
            <div class="settings-info">
              <div class="settings-label">Contact Support</div>
              <div class="settings-desc">Get help 24/7</div>
            </div>
            <span class="settings-arrow">â€º</span>
          </div>
        </div>
        
        <div class="footer" style="padding: 20px;">
          <div class="footer-badge">
            ðŸ‡³ðŸ‡¬ SafeAlert v1.0 â€¢ Made in Nigeria
          </div>
        </div>
      </div>
    </div>
    
    <!-- Settings Sub-Screen (slides over) -->
    <div class="settings-subscreen" id="settingsSubScreen">
      <div class="status-bar">
        <span>9:41</span>
        <span>ðŸ“¶ ðŸ“ ðŸ”‹</span>
      </div>
      <div class="screen-header">
        <div class="back-btn" onclick="closeSettingsSubScreen()">
          <span>â€¹</span>
          <span>Settings</span>
        </div>
      </div>
      <h1 class="page-title" id="subScreenTitle" style="padding: 0 20px;">Title</h1>
      <div class="settings-subscreen-content" id="subScreenContent">
        <!-- Dynamic content loaded here -->
      </div>
    </div>
    
    <!-- =============================================
         AI ASSISTANT SCREEN (Powered by Claude)
         ============================================= -->
    <div class="screen" id="aiScreen">
      <div class="ai-header">
        <div class="ai-avatar">ðŸ¤–</div>
        <div class="ai-info">
          <h2>SafeAlert AI</h2>
          <p><span class="ai-powered-badge">Powered by Claude</span></p>
        </div>
        <div class="ai-header-actions">
          <div class="ai-new-chat" onclick="resetAIChat()" title="New Chat">ðŸ”„</div>
          <div class="ai-close" onclick="switchScreen('homeScreen')">âœ•</div>
        </div>
      </div>
      
      <div class="ai-chat-container" id="aiChatContainer">
        <div class="ai-message assistant">
          ðŸ‘‹ Hello! I'm your <strong>AI-powered</strong> safety assistant. I use real artificial intelligence to help you:
          <br><br>
          ðŸ§  <strong>Understand your situation</strong> - I analyze context, time, and location
          <br>
          ðŸŽ¯ <strong>Give personalized advice</strong> - Not pre-written scripts, real AI thinking
          <br>
          ðŸ“Š <strong>Assess risks</strong> - Based on current alerts and patterns
          <br>
          ðŸ—£ï¸ <strong>Parse voice reports</strong> - Speak naturally, I'll understand
          <br><br>
          <span id="aiWelcomeText">How can I help you stay safe today?</span>
          
          <div class="ai-quick-actions" id="aiQuickActions">
            <button class="ai-quick-btn" onclick="askAI('Someone is following me, what should I do?')">Someone following me</button>
            <button class="ai-quick-btn" onclick="askAI('Is Ikeja safe right now?')">Is this area safe?</button>
            <button class="ai-quick-btn" onclick="askAI('What should I do if I get into a one-chance vehicle?')">One-chance advice</button>
            <button class="ai-quick-btn" onclick="askAI('Help me report a kidnapping attempt')">Report incident</button>
          </div>
        </div>
      </div>
      
      <div class="ai-input-area">
        <div class="ai-input-wrap">
          <input type="text" id="aiChatInput" placeholder="Ask me anything about safety..." onkeypress="if(event.key==='Enter')sendAIMessage()">
          <button class="ai-voice-btn" id="aiVoiceBtn" onclick="toggleAIVoice()">ðŸŽ¤</button>
          <button class="ai-send-btn" onclick="sendAIMessage()">âž¤</button>
        </div>
      </div>
    </div>
    
  </div><!-- End .app -->
  
  <!-- =============================================
       AI FLOATING BUTTON
       ============================================= -->
  <button class="ai-float-btn" id="aiFloatBtn" onclick="toggleVoiceSOS()">
    ðŸ¤–
    <div class="ai-status">âœ“</div>
  </button>
  
  <!-- =============================================
       BOTTOM NAVIGATION
       ============================================= -->
  <nav class="bottom-nav">
    <div class="nav-item active" onclick="switchScreen('homeScreen')" id="navHome">
      <span class="nav-icon">ðŸ </span>
      <span class="nav-label">Home</span>
    </div>
    <div class="nav-item" onclick="switchScreen('mapScreen')" id="navMap">
      <span class="nav-icon">ðŸ—ºï¸</span>
      <span class="nav-label">Map</span>
    </div>
    <div class="nav-item" onclick="switchScreen('hubScreen')" id="navHub">
      <span class="nav-icon">ðŸ“Š</span>
      <span class="nav-label">Hub</span>
    </div>
    <div class="nav-item" onclick="switchScreen('settingsScreen')" id="navSettings">
      <span class="nav-icon">âš™ï¸</span>
      <span class="nav-label">Settings</span>
    </div>
  </nav>
  
  <!-- =============================================
       MODAL DIALOGS
       ============================================= -->
  <div class="modal" id="modal">
    <div class="modal-box" id="modalBox">
      <!-- Dynamic modal content -->
    </div>
  </div>
  
  <!-- SOS Countdown Modal -->
  <div class="modal" id="sosModal">
    <div class="modal-box">
      <div class="modal-icon">ðŸš¨</div>
      <div class="modal-title">Emergency Alert</div>
      <div class="modal-text">Sending SOS in...</div>
      <div class="countdown" id="sosCountdown">3</div>
      <div class="modal-btns">
        <button class="modal-btn cancel" onclick="cancelSOS()">Cancel</button>
        <button class="modal-btn send" onclick="sendSOSNow()">Send Now</button>
      </div>
    </div>
  </div>
  
  <!-- Emergency Active Modal -->
  <div class="modal" id="emergencyActiveModal">
    <div class="modal-box">
      <div class="modal-icon">âœ…</div>
      <div class="modal-title">Alert Sent!</div>
      <div class="modal-text">GPS location sent to:</div>
      <div class="sent">
        <span class="sent-icon">ðŸ“±</span>
        <div>
          <div class="sent-name">Mama</div>
          <div class="sent-status">âœ“ SMS + Call</div>
        </div>
      </div>
      <div class="sent">
        <span class="sent-icon">ðŸ </span>
        <div>
          <div class="sent-name">Alhaji Danfodio</div>
          <div class="sent-status">âœ“ SMS sent</div>
        </div>
      </div>
      <div class="sent">
        <span class="sent-icon">ðŸ›¡ï¸</span>
        <div>
          <div class="sent-name">Area Security</div>
          <div class="sent-status">âœ“ SMS sent</div>
        </div>
      </div>
      <button class="modal-btn done" onclick="closeEmergencyModal()">Continue Tracking</button>
      <button class="modal-btn end-emergency" onclick="endEmergency()">I'm Safe - End Emergency</button>
    </div>
  </div>
  
  <!-- Language Selector Modal -->
  <div class="modal" id="languageModal">
    <div class="modal-box" style="max-width: 360px; text-align: left;">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="font-size: 22px; font-weight: 700;">ðŸŒ Select Language</h2>
        <span onclick="closeLanguageModal()" style="cursor: pointer; font-size: 24px; color: #8E8E93;">âœ•</span>
      </div>
      
      <div class="language-option selected" data-lang="english" onclick="selectLanguage('english')">
        <span class="language-flag">ðŸ‡¬ðŸ‡§</span>
        <span class="language-name">English</span>
        <span class="language-check">âœ“</span>
      </div>
      
      <div class="language-option" data-lang="yoruba" onclick="selectLanguage('yoruba')">
        <span class="language-flag">ðŸ‡³ðŸ‡¬</span>
        <span class="language-name">YorÃ¹bÃ¡</span>
        <span class="language-check">âœ“</span>
      </div>
      
      <div class="language-option" data-lang="igbo" onclick="selectLanguage('igbo')">
        <span class="language-flag">ðŸ‡³ðŸ‡¬</span>
        <span class="language-name">Igbo</span>
        <span class="language-check">âœ“</span>
      </div>
      
      <div class="language-option" data-lang="hausa" onclick="selectLanguage('hausa')">
        <span class="language-flag">ðŸ‡³ðŸ‡¬</span>
        <span class="language-name">Hausa</span>
        <span class="language-check">âœ“</span>
      </div>
      
      <div class="language-option" data-lang="pidgin" onclick="selectLanguage('pidgin')">
        <span class="language-flag">ðŸ‡³ðŸ‡¬</span>
        <span class="language-name">Pidgin</span>
        <span class="language-check">âœ“</span>
      </div>
      
      <p style="margin-top: 16px; font-size: 13px; color: #8E8E93; text-align: center;">
        AI Assistant will respond in your selected language
      </p>
    </div>
  </div>
  
  <!-- Toast Notification -->
  <div class="toast" id="globalToast"></div>
  <script>
    // =============================================
    // GLOBAL VARIABLES
    // =============================================
    var currentScreen = 'homeScreen';
    var emergency = false;
    var holding = false;
    var countdown = 3;
    var sosTimer = null;
    var selectedState = 'Lagos';
    var selectedCity = 'Ikeja';
    
    // Language settings
    var currentLanguage = 'english';
    var languageConfig = {
      english: {
        code: 'en',
        name: 'English',
        flag: 'ðŸ‡¬ðŸ‡§',
        greeting: 'Hello! How can I help keep you safe?',
        aiInstruction: 'Respond in English.',
        voiceCode: 'en-US'
      },
      yoruba: {
        code: 'yo',
        name: 'YorÃ¹bÃ¡',
        flag: 'ðŸ‡³ðŸ‡¬',
        greeting: 'E kaaro! Bawo ni mo á¹£e le ran yin lá»wá»?',
        aiInstruction: 'Respond in Yoruba (YorÃ¹bÃ¡ language). Use Yoruba greetings, expressions, and cultural context. Write in Yoruba with proper tone marks where possible.',
        voiceCode: 'yo-NG'
      },
      igbo: {
        code: 'ig',
        name: 'Igbo',
        flag: 'ðŸ‡³ðŸ‡¬',
        greeting: 'Ndewo! Kedu ka m ga-esi nyere gá»‹ aka?',
        aiInstruction: 'Respond in Igbo language. Use Igbo greetings, expressions, and cultural context. Write entirely in Igbo.',
        voiceCode: 'ig-NG'
      },
      hausa: {
        code: 'ha',
        name: 'Hausa',
        flag: 'ðŸ‡³ðŸ‡¬',
        greeting: 'Sannu! Yaya zan iya taimaka muku?',
        aiInstruction: 'Respond in Hausa language. Use Hausa greetings like "Sannu", "Yaya dai", etc. Write entirely in Hausa.',
        voiceCode: 'ha-NG'
      },
      pidgin: {
        code: 'pcm',
        name: 'Pidgin',
        flag: 'ðŸ‡³ðŸ‡¬',
        greeting: 'How far! Wetin you wan know?',
        aiInstruction: 'Respond in Nigerian Pidgin English. Use expressions like "How far", "Wetin dey happen", "E go be", "No wahala", "Abeg", etc. Keep it casual and friendly like how Nigerians speak Pidgin.',
        voiceCode: 'en-NG'
      }
    };
    
    // Map variables
    var mapZoom = 1;
    var mapPanX = 0;
    var mapPanY = 0;
    var isDragging = false;
    var dragStartX = 0;
    var dragStartY = 0;
    var lastPanX = 0;
    var lastPanY = 0;
    var tripActive = false;
    var tripProgress = 0;
    var tripInterval = null;
    
    // Check-in variables
    var checkinDuration = 30;
    var checkinReason = '';
    var checkinTimeLeft = 0;
    var checkinInterval = null;
    var checkinActive = false;
    var expiredInterval = null;
    var expiredSeconds = 10;
    
    // Recording variables
    var recordType = 'audio';
    var recordQuality = 'medium';
    var isRecording = false;
    var isPaused = false;
    var recordingSeconds = 0;
    var recordingInterval = null;
    var stealthMode = false;
    
    // Report variables
    var selectedIncidentType = '';
    var selectedSeverity = 'medium';
    var selectedLocation = '';
    var attachedEvidence = [];
    
    // =============================================
    // SCREEN NAVIGATION
    // =============================================
    function switchScreen(screenId) {
      // Hide all screens
      document.querySelectorAll('.screen').forEach(function(s) {
        s.classList.remove('active');
      });
      
      // Show target screen
      document.getElementById(screenId).classList.add('active');
      currentScreen = screenId;
      
      // Update nav
      document.querySelectorAll('.nav-item').forEach(function(n) {
        n.classList.remove('active');
      });
      
      if (screenId === 'homeScreen') document.getElementById('navHome').classList.add('active');
      if (screenId === 'mapScreen') document.getElementById('navMap').classList.add('active');
      if (screenId === 'hubScreen') document.getElementById('navHub').classList.add('active');
      if (screenId === 'settingsScreen') document.getElementById('navSettings').classList.add('active');
      
      // For sub-screens, keep parent nav active
      if (screenId === 'checkinScreen' || screenId === 'recordScreen' || screenId === 'reportScreen' || screenId === 'aiScreen') {
        document.getElementById('navHome').classList.add('active');
      }
      
      // Hide/show AI float button and bottom nav based on screen
      var aiBtn = document.getElementById('aiFloatBtn');
      var bottomNav = document.querySelector('.bottom-nav');
      
      if (screenId === 'aiScreen') {
        // Hide AI button and bottom nav when AI screen is open
        if (aiBtn) aiBtn.style.display = 'none';
        if (bottomNav) bottomNav.style.display = 'none';
        
        // Focus the AI input after a short delay (for animation)
        setTimeout(function() {
          var aiInput = document.getElementById('aiChatInput');
          if (aiInput) aiInput.focus();
        }, 300);
      } else {
        // Show them on other screens
        if (aiBtn) aiBtn.style.display = 'flex';
        if (bottomNav) bottomNav.style.display = 'flex';
      }
      
      // Scroll to top
      window.scrollTo(0, 0);
    }
    
    // =============================================
    // CLOCK UPDATE
    // =============================================
    function updateClock() {
      var now = new Date();
      var h = now.getHours();
      var m = String(now.getMinutes()).padStart(2, '0');
      var timeStr = h + ':' + m;
      
      // Update all time displays
      for (var i = 1; i <= 10; i++) {
        var el = document.getElementById('time' + (i === 1 ? '' : i));
        if (el) el.textContent = timeStr;
      }
    }
    updateClock();
    setInterval(updateClock, 60000);
    
    // =============================================
    // TOAST NOTIFICATION
    // =============================================
    function showToast(message) {
      var toast = document.getElementById('globalToast');
      if (!toast) {
        toast = document.createElement('div');
        toast.id = 'globalToast';
        toast.className = 'toast';
        document.body.appendChild(toast);
      }
      
      toast.textContent = message;
      toast.classList.add('show');
      
      setTimeout(function() {
        toast.classList.remove('show');
      }, 2500);
    }
    
    // =============================================
    // STATE SELECTOR (All 36 States + FCT)
    // =============================================
    function openStateSelector() {
      document.getElementById('stateModal').classList.add('show');
      document.getElementById('stateSearchInput').value = '';
      filterStates();
    }
    
    function closeStateSelector() {
      document.getElementById('stateModal').classList.remove('show');
    }
    
    function filterStates() {
      var search = document.getElementById('stateSearchInput').value.toLowerCase();
      var items = document.querySelectorAll('.state-item');
      
      items.forEach(function(item) {
        var text = item.textContent.toLowerCase();
        if (text.includes(search) || search === '') {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
      
      // Show/hide zone headers based on visible items
      document.querySelectorAll('.state-zone').forEach(function(zone) {
        var visibleItems = zone.querySelectorAll('.state-item[style="display: flex;"], .state-item:not([style])');
        var hasVisible = false;
        zone.querySelectorAll('.state-item').forEach(function(item) {
          if (item.style.display !== 'none') hasVisible = true;
        });
        zone.style.display = hasVisible ? 'block' : 'none';
      });
    }
    
    function selectState(state, city) {
      selectedState = state;
      selectedCity = city;
      
      // Update display
      document.getElementById('currentState').textContent = city;
      document.getElementById('currentStateLabel').textContent = state + ' State, Nigeria';
      
      // Update selected state in modal
      document.querySelectorAll('.state-item').forEach(function(item) {
        item.classList.remove('selected');
        if (item.textContent.includes(state)) {
          item.classList.add('selected');
        }
      });
      
      closeStateSelector();
      showToast('ðŸ“ Location set to ' + city + ', ' + state);
    }
    
    // =============================================
    // SOS FUNCTIONALITY
    // =============================================
    function startSOS() {
      // If already in emergency mode, tapping ends it
      if (emergency) {
        endEmergency();
        return;
      }
      if (holding) return;
      holding = true;
      countdown = 3;
      
      document.getElementById('glow').classList.add('danger');
      document.getElementById('app').classList.add('danger-mode');
      document.getElementById('sosBtn').classList.add('holding');
      document.getElementById('sosOuter').classList.add('holding');
      document.getElementById('sosCount').textContent = countdown;
      document.getElementById('sosLabel').textContent = 'Release to cancel';
      
      sosTimer = setInterval(function() {
        countdown--;
        document.getElementById('sosCount').textContent = countdown;
        try { navigator.vibrate(100); } catch(e) {}
        
        if (countdown <= 0) {
          clearInterval(sosTimer);
          sosTimer = null;
          triggerEmergency();
        }
      }, 1000);
    }
    
    function stopSOS() {
      if (!holding || emergency) return;
      holding = false;
      
      if (sosTimer) {
        clearInterval(sosTimer);
        sosTimer = null;
      }
      
      document.getElementById('glow').classList.remove('danger');
      document.getElementById('app').classList.remove('danger-mode');
      document.getElementById('sosBtn').classList.remove('holding');
      document.getElementById('sosOuter').classList.remove('holding');
      document.getElementById('sosCount').textContent = 'SOS';
      document.getElementById('sosLabel').textContent = 'Hold for 3 seconds';
    }
    
    function triggerEmergency() {
      emergency = true;
      holding = false;
      
      // Update SOS button
      document.getElementById('sosBtn').classList.remove('holding');
      document.getElementById('sosOuter').classList.remove('holding');
      document.getElementById('sosBtn').classList.add('triggered');
      document.getElementById('sosCount').textContent = 'ðŸš¨';
      document.getElementById('sosLabel').textContent = 'TAP TO END';
      
      // Show end emergency button (the one below SOS button)
      document.getElementById('endEmergencyBtn2').style.display = 'flex';
      
      // Update glow and show island for emergency
      document.getElementById('glow').classList.add('danger');
      document.getElementById('island').style.display = 'flex';
      document.getElementById('island').classList.add('expanded');
      document.querySelector('.island-icon').textContent = 'ðŸš¨';
      document.querySelector('.island-title').textContent = 'Emergency Active';
      document.querySelector('.island-sub').textContent = 'Help is on the way â€¢ 3 contacts notified';
      
      // Update safety card
      document.getElementById('safety').classList.add('danger');
      document.getElementById('safetyIcon').textContent = 'ðŸš¨';
      document.getElementById('safetyTitle').textContent = 'Emergency Active';
      document.getElementById('safetySub').textContent = 'Help is on the way â€¢ Live tracking';
      document.getElementById('safetyBadge').textContent = 'ðŸ”´ Broadcasting';
      
      // Show modal
      document.getElementById('emergencyActiveModal').classList.add('show');
      
      try { navigator.vibrate([200, 100, 200, 100, 200]); } catch(e) {}
    }
    
    function endEmergency() {
      emergency = false;
      holding = false;
      
      // Close modals
      document.getElementById('emergencyActiveModal').classList.remove('show');
      document.getElementById('modal').classList.remove('show');
      
      // Hide end emergency button
      document.getElementById('endEmergencyBtn2').style.display = 'none';
      
      // Reset glow and ambient
      document.getElementById('glow').classList.remove('danger');
      document.getElementById('app').classList.remove('danger-mode');
      
      // Hide island (only shows during emergency)
      document.getElementById('island').style.display = 'none';
      document.getElementById('island').classList.remove('expanded');
      document.querySelector('.island-icon').textContent = 'ðŸ›¡ï¸';
      document.querySelector('.island-title').textContent = 'SafeAlert';
      document.querySelector('.island-sub').textContent = 'Protection Active';
      
      // Reset safety card
      document.getElementById('safety').classList.remove('danger');
      document.getElementById('safetyIcon').textContent = 'âœ“';
      document.getElementById('safetyTitle').textContent = 'All Clear';
      document.getElementById('safetySub').textContent = 'No threats detected in your area';
      document.getElementById('safetyBadge').textContent = 'ðŸŸ¢ Safe Zone';
      
      // Reset SOS button
      document.getElementById('sosBtn').classList.remove('holding', 'triggered');
      document.getElementById('sosOuter').classList.remove('holding');
      document.getElementById('sosCount').textContent = 'SOS';
      document.getElementById('sosLabel').textContent = 'Hold for 3 seconds';
      
      showToast('âœ… Emergency ended - Contacts notified you\'re safe');
      try { navigator.vibrate([50, 30, 50]); } catch(e) {}
    }
    
    function closeEmergencyModal() {
      document.getElementById('emergencyActiveModal').classList.remove('show');
    }
    
    function cancelSOS() {
      stopSOS();
      document.getElementById('sosModal').classList.remove('show');
    }
    
    function sendSOSNow() {
      if (sosTimer) {
        clearInterval(sosTimer);
        sosTimer = null;
      }
      document.getElementById('sosModal').classList.remove('show');
      triggerEmergency();
    }
    
    // Attach SOS events
    document.addEventListener('DOMContentLoaded', function() {
      var btn = document.getElementById('sosBtn');
      if (btn) {
        btn.addEventListener('pointerdown', function(e) {
          e.preventDefault();
          btn.setPointerCapture(e.pointerId);
          startSOS();
        });
        btn.addEventListener('pointerup', function(e) {
          e.preventDefault();
          stopSOS();
        });
        btn.addEventListener('pointercancel', function(e) {
          e.preventDefault();
          stopSOS();
        });
        btn.addEventListener('contextmenu', function(e) {
          e.preventDefault();
        });
      }
    });
    // =============================================
    // MAP FUNCTIONALITY
    // =============================================
    var markers = {
      1: { type: 'danger', title: 'Armed Robbery', location: 'Computer Village, Ikeja', time: '18 min ago', desc: 'Armed robbery reported near the main market. Police dispatched.' },
      2: { type: 'warning', title: 'Traffic Incident', location: 'Maryland, Lagos', time: '45 min ago', desc: 'Heavy traffic due to accident. Expect delays.' },
      3: { type: 'warning', title: 'Road Closure', location: 'Oshodi', time: '1 hour ago', desc: 'Road closed for repairs. Use alternative routes.' },
      4: { type: 'safe', title: 'Police Checkpoint', location: 'Lekki Toll Gate', time: 'Active', desc: 'Routine checkpoint. Safe zone with security presence.' },
      5: { type: 'kidnap', title: 'KIDNAPPING ALERT', location: 'Yaba, Lagos', time: '12 min ago', desc: 'âš ï¸ URGENT: Suspected kidnapping attempt near UNILAG. Black Toyota Sienna. Call 112 if seen.' }
    };
    
    var locations = {
      'ikeja': { x: 130, y: 120, name: 'Ikeja' },
      'vi': { x: 300, y: 440, name: 'Victoria Island' },
      'lekki': { x: 350, y: 560, name: 'Lekki' },
      'yaba': { x: 270, y: 130, name: 'Yaba' },
      'ikoyi': { x: 240, y: 530, name: 'Ikoyi' }
    };
    
    function updateMapTransform() {
      var content = document.getElementById('mapContent');
      if (content) {
        content.setAttribute('transform', 'translate(' + mapPanX + ',' + mapPanY + ') scale(' + mapZoom + ')');
      }
    }
    
    function showZoomIndicator() {
      var indicator = document.getElementById('zoomIndicator');
      if (indicator) {
        indicator.textContent = Math.round(mapZoom * 100) + '%';
        indicator.classList.add('show');
        clearTimeout(window.zoomTimeout);
        window.zoomTimeout = setTimeout(function() {
          indicator.classList.remove('show');
        }, 1500);
      }
    }
    
    function zoomIn() {
      if (mapZoom < 3) {
        mapZoom = Math.min(3, mapZoom + 0.25);
        updateMapTransform();
        showZoomIndicator();
      }
    }
    
    function zoomOut() {
      if (mapZoom > 0.5) {
        mapZoom = Math.max(0.5, mapZoom - 0.25);
        if (mapZoom <= 1) {
          mapPanX = 0;
          mapPanY = 0;
        }
        updateMapTransform();
        showZoomIndicator();
      }
    }
    
    function centerOnUser() {
      var svg = document.getElementById('mapSvg');
      if (svg) {
        svg.classList.add('animating');
        mapZoom = 1.5;
        mapPanX = -200 * 0.5 + 100;
        mapPanY = -300 * 0.5 + 150;
        updateMapTransform();
        showZoomIndicator();
        
        document.getElementById('centerBtn').classList.add('active');
        setTimeout(function() {
          svg.classList.remove('animating');
          document.getElementById('centerBtn').classList.remove('active');
        }, 500);
      }
    }
    
    function toggleMapStyle() {
      var btn = document.getElementById('styleBtn');
      if (btn) btn.classList.toggle('active');
      showToast('Map style changed');
    }
    
    // Map drag/pan
    function initMapDrag() {
      var container = document.getElementById('mapContainer');
      if (!container) return;
      
      container.addEventListener('pointerdown', function(e) {
        if (e.target.closest('.map-controls') || e.target.closest('.trip-panel') || 
            e.target.closest('.start-trip-panel') || e.target.closest('.marker-popup') ||
            e.target.closest('.map-legend') || e.target.closest('.map-search')) return;
        
        isDragging = true;
        dragStartX = e.clientX;
        dragStartY = e.clientY;
        lastPanX = mapPanX;
        lastPanY = mapPanY;
        container.style.cursor = 'grabbing';
      });
      
      container.addEventListener('pointermove', function(e) {
        if (!isDragging) return;
        
        var dx = (e.clientX - dragStartX) / mapZoom;
        var dy = (e.clientY - dragStartY) / mapZoom;
        
        mapPanX = lastPanX + dx;
        mapPanY = lastPanY + dy;
        
        var maxPan = 200 * mapZoom;
        mapPanX = Math.max(-maxPan, Math.min(maxPan, mapPanX));
        mapPanY = Math.max(-maxPan, Math.min(maxPan, mapPanY));
        
        updateMapTransform();
      });
      
      container.addEventListener('pointerup', function() {
        isDragging = false;
        container.style.cursor = 'grab';
      });
      
      container.addEventListener('pointerleave', function() {
        isDragging = false;
        container.style.cursor = 'grab';
      });
      
      container.addEventListener('wheel', function(e) {
        e.preventDefault();
        if (e.deltaY < 0) zoomIn();
        else zoomOut();
      }, { passive: false });
    }
    
    // Search
    function showSearchSuggestions() {
      var suggestions = document.getElementById('searchSuggestions');
      if (suggestions) suggestions.classList.add('show');
      var clear = document.querySelector('.search-clear');
      if (clear) clear.style.display = 'block';
    }
    
    function clearSearch() {
      var input = document.getElementById('mapSearchInput');
      var suggestions = document.getElementById('searchSuggestions');
      var clear = document.querySelector('.search-clear');
      
      if (input) input.value = '';
      if (suggestions) suggestions.classList.remove('show');
      if (clear) clear.style.display = 'none';
    }
    
    function filterSuggestions() {
      var input = document.getElementById('mapSearchInput');
      if (!input) return;
      
      var search = input.value.toLowerCase();
      var items = document.querySelectorAll('.suggestion-item');
      
      items.forEach(function(item) {
        var name = item.querySelector('.suggestion-name');
        if (name && name.textContent.toLowerCase().includes(search)) {
          item.style.display = 'flex';
        } else {
          item.style.display = 'none';
        }
      });
    }
    
    function goToLocation(locKey) {
      var loc = locations[locKey];
      if (!loc) return;
      
      clearSearch();
      
      var svg = document.getElementById('mapSvg');
      if (svg) {
        svg.classList.add('animating');
        mapZoom = 1.5;
        mapPanX = -loc.x * 0.5 + 100;
        mapPanY = -loc.y * 0.5 + 150;
        updateMapTransform();
        
        setTimeout(function() {
          svg.classList.remove('animating');
        }, 400);
      }
      
      showToast('ðŸ“ ' + loc.name);
    }
    
    // Current marker for AI queries
    var currentMarkerId = null;
    
    // Marker info with AI analysis
    async function showMarkerInfo(id) {
      var marker = markers[id];
      if (!marker) return;
      
      currentMarkerId = id;
      
      var popup = document.getElementById('markerPopup');
      var badge = document.getElementById('popupBadge');
      
      if (marker.type === 'danger') {
        badge.textContent = 'ðŸš¨ High Alert';
        badge.className = 'popup-badge danger';
      } else if (marker.type === 'warning') {
        badge.textContent = 'âš ï¸ Caution';
        badge.className = 'popup-badge warning';
      } else if (marker.type === 'kidnap') {
        badge.textContent = 'ðŸš¨ KIDNAPPING';
        badge.className = 'popup-badge kidnap';
      } else {
        badge.textContent = 'âœ“ Safe Zone';
        badge.className = 'popup-badge safe';
      }
      
      document.getElementById('popupTitle').textContent = marker.title;
      document.getElementById('popupLocation').textContent = 'ðŸ“ ' + marker.location;
      document.getElementById('popupTime').textContent = marker.time;
      document.getElementById('popupDesc').textContent = marker.desc;
      
      // Show loading state for AI
      document.getElementById('markerAiBody').textContent = 'Analyzing incident...';
      document.getElementById('markerAiTips').innerHTML = '';
      
      popup.classList.add('show');
      document.getElementById('mapLegend').style.display = 'none';
      
      // Get AI analysis for this marker
      await analyzeMarkerWithAI(marker);
    }
    
    // AI analysis for map markers
    async function analyzeMarkerWithAI(marker) {
      var body = document.getElementById('markerAiBody');
      var tips = document.getElementById('markerAiTips');
      var ctx = getAIContext();
      
      var prompt = `Quick safety analysis for this incident in Lagos, Nigeria:
Type: ${marker.title}
Location: ${marker.location}
Time: ${marker.time}
Details: ${marker.desc}
User is currently at: ${ctx.location}

Respond with JSON only:
{
  "advice": "One brief sentence of advice",
  "tips": ["action1", "action2"],
  "distanceWarning": "brief note about distance/safety"
}`;

      try {
        var response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 300,
            messages: [{ role: 'user', content: prompt }]
          })
        });
        
        var data = await response.json();
        var text = data.content[0].text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        var analysis = JSON.parse(text);
        
        body.textContent = analysis.advice;
        
        tips.innerHTML = '';
        if (analysis.tips) {
          analysis.tips.forEach(function(tip) {
            tips.innerHTML += '<span class="ai-tip">ðŸ’¡ ' + tip + '</span>';
          });
        }
        if (analysis.distanceWarning) {
          tips.innerHTML += '<span class="ai-tip" style="background:rgba(100,210,255,0.2);color:#64D2FF;">ðŸ“ ' + analysis.distanceWarning + '</span>';
        }
        
      } catch(e) {
        console.error('Marker AI Error:', e);
        body.textContent = marker.type === 'safe' 
          ? 'This is a verified safe zone with security presence.' 
          : 'Stay alert and avoid this area if possible. Share your location with trusted contacts.';
        tips.innerHTML = '<span class="ai-tip">ðŸ’¡ Enable Check-In Timer</span><span class="ai-tip">ðŸ’¡ Share with contacts</span>';
      }
    }
    
    // Ask AI more about a marker
    async function askAIAboutMarker() {
      if (!currentMarkerId) return;
      
      var marker = markers[currentMarkerId];
      if (!marker) return;
      
      // Switch to AI screen with pre-filled question
      switchScreen('aiScreen');
      
      var question = "Tell me more about the " + marker.title + " incident at " + marker.location + ". What precautions should I take?";
      document.getElementById('aiChatInput').value = question;
      
      // Auto-send
      setTimeout(function() {
        sendAIMessage();
      }, 500);
    }
    
    function hideMarkerInfo() {
      document.getElementById('markerPopup').classList.remove('show');
      document.getElementById('mapLegend').style.display = 'block';
    }
    
    function navigateToAlert() {
      hideMarkerInfo();
      showToast('ðŸ§­ Navigation started');
    }
    
    function shareAlert() {
      hideMarkerInfo();
      showToast('ðŸ“¤ Alert shared');
    }
    
    // Trip monitoring
    function selectDestination(name, x, y) {
      // Expand the panel first
      var panel = document.getElementById('startTripPanel');
      panel.classList.remove('collapsed');
      
      document.getElementById('destInput').value = name;
      
      // Trigger AI analysis
      analyzeRouteWithAI(name);
    }
    
    function startTrip() {
      var destination = document.getElementById('destInput').value || 'Victoria Island';
      
      tripActive = true;
      tripProgress = 0;
      
      document.getElementById('tripDest').textContent = destination;
      document.getElementById('startTripPanel').classList.add('hidden');
      
      // Show and collapse the active trip panel
      var tripPanel = document.getElementById('tripPanel');
      tripPanel.classList.remove('hidden');
      tripPanel.classList.add('collapsed'); // Start collapsed so map is visible
      
      // Update collapsed header info
      document.getElementById('tripPanelTitle').textContent = 'To ' + destination;
      document.getElementById('tripPanelSubtitle').textContent = '12 min â€¢ 4.2 km';
      
      // Set safety badge based on last analysis
      var routeBadge = document.getElementById('routeSafetyBadge');
      var tripBadge = document.getElementById('tripSafetyBadge');
      if (routeBadge && tripBadge) {
        tripBadge.className = routeBadge.className.replace('routeSafetyBadge', 'tripSafetyBadge');
        tripBadge.textContent = routeBadge.textContent;
      }
      
      // Show route
      document.getElementById('routePath').style.display = 'block';
      document.getElementById('routeGlow').style.display = 'block';
      document.getElementById('routeTraveled').style.display = 'block';
      document.getElementById('destMarker').style.display = 'block';
      document.getElementById('userDirection').style.display = 'block';
      
      var routeEl = document.getElementById('routePath');
      if (routeEl) routeEl.style.strokeDashoffset = '0';
      
      // Update island
      document.getElementById('island').style.display = 'flex';
      document.getElementById('island').classList.add('trip-active');
      document.querySelector('.island-icon').textContent = 'ðŸ“';
      document.querySelector('.island-title').textContent = 'Trip Active';
      document.querySelector('.island-sub').textContent = 'To ' + destination + ' â€¢ 3 watching';
      
      simulateTrip();
    }
    
    function simulateTrip() {
      var totalDistance = 4.2;
      var totalTime = 12;
      var aiUpdateSent = false;
      
      tripInterval = setInterval(function() {
        if (!tripActive) {
          clearInterval(tripInterval);
          return;
        }
        
        tripProgress += 0.5;
        if (tripProgress > 100) tripProgress = 100;
        
        var remainingDist = (totalDistance * (100 - tripProgress) / 100).toFixed(1);
        var remainingTime = Math.ceil(totalTime * (100 - tripProgress) / 100);
        
        document.getElementById('tripDistance').textContent = remainingDist;
        document.getElementById('tripEta').textContent = remainingTime;
        
        // Update collapsed header
        document.getElementById('tripPanelSubtitle').textContent = remainingTime + ' min â€¢ ' + remainingDist + ' km';
        
        var circumference = 125.6;
        var offset = circumference - (tripProgress / 100 * circumference);
        document.getElementById('progressRing').style.strokeDashoffset = offset;
        document.getElementById('progressPercent').textContent = Math.round(tripProgress) + '%';
        
        // Move user marker
        var currentX = 200 + (300 - 200) * tripProgress / 100;
        var currentY = 300 + (520 - 300) * tripProgress / 100;
        document.getElementById('userMarker').setAttribute('transform', 'translate(' + currentX + ',' + currentY + ')');
        
        var traveledLength = tripProgress * 10;
        document.getElementById('routeTraveled').style.strokeDasharray = traveledLength + ' 1000';
        
        // AI safety update at 50% progress
        if (tripProgress >= 50 && !aiUpdateSent) {
          aiUpdateSent = true;
          showTripAIUpdate();
        }
        
        if (tripProgress >= 100) {
          clearInterval(tripInterval);
          showToast('ðŸŽ‰ You have arrived safely!');
          try { navigator.vibrate([100, 50, 100]); } catch(e) {}
        }
      }, 300);
    }
    
    // Show AI update during trip
    async function showTripAIUpdate() {
      var updateDiv = document.getElementById('tripAiUpdate');
      var body = document.getElementById('tripAiBody');
      
      // Quick AI check for route update
      var ctx = getAIContext();
      
      try {
        var response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 150,
            messages: [{ 
              role: 'user', 
              content: 'Quick safety update for someone traveling in Lagos at ' + new Date().toLocaleTimeString() + '. One brief sentence. JSON: {"update": "message"}' 
            }]
          })
        });
        
        var data = await response.json();
        var text = data.content[0].text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        var parsed = JSON.parse(text);
        
        updateDiv.style.display = 'block';
        body.textContent = parsed.update;
        
      } catch(e) {
        updateDiv.style.display = 'block';
        body.textContent = 'âœ“ Route still looks clear. You\'re making good progress!';
      }
    }
    
    function sendCheckIn() {
      showToast('âœ“ Check-in sent to 3 watchers');
      try { navigator.vibrate(50); } catch(e) {}
    }
    
    function endTrip() {
      tripActive = false;
      if (tripInterval) clearInterval(tripInterval);
      
      // Show start panel (collapsed) and hide active panel
      var startPanel = document.getElementById('startTripPanel');
      startPanel.classList.remove('hidden');
      startPanel.classList.add('collapsed'); // Keep collapsed
      
      document.getElementById('tripPanel').classList.add('hidden');
      
      // Hide route
      document.getElementById('routePath').style.display = 'none';
      document.getElementById('routeGlow').style.display = 'none';
      document.getElementById('routeTraveled').style.display = 'none';
      document.getElementById('destMarker').style.display = 'none';
      document.getElementById('userDirection').style.display = 'none';
      
      document.getElementById('routePath').style.strokeDashoffset = '1000';
      document.getElementById('routeTraveled').style.strokeDasharray = '0 1000';
      
      document.getElementById('userMarker').setAttribute('transform', 'translate(200, 300)');
      
      // Hide island
      document.getElementById('island').classList.remove('trip-active');
      document.getElementById('island').style.display = 'none';
      
      // Reset progress
      tripProgress = 0;
      document.getElementById('progressRing').style.strokeDashoffset = '125.6';
      document.getElementById('progressPercent').textContent = '0%';
      
      // Clear destination input and AI analysis
      document.getElementById('destInput').value = '';
      document.getElementById('aiRouteAnalysis').style.display = 'none';
      
      showToast('Trip ended safely');
    }
    
    function shareTrip() {
      showToast('ðŸ“¤ Trip link copied!');
    }
    
    // =============================================
    // COLLAPSIBLE TRIP PANEL FUNCTIONS
    // =============================================
    function toggleTripPanel() {
      var panel = document.getElementById('startTripPanel');
      panel.classList.toggle('collapsed');
      
      var subtitle = panel.querySelector('.panel-handle-subtitle');
      if (panel.classList.contains('collapsed')) {
        subtitle.textContent = 'Tap to plan your route';
      } else {
        subtitle.textContent = 'Select destination below';
      }
    }
    
    function toggleActiveTripPanel() {
      var panel = document.getElementById('tripPanel');
      panel.classList.toggle('collapsed');
    }
    
    // When destination is entered, trigger AI analysis
    var aiAnalysisTimeout = null;
    function onDestinationInput() {
      var dest = document.getElementById('destInput').value;
      
      if (aiAnalysisTimeout) clearTimeout(aiAnalysisTimeout);
      
      if (dest.length > 2) {
        aiAnalysisTimeout = setTimeout(function() {
          analyzeRouteWithAI(dest);
        }, 800);
      } else {
        document.getElementById('aiRouteAnalysis').style.display = 'none';
      }
    }
    
    // AI Route Analysis
    async function analyzeRouteWithAI(destination) {
      var analysisDiv = document.getElementById('aiRouteAnalysis');
      var badge = document.getElementById('routeSafetyBadge');
      var body = document.getElementById('aiRouteBody');
      var tips = document.getElementById('aiRouteTips');
      
      // Show analyzing state
      analysisDiv.style.display = 'block';
      badge.className = 'ai-safety-badge analyzing';
      badge.textContent = 'â³ Analyzing...';
      body.textContent = 'AI is analyzing route safety based on time, location, and recent incidents...';
      tips.innerHTML = '';
      
      // Call Claude AI for route analysis
      var ctx = getAIContext();
      var hour = new Date().getHours();
      var timeOfDay = hour < 6 ? 'night (dangerous)' : hour < 12 ? 'morning' : hour < 18 ? 'afternoon' : 'evening (be cautious)';
      
      var routePrompt = `Analyze this trip for safety:
From: ${ctx.location}
To: ${destination}, Lagos, Nigeria
Time: ${timeOfDay} (${hour}:00)
Recent alerts: ${ctx.recentAlerts.join('; ')}

Respond ONLY with valid JSON:
{
  "safetyLevel": "safe|caution|danger",
  "riskScore": 1-10,
  "summary": "Brief 1-2 sentence assessment",
  "tips": ["tip1", "tip2", "tip3"],
  "warnings": ["warning if any"]
}`;

      try {
        var response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 500,
            messages: [{ role: 'user', content: routePrompt }]
          })
        });
        
        var data = await response.json();
        var responseText = data.content[0].text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        var analysis = JSON.parse(responseText);
        
        // Update UI with analysis
        badge.className = 'ai-safety-badge ' + analysis.safetyLevel;
        if (analysis.safetyLevel === 'safe') {
          badge.textContent = 'âœ“ Safe Route';
        } else if (analysis.safetyLevel === 'caution') {
          badge.textContent = 'âš ï¸ Use Caution';
        } else {
          badge.textContent = 'ðŸš¨ High Risk';
        }
        
        body.textContent = analysis.summary;
        
        // Add tips
        tips.innerHTML = '';
        if (analysis.tips) {
          analysis.tips.forEach(function(tip) {
            tips.innerHTML += '<span class="ai-tip">ðŸ’¡ ' + tip + '</span>';
          });
        }
        if (analysis.warnings && analysis.warnings.length > 0) {
          analysis.warnings.forEach(function(warn) {
            tips.innerHTML += '<span class="ai-tip" style="background:rgba(255,55,95,0.2);color:#FF375F;">âš ï¸ ' + warn + '</span>';
          });
        }
        
      } catch (error) {
        console.error('AI Route Analysis Error:', error);
        
        // Fallback analysis
        var isNight = hour < 6 || hour > 20;
        badge.className = 'ai-safety-badge ' + (isNight ? 'caution' : 'safe');
        badge.textContent = isNight ? 'âš ï¸ Use Caution' : 'âœ“ Looks Safe';
        body.textContent = isNight 
          ? 'Late travel detected. Consider using the Check-In Timer and sharing your trip with contacts.'
          : 'Route appears clear. Stay alert and share your trip with emergency contacts.';
        tips.innerHTML = '<span class="ai-tip">ðŸ’¡ Share trip with contacts</span><span class="ai-tip">ðŸ’¡ Keep phone charged</span>';
      }
    }
    
    // Start trip with AI safety check
    async function startTripWithAI() {
      var destination = document.getElementById('destInput').value || 'Victoria Island';
      
      // Expand panel if collapsed
      var panel = document.getElementById('startTripPanel');
      if (panel.classList.contains('collapsed')) {
        panel.classList.remove('collapsed');
      }
      
      // Run AI analysis if not done
      var analysisDiv = document.getElementById('aiRouteAnalysis');
      if (analysisDiv.style.display === 'none') {
        await analyzeRouteWithAI(destination);
      }
      
      // Wait a moment for user to see analysis
      setTimeout(function() {
        startTrip();
      }, 500);
    }
    
    // Voice input for destination
    var destVoiceActive = false;
    function toggleDestVoice() {
      var btn = document.getElementById('destVoiceBtn');
      
      if (destVoiceActive) {
        stopDestVoice();
      } else {
        if (!voiceRecognition) {
          if (!initVoiceRecognition()) {
            showToast('âš ï¸ Voice not supported');
            return;
          }
        }
        
        destVoiceActive = true;
        btn.classList.add('listening');
        showToast('ðŸŽ¤ Say your destination...');
        
        voiceRecognition.onresult = function(event) {
          var transcript = event.results[0][0].transcript;
          document.getElementById('destInput').value = transcript;
          stopDestVoice();
          onDestinationInput();
        };
        
        try {
          voiceRecognition.start();
        } catch(e) {
          console.log('Dest voice error:', e);
        }
        
        setTimeout(stopDestVoice, 8000);
      }
    }
    
    function stopDestVoice() {
      destVoiceActive = false;
      var btn = document.getElementById('destVoiceBtn');
      if (btn) btn.classList.remove('listening');
      if (voiceRecognition) {
        try { voiceRecognition.stop(); } catch(e) {}
      }
    }
    
    // =============================================
    // HUB TAB SWITCHING
    // =============================================
    function switchHubTab(tab) {
      document.querySelectorAll('.hub-tab').forEach(function(t) {
        t.classList.remove('active');
      });
      document.querySelectorAll('.hub-content').forEach(function(c) {
        c.classList.remove('active');
      });
      
      if (tab === 'community') {
        document.querySelector('.hub-tab:first-child').classList.add('active');
        document.getElementById('communityContent').classList.add('active');
      } else {
        document.querySelector('.hub-tab:last-child').classList.add('active');
        document.getElementById('historyContent').classList.add('active');
      }
    }
    
    function filterByRegion(region) {
      document.querySelectorAll('.region-pill').forEach(function(p) {
        p.classList.remove('active');
      });
      event.target.classList.add('active');
      showToast('Showing alerts for ' + region);
    }
    
    // =============================================
    // CHECK-IN TIMER
    // =============================================
    function selectDuration(minutes, element) {
      checkinDuration = minutes;
      document.querySelectorAll('.duration-option').forEach(function(el) {
        el.classList.remove('selected');
      });
      element.classList.add('selected');
      document.getElementById('customMinutes').value = '';
    }
    
    function setCustomDuration() {
      var custom = parseInt(document.getElementById('customMinutes').value);
      if (custom && custom >= 5 && custom <= 480) {
        checkinDuration = custom;
        document.querySelectorAll('.duration-option').forEach(function(el) {
          el.classList.remove('selected');
        });
        showToast('Timer set to ' + custom + ' minutes');
      } else {
        showToast('Enter 5-480 minutes');
      }
    }
    
    function selectReason(reason, element) {
      if (element.classList.contains('selected')) {
        element.classList.remove('selected');
        checkinReason = '';
        document.getElementById('reasonInputWrap').style.display = 'none';
        return;
      }
      
      document.querySelectorAll('.reason-chip').forEach(function(el) {
        el.classList.remove('selected');
      });
      element.classList.add('selected');
      
      if (reason === 'Other') {
        document.getElementById('reasonInputWrap').style.display = 'block';
        checkinReason = '';
      } else {
        document.getElementById('reasonInputWrap').style.display = 'none';
        checkinReason = reason;
      }
    }
    
    function formatTime(seconds) {
      var mins = Math.floor(seconds / 60);
      var secs = seconds % 60;
      return String(mins).padStart(2, '0') + ':' + String(secs).padStart(2, '0');
    }
    
    function startCheckinTimer() {
      if (document.getElementById('reasonInputWrap').style.display === 'block') {
        checkinReason = document.getElementById('customReason').value || 'Other activity';
      }
      
      checkinActive = true;
      checkinTimeLeft = checkinDuration * 60;
      
      document.getElementById('checkinSetup').style.display = 'none';
      document.getElementById('checkinActive').style.display = 'block';
      document.getElementById('checkinExpired').style.display = 'none';
      
      if (checkinReason) {
        document.getElementById('timerReasonDisplay').style.display = 'flex';
        document.getElementById('activeReason').textContent = checkinReason;
      } else {
        document.getElementById('timerReasonDisplay').style.display = 'none';
      }
      
      document.getElementById('island').classList.add('trip-active');
      document.querySelector('.island-icon').textContent = 'â±ï¸';
      document.querySelector('.island-title').textContent = 'Timer Active';
      document.querySelector('.island-sub').textContent = formatTime(checkinTimeLeft) + ' remaining';
      
      updateTimerDisplay();
      checkinInterval = setInterval(function() {
        checkinTimeLeft--;
        updateTimerDisplay();
        document.querySelector('.island-sub').textContent = formatTime(checkinTimeLeft) + ' remaining';
        
        if (checkinTimeLeft === 60) {
          try { navigator.vibrate([100, 50, 100, 50, 100]); } catch(e) {}
          document.getElementById('checkinConfirmBtn').classList.add('pulse');
        }
        
        if (checkinTimeLeft <= 0) {
          clearInterval(checkinInterval);
          timerExpired();
        }
      }, 1000);
      
      try { navigator.vibrate(100); } catch(e) {}
    }
    
    function updateTimerDisplay() {
      document.getElementById('timerDisplay').textContent = formatTime(checkinTimeLeft);
      
      var totalSeconds = checkinDuration * 60;
      var progress = checkinTimeLeft / totalSeconds;
      var circumference = 565;
      var offset = circumference * (1 - progress);
      document.getElementById('timerRing').style.strokeDashoffset = offset;
      
      if (checkinTimeLeft <= 60) {
        document.getElementById('timerRing').style.stroke = '#FF375F';
        document.getElementById('timerDisplay').style.color = '#FF375F';
      } else {
        document.getElementById('timerRing').style.stroke = '#FF9F0A';
        document.getElementById('timerDisplay').style.color = '#FF9F0A';
      }
    }
    
    function confirmCheckin() {
      checkinTimeLeft = checkinDuration * 60;
      document.getElementById('checkinConfirmBtn').classList.remove('pulse');
      showToast('âœ“ Check-in confirmed! Timer reset.');
      updateTimerDisplay();
      try { navigator.vibrate([50, 30, 50]); } catch(e) {}
    }
    
    function extendTimer(minutes) {
      var addMinutes = minutes || 5;
      checkinTimeLeft += addMinutes * 60;
      checkinDuration = Math.ceil(checkinTimeLeft / 60);
      updateTimerDisplay();
      showToast('+' + addMinutes + ' minutes added');
      if (checkinTimeLeft > 60) {
        document.getElementById('checkinConfirmBtn').classList.remove('pulse');
      }
      try { navigator.vibrate(50); } catch(e) {}
    }
    
    function cancelCheckinTimer() {
      checkinActive = false;
      if (checkinInterval) {
        clearInterval(checkinInterval);
        checkinInterval = null;
      }
      
      document.getElementById('checkinSetup').style.display = 'block';
      document.getElementById('checkinActive').style.display = 'none';
      document.getElementById('checkinExpired').style.display = 'none';
      
      document.getElementById('island').classList.remove('trip-active');
      document.getElementById('checkinConfirmBtn').classList.remove('pulse');
      document.getElementById('timerRing').style.stroke = '#FF9F0A';
      document.getElementById('timerDisplay').style.color = '#FF9F0A';
      
      showToast('Timer cancelled');
    }
    
    function timerExpired() {
      checkinActive = false;
      expiredSeconds = 10;
      
      document.getElementById('checkinActive').style.display = 'none';
      document.getElementById('checkinExpired').style.display = 'block';
      
      document.getElementById('island').classList.add('expanded');
      document.querySelector('.island-icon').textContent = 'ðŸš¨';
      document.querySelector('.island-title').textContent = 'Missed Check-In!';
      document.querySelector('.island-sub').textContent = 'Alerting contacts...';
      
      document.getElementById('glow').classList.add('danger');
      
      try { navigator.vibrate([500, 200, 500, 200, 500]); } catch(e) {}
      
      expiredInterval = setInterval(function() {
        expiredSeconds--;
        document.getElementById('expiredSeconds').textContent = expiredSeconds;
        try { navigator.vibrate(100); } catch(e) {}
        
        if (expiredSeconds <= 0) {
          clearInterval(expiredInterval);
          showToast('ðŸš¨ Emergency alerts sent to contacts');
        }
      }, 1000);
    }
    
    function imSafeCancel() {
      if (expiredInterval) {
        clearInterval(expiredInterval);
        expiredInterval = null;
      }
      
      document.getElementById('checkinSetup').style.display = 'block';
      document.getElementById('checkinExpired').style.display = 'none';
      document.getElementById('island').classList.remove('expanded', 'trip-active');
      document.getElementById('glow').classList.remove('danger');
      
      showToast('âœ“ Alert cancelled - You\'re marked safe');
    }
    
    // =============================================
    // EVIDENCE RECORDER
    // =============================================
    function selectRecordType(type) {
      recordType = type;
      document.getElementById('audioType').classList.remove('active');
      document.getElementById('videoType').classList.remove('active');
      document.getElementById(type + 'Type').classList.add('active');
    }
    
    function selectQuality(quality, element) {
      recordQuality = quality;
      document.querySelectorAll('.quality-option').forEach(function(el) {
        el.classList.remove('selected');
      });
      element.classList.add('selected');
    }
    
    function toggleStealthMode() {
      stealthMode = !stealthMode;
      var toggle = document.querySelector('.stealth-toggle');
      
      if (stealthMode) {
        toggle.classList.add('active');
        document.getElementById('stealthIcon').textContent = 'ðŸ‘ï¸â€ðŸ—¨ï¸';
        document.getElementById('stealthLabel').textContent = 'Stealth On';
        showToast('Stealth mode: Screen dims while recording');
      } else {
        toggle.classList.remove('active');
        document.getElementById('stealthIcon').textContent = 'ðŸ‘ï¸';
        document.getElementById('stealthLabel').textContent = 'Stealth';
      }
    }
    
    function startRecording() {
      isRecording = true;
      isPaused = false;
      recordingSeconds = 0;
      
      document.getElementById('recorderSetup').style.display = 'none';
      document.getElementById('recorderActive').style.display = 'block';
      document.getElementById('recorderComplete').style.display = 'none';
      
      if (recordType === 'audio') {
        document.getElementById('waveformContainer').style.display = 'flex';
        document.getElementById('videoPreview').style.display = 'none';
        document.getElementById('recTypeDisplay').textContent = 'Audio';
      } else {
        document.getElementById('waveformContainer').style.display = 'none';
        document.getElementById('videoPreview').style.display = 'flex';
        document.getElementById('recTypeDisplay').textContent = 'Video';
      }
      
      document.getElementById('recQualityDisplay').textContent = recordQuality.charAt(0).toUpperCase() + recordQuality.slice(1);
      
      document.getElementById('island').classList.add('trip-active');
      document.querySelector('.island-icon').textContent = 'ðŸŽ™ï¸';
      document.querySelector('.island-title').textContent = 'Recording';
      document.querySelector('.island-sub').textContent = '00:00 â€¢ ' + recordType;
      
      recordingInterval = setInterval(function() {
        if (!isPaused && isRecording) {
          recordingSeconds++;
          document.getElementById('recordingTimer').textContent = formatTime(recordingSeconds);
          document.querySelector('.island-sub').textContent = formatTime(recordingSeconds) + ' â€¢ ' + recordType;
          
          // Update size estimate
          var bytesPerSec = recordQuality === 'low' ? 4000 : (recordQuality === 'medium' ? 16000 : 32000);
          var totalBytes = recordingSeconds * bytesPerSec;
          var sizeDisplay = totalBytes < 1024 * 1024 ? Math.round(totalBytes / 1024) + ' KB' : (totalBytes / (1024 * 1024)).toFixed(1) + ' MB';
          document.getElementById('recSizeDisplay').textContent = sizeDisplay;
        }
      }, 1000);
      
      showToast('ðŸŽ™ï¸ Recording started');
      try { navigator.vibrate(100); } catch(e) {}
    }
    
    function togglePauseRecording() {
      isPaused = !isPaused;
      var btn = document.getElementById('pauseBtn');
      var waveform = document.querySelector('.waveform');
      
      if (isPaused) {
        btn.classList.add('active');
        btn.innerHTML = '<span>â–¶ï¸</span><span>Resume</span>';
        if (waveform) waveform.classList.add('paused');
        showToast('â¸ Recording paused');
      } else {
        btn.classList.remove('active');
        btn.innerHTML = '<span>â¸</span><span>Pause</span>';
        if (waveform) waveform.classList.remove('paused');
        showToast('â–¶ï¸ Recording resumed');
      }
      try { navigator.vibrate(50); } catch(e) {}
    }
    
    function stopRecording() {
      isRecording = false;
      if (recordingInterval) {
        clearInterval(recordingInterval);
        recordingInterval = null;
      }
      
      document.getElementById('completeDuration').textContent = formatTime(recordingSeconds);
      document.getElementById('completePreviewIcon').textContent = recordType === 'audio' ? 'ðŸŽ¤' : 'ðŸ“¹';
      
      document.getElementById('recorderActive').style.display = 'none';
      document.getElementById('recorderComplete').style.display = 'block';
      
      document.getElementById('island').classList.remove('trip-active');
      
      showToast('âœ… Recording saved!');
      try { navigator.vibrate([50, 30, 50]); } catch(e) {}
    }
    
    function sendRecordingNow() {
      showToast('ðŸ“¤ Recording sent to 3 contacts');
      try { navigator.vibrate(50); } catch(e) {}
    }
    
    function sendToContacts() {
      document.getElementById('sentStatus').style.display = 'flex';
      document.getElementById('sentStatus').className = 'status-item success';
      showToast('ðŸ“¤ Recording sent to emergency contacts');
      try { navigator.vibrate([50, 30, 50]); } catch(e) {}
    }
    
    function newRecording() {
      recordingSeconds = 0;
      isPaused = false;
      
      document.getElementById('recorderSetup').style.display = 'block';
      document.getElementById('recorderActive').style.display = 'none';
      document.getElementById('recorderComplete').style.display = 'none';
      document.getElementById('sentStatus').style.display = 'none';
      
      var btn = document.getElementById('pauseBtn');
      if (btn) {
        btn.classList.remove('active');
        btn.innerHTML = '<span>â¸</span><span>Pause</span>';
      }
      var waveform = document.querySelector('.waveform');
      if (waveform) waveform.classList.remove('paused');
    }
    
    function playRecording(id) {
      showToast('â–¶ï¸ Playing recording...');
    }
    
    function shareRecording(id) {
      showToast('ðŸ“¤ Share options opened');
    }
    
    function playLastRecording() {
      showToast('â–¶ï¸ Playing recording...');
    }
    
    function viewAllRecordings() {
      showToast('Viewing all recordings');
    }
    
    // =============================================
    // REPORT INCIDENT
    // =============================================
    var incidentLabels = {
      kidnapping: 'Kidnapping/Abduction',
      terrorist: 'Terrorist Activity',
      gunmen: 'Gunmen/Bandits',
      onechance: 'One Chance',
      missing: 'Missing Person',
      checkpoint: 'Illegal Checkpoint',
      cultist: 'Cultist/Gang Activity',
      robbery: 'Armed Robbery',
      herdsmen: 'Herdsmen Attack',
      explosion: 'Explosion/IED',
      shooting: 'Shooting',
      other: 'Other Threat'
    };
    
    var incidentIcons = {
      kidnapping: 'ðŸš¨', terrorist: 'ðŸ’£', gunmen: 'ðŸ”«', onechance: 'ðŸš',
      missing: 'ðŸ”', checkpoint: 'ðŸš§', cultist: 'âš”ï¸', robbery: 'ðŸ’°',
      herdsmen: 'ðŸ„', explosion: 'ðŸ’¥', shooting: 'ðŸŽ¯', other: 'ðŸ“'
    };
    
    function selectIncidentType(type, element) {
      selectedIncidentType = type;
      document.querySelectorAll('.incident-type').forEach(function(el) {
        el.classList.remove('selected');
      });
      element.classList.add('selected');
      try { navigator.vibrate(30); } catch(e) {}
    }
    
    function selectSeverity(level, element) {
      selectedSeverity = level;
      document.querySelectorAll('.severity-option').forEach(function(el) {
        el.classList.remove('selected');
      });
      element.classList.add('selected');
      try { navigator.vibrate(30); } catch(e) {}
    }
    
    function useCurrentLocation() {
      var locationEl = document.querySelector('.location-current');
      var labelEl = document.getElementById('currentLocationLabel');
      var addressEl = document.getElementById('currentLocationAddress');
      var checkEl = document.getElementById('locationCheck');
      
      labelEl.textContent = 'Detecting location...';
      addressEl.textContent = 'Please wait';
      
      setTimeout(function() {
        selectedLocation = selectedCity + ', ' + selectedState;
        labelEl.textContent = 'Current Location';
        addressEl.textContent = selectedLocation;
        locationEl.classList.add('selected');
        checkEl.style.display = 'block';
        document.getElementById('manualLocation').value = '';
        
        showToast('ðŸ“ Location detected');
        try { navigator.vibrate(50); } catch(e) {}
      }, 1000);
    }
    
    function onManualLocationInput() {
      var manualInput = document.getElementById('manualLocation');
      var locationEl = document.querySelector('.location-current');
      var checkEl = document.getElementById('locationCheck');
      
      if (manualInput.value.trim()) {
        selectedLocation = manualInput.value.trim();
        locationEl.classList.remove('selected');
        checkEl.style.display = 'none';
      }
    }
    
    function attachPhoto() {
      attachedEvidence.push({ type: 'photo', name: 'photo_' + Date.now() + '.jpg' });
      updateAttachedFiles();
      showToast('ðŸ“· Photo attached');
    }
    
    function attachRecording() {
      attachedEvidence.push({ type: 'audio', name: 'recording.m4a' });
      updateAttachedFiles();
      showToast('ðŸŽ™ï¸ Recording attached');
    }
    
    function attachVideo() {
      attachedEvidence.push({ type: 'video', name: 'video_' + Date.now() + '.mp4' });
      updateAttachedFiles();
      showToast('ðŸ“¹ Video attached');
    }
    
    function updateAttachedFiles() {
      var container = document.getElementById('attachedFiles');
      if (attachedEvidence.length === 0) {
        container.style.display = 'none';
        return;
      }
      
      container.style.display = 'flex';
      container.innerHTML = attachedEvidence.map(function(file, i) {
        var icon = file.type === 'photo' ? 'ðŸ“·' : (file.type === 'audio' ? 'ðŸŽ™ï¸' : 'ðŸ“¹');
        return '<div class="attached-file"><span>' + icon + '</span><span>' + file.name + '</span><span class="attached-file-remove" onclick="removeAttachment(' + i + ')">âœ•</span></div>';
      }).join('');
    }
    
    function removeAttachment(index) {
      attachedEvidence.splice(index, 1);
      updateAttachedFiles();
    }
    
    function submitReport() {
      if (!selectedIncidentType) {
        showToast('âš ï¸ Please select threat type');
        return;
      }
      
      if (!selectedLocation && !document.getElementById('manualLocation').value) {
        showToast('âš ï¸ Please add a location');
        return;
      }
      
      var description = document.getElementById('reportDescription').value.trim();
      var isAnonymous = document.getElementById('anonymousToggle').checked;
      var location = selectedLocation || document.getElementById('manualLocation').value;
      
      document.getElementById('submittedTypeIcon').textContent = incidentIcons[selectedIncidentType];
      document.getElementById('submittedType').textContent = incidentLabels[selectedIncidentType];
      document.getElementById('submittedLocation').textContent = location;
      document.getElementById('submittedDesc').textContent = description || 'No additional details provided.';
      
      var severityEl = document.getElementById('submittedSeverity');
      var urgencyLabels = { low: 'Past', medium: 'Active', high: 'DANGER' };
      severityEl.textContent = urgencyLabels[selectedSeverity];
      severityEl.className = 'submitted-severity ' + selectedSeverity;
      
      document.getElementById('submittedAnon').textContent = isAnonymous ? 'ðŸŽ­ Anonymous' : 'ðŸ‘¤ Identified';
      
      document.getElementById('reportForm').style.display = 'none';
      document.getElementById('reportSubmitted').style.display = 'block';
      
      document.getElementById('island').classList.add('expanded');
      document.querySelector('.island-icon').textContent = 'ðŸš¨';
      document.querySelector('.island-title').textContent = 'Alert Sent';
      document.querySelector('.island-sub').textContent = 'Notifying authorities';
      
      setTimeout(function() {
        document.getElementById('island').classList.remove('expanded');
      }, 3000);
      
      showToast('ðŸš¨ Security alert submitted!');
      try { navigator.vibrate([50, 30, 50, 30, 50]); } catch(e) {}
    }
    
    function shareReport() {
      showToast('ðŸ“¤ Share options opened');
    }
    
    function newReport() {
      selectedIncidentType = '';
      selectedSeverity = 'medium';
      selectedLocation = '';
      attachedEvidence = [];
      
      document.querySelectorAll('.incident-type').forEach(function(el) {
        el.classList.remove('selected');
      });
      document.querySelectorAll('.severity-option').forEach(function(el) {
        el.classList.remove('selected');
      });
      document.querySelector('.severity-option.medium').classList.add('selected');
      
      document.querySelector('.location-current').classList.remove('selected');
      document.getElementById('currentLocationLabel').textContent = 'Use Current Location';
      document.getElementById('currentLocationAddress').textContent = 'Tap to detect your location';
      document.getElementById('locationCheck').style.display = 'none';
      document.getElementById('manualLocation').value = '';
      document.getElementById('reportDescription').value = '';
      document.getElementById('anonymousToggle').checked = true;
      document.getElementById('attachedFiles').style.display = 'none';
      
      document.getElementById('reportForm').style.display = 'block';
      document.getElementById('reportSubmitted').style.display = 'none';
    }
    
    // =============================================
    // SETTINGS
    // =============================================
    function openSettingsSubScreen(type) {
      if (type === 'language') {
        showLanguageSelector();
      } else {
        showToast('Opening ' + type + ' settings');
      }
    }
    
    function showLanguageSelector() {
      document.getElementById('languageModal').classList.add('show');
    }
    
    function closeLanguageModal() {
      document.getElementById('languageModal').classList.remove('show');
    }
    
    function selectLanguage(lang) {
      currentLanguage = lang;
      var config = languageConfig[lang];
      
      // Update UI
      document.querySelectorAll('.language-option').forEach(function(opt) {
        opt.classList.remove('selected');
      });
      document.querySelector('.language-option[data-lang="' + lang + '"]').classList.add('selected');
      
      // Update settings display
      document.getElementById('currentLangDisplay').textContent = config.name;
      
      // Update voice recognition language if active
      if (voiceRecognition) {
        voiceRecognition.lang = config.voiceCode;
      }
      
      // Clear conversation history to start fresh in new language
      conversationHistory = [];
      
      // Update AI greeting in chat
      var welcomeMsg = document.querySelector('.ai-message-text');
      if (welcomeMsg) {
        welcomeMsg.textContent = config.greeting;
      }
      
      // Update AI quick buttons and placeholders
      updateAILanguage(lang);
      
      closeLanguageModal();
      showToast(config.flag + ' ' + config.name + ' selected');
    }
    
    // Language-specific AI quick buttons
    var aiQuickButtons = {
      english: [
        { text: 'Someone following me', query: 'Someone is following me, what should I do?' },
        { text: 'Is this area safe?', query: 'Is Ikeja safe right now?' },
        { text: 'One-chance advice', query: 'What should I do if I get into a one-chance vehicle?' },
        { text: 'Report incident', query: 'Help me report a kidnapping attempt' }
      ],
      yoruba: [
        { text: 'áº¸nikan n táº¹le mi', query: 'áº¸nikan n táº¹le mi, kini mo gbá»dá» á¹£e?' },
        { text: 'á¹¢e agbegbe yii ni aabo?', query: 'á¹¢e Ikeja ni aabo lá»wá»lá»wá»?' },
        { text: 'Imá»ran one-chance', query: 'Kini mo gbá»dá» á¹£e bi mo ba wá» á»ká» one-chance?' },
        { text: 'Jabo iá¹£áº¹láº¹', query: 'Ran mi lá»wá» lati jabo igbiyanju ijipa' }
      ],
      igbo: [
        { text: 'Mmadá»¥ na-eso m', query: 'Mmadá»¥ na-eso m, gá»‹ná»‹ ka m ga-eme?' },
        { text: 'Ebe a á» dá»‹ nchekwa?', query: 'Ikeja á» dá»‹ mma ugbu a?' },
        { text: 'Ndá»¥má»dá»¥ one-chance', query: 'Gá»‹ná»‹ ka m ga-eme ma m banye á»¥gbá» ala one-chance?' },
        { text: 'Ká»á» ihe mere', query: 'Nyere m aka á»‹ká» mwakpo ntá»hapá»¥' }
      ],
      hausa: [
        { text: 'Wani yana bin ni', query: 'Wani yana bin ni, me zan yi?' },
        { text: 'Yankin nan yana da aminci?', query: 'Ko Ikeja tana da aminci yanzu?' },
        { text: 'Shawarar one-chance', query: 'Me zan yi idan na shiga motar one-chance?' },
        { text: 'Rahoto lamari', query: 'Taimaka min in ba da rahoton Æ™oÆ™arin sace mutum' }
      ],
      pidgin: [
        { text: 'Person dey follow me', query: 'Person dey follow me, wetin I go do?' },
        { text: 'This area safe?', query: 'Ikeja safe now?' },
        { text: 'One-chance advice', query: 'Wetin I go do if I enter one-chance motor?' },
        { text: 'Report wahala', query: 'Help me report kidnap attempt' }
      ]
    };
    
    var aiPlaceholders = {
      english: 'Ask me anything about safety...',
      yoruba: 'Beere ohunkohun nipa aabo...',
      igbo: 'Já»¥á» m ihe á» bá»¥la banyere nchekwa...',
      hausa: 'Tambaye ni komai game da tsaro...',
      pidgin: 'Ask me anything about safety...'
    };
    
    var aiWelcomeTexts = {
      english: 'How can I help you stay safe today?',
      yoruba: 'Bawo ni mo á¹£e le ran yin lá»wá» lati wa ni aabo loni?',
      igbo: 'Kedu ka m ga-esi nyere gá»‹ aka á»‹ná» na nchekwa taa?',
      hausa: 'Yaya zan taimaka muku ku kasance lafiya yau?',
      pidgin: 'How I fit help you stay safe today?'
    };
    
    function updateAILanguage(lang) {
      // Update quick buttons
      var quickActionsDiv = document.getElementById('aiQuickActions');
      if (quickActionsDiv && aiQuickButtons[lang]) {
        var html = '';
        aiQuickButtons[lang].forEach(function(btn) {
          html += '<button class="ai-quick-btn" onclick="askAI(\'' + btn.query.replace(/'/g, "\\'") + '\')">' + btn.text + '</button>';
        });
        quickActionsDiv.innerHTML = html;
      }
      
      // Update input placeholder
      var input = document.getElementById('aiChatInput');
      if (input && aiPlaceholders[lang]) {
        input.placeholder = aiPlaceholders[lang];
      }
      
      // Update welcome text
      var welcomeText = document.getElementById('aiWelcomeText');
      if (welcomeText && aiWelcomeTexts[lang]) {
        welcomeText.textContent = aiWelcomeTexts[lang];
      }
    }
    
    function closeSettingsSubScreen() {
      showToast('Closed settings');
    }
    
    // =============================================
    // INITIALIZATION
    // =============================================
    document.addEventListener('DOMContentLoaded', function() {
      initMapDrag();
      updateClock();
      
      // Close search suggestions when clicking outside
      document.addEventListener('click', function(e) {
        if (!e.target.closest('.map-search')) {
          var suggestions = document.getElementById('searchSuggestions');
          if (suggestions) suggestions.classList.remove('show');
        }
      });
      
      // Region pills
      document.querySelectorAll('.region-pill').forEach(function(pill) {
        pill.addEventListener('click', function() {
          document.querySelectorAll('.region-pill').forEach(function(p) {
            p.classList.remove('active');
          });
          this.classList.add('active');
        });
      });
    });
    
    // Also init if DOM already ready
    if (document.readyState !== 'loading') {
      initMapDrag();
    }
    
    // =============================================
    // AI VOICE RECOGNITION
    // =============================================
    var voiceRecognition = null;
    var voiceActive = false;
    var aiVoiceActive = false;
    
    function initVoiceRecognition() {
      if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
        var SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        voiceRecognition = new SpeechRecognition();
        voiceRecognition.continuous = false;
        voiceRecognition.interimResults = false;
        voiceRecognition.lang = languageConfig[currentLanguage].voiceCode || 'en-US';
        
        voiceRecognition.onresult = function(event) {
          var transcript = event.results[0][0].transcript.toLowerCase();
          console.log('Voice heard:', transcript);
          
          // Check for emergency keywords (multi-language)
          if (voiceActive) {
            var emergencyKeywords = [
              // English
              'help', 'emergency', 'sos', 'danger', 'safealert',
              // Yoruba
              'iranlowo', 'eranko', 'wa mi lowo', 'mo wa ninu ewu',
              // Igbo
              'nyere m aka', 'ihe mberede', 'ego m',
              // Hausa
              'taimako', 'gaggawa', 'taimaka mini',
              // Pidgin
              'helep', 'help me', 'wetin happen', 'danger dey'
            ];
            
            var isEmergency = emergencyKeywords.some(function(keyword) {
              return transcript.includes(keyword);
            });
            
            if (isEmergency) {
              showToast('ðŸš¨ Voice SOS Activated!');
              startSOS();
              setTimeout(function() {
                if (holding) triggerEmergency();
              }, 500);
            }
            stopVoiceSOS();
          }
          
          // AI chat input
          if (aiVoiceActive) {
            document.getElementById('aiChatInput').value = transcript;
            stopAIVoice();
            sendAIMessage();
          }
        };
        
        voiceRecognition.onerror = function(event) {
          console.log('Voice error:', event.error);
          stopVoiceSOS();
          stopAIVoice();
        };
        
        voiceRecognition.onend = function() {
          if (voiceActive) {
            try { voiceRecognition.start(); } catch(e) {}
          }
        };
        
        return true;
      }
      return false;
    }
    
    function toggleVoiceSOS() {
      var btn = document.getElementById('aiFloatBtn');
      
      if (voiceActive) {
        stopVoiceSOS();
      } else {
        if (!voiceRecognition) {
          if (!initVoiceRecognition()) {
            showToast('âš ï¸ Voice not supported on this browser');
            return;
          }
        }
        
        voiceActive = true;
        btn.classList.add('listening');
        showToast('ðŸŽ¤ Listening... Say "Help" or "Emergency"');
        
        try {
          voiceRecognition.start();
        } catch(e) {
          console.log('Voice start error:', e);
        }
        
        // Auto-stop after 10 seconds
        setTimeout(function() {
          if (voiceActive) stopVoiceSOS();
        }, 10000);
      }
    }
    
    function stopVoiceSOS() {
      voiceActive = false;
      var btn = document.getElementById('aiFloatBtn');
      if (btn) btn.classList.remove('listening');
      
      if (voiceRecognition) {
        try { voiceRecognition.stop(); } catch(e) {}
      }
    }
    
    // Long-press AI button to open chat
    var aiLongPress = null;
    document.addEventListener('DOMContentLoaded', function() {
      var aiBtn = document.getElementById('aiFloatBtn');
      if (aiBtn) {
        aiBtn.addEventListener('pointerdown', function(e) {
          aiLongPress = setTimeout(function() {
            switchScreen('aiScreen');
            stopVoiceSOS();
          }, 500);
        });
        
        aiBtn.addEventListener('pointerup', function() {
          if (aiLongPress) clearTimeout(aiLongPress);
        });
        
        aiBtn.addEventListener('pointercancel', function() {
          if (aiLongPress) clearTimeout(aiLongPress);
        });
      }
    });
    
    // =============================================
    // REAL AI CHATBOT (Claude API Integration)
    // =============================================
    
    // Conversation history for context
    var conversationHistory = [];
    var isAIThinking = false;
    
    // Get current context for AI
    function getAIContext() {
      var hour = new Date().getHours();
      var timeOfDay = hour < 6 ? 'night' : hour < 12 ? 'morning' : hour < 18 ? 'afternoon' : 'evening';
      var isDark = hour < 6 || hour > 18;
      
      return {
        location: currentCity + ', ' + currentState + ', Nigeria',
        time: timeOfDay,
        isDarkOutside: isDark,
        emergencyActive: emergency,
        recentAlerts: [
          'Kidnapping attempt near University of Lagos (12 min ago)',
          'Armed robbery at Computer Village, Ikeja (18 min ago)',
          'Suspicious activity at Oshodi Under Bridge (45 min ago)'
        ]
      };
    }
    
    // System prompt for SafeAlert AI
    function getSystemPrompt() {
      var ctx = getAIContext();
      var lang = languageConfig[currentLanguage];
      
      return `You are SafeAlert AI, an emergency safety assistant for Nigeria. You help users stay safe with practical, actionable advice.

LANGUAGE INSTRUCTION:
${lang.aiInstruction}
This is CRITICAL - you MUST respond in the specified language. Do not respond in English unless the language is set to English.

CURRENT CONTEXT:
- User Location: ${ctx.location}
- Time: ${ctx.time} (${ctx.isDarkOutside ? 'dark outside' : 'daylight'})
- Emergency Mode: ${ctx.emergencyActive ? 'ACTIVE - User may be in danger!' : 'Inactive'}
- Recent Alerts Nearby: ${ctx.recentAlerts.join('; ')}

YOUR CAPABILITIES:
1. Provide immediate safety advice for dangerous situations
2. Help report incidents (kidnapping, robbery, one-chance, suspicious activity)
3. Assess risk levels based on location and time
4. Guide users through emergency procedures
5. Suggest when to use app features (SOS, Check-In Timer, Evidence Recorder)

NIGERIA-SPECIFIC KNOWLEDGE:
- Emergency numbers: 112 (general), 199 (police), 767 (Lagos emergency)
- Common threats: One-chance (fake taxis), kidnapping, armed robbery, ritual killings
- High-risk times: Late night, early morning, during fuel scarcity
- Safety advice should consider Nigerian infrastructure and police response times

RESPONSE GUIDELINES:
- Keep responses concise (under 150 words)
- Always provide actionable steps
- If user seems in immediate danger, prioritize their safety
- Suggest relevant app features when appropriate
- Be empathetic but focused on practical help
- Use Nigerian context (mention landmarks, local terms when relevant)
- REMEMBER: Respond in ${lang.name} as instructed above!

RESPONSE FORMAT:
Always respond with a JSON object in this exact format:
{
  "message": "Your response text here IN ${lang.name.toUpperCase()}",
  "urgency": "low|medium|high|critical",
  "suggestedActions": ["Action 1 in ${lang.name}", "Action 2 in ${lang.name}"],
  "triggerSOS": false,
  "triggerTimer": false
}

DO NOT include any text outside the JSON object. Your entire response must be valid JSON.`;
    }
    
    // Call Claude API
    async function callClaudeAI(userMessage) {
      // Intelligent pattern-based AI that works offline
      // Analyzes user message and provides contextual safety advice
      
      var msg = userMessage.toLowerCase();
      var response = {
        message: '',
        urgency: 'low',
        suggestedActions: [],
        triggerSOS: false,
        triggerTimer: false
      };
      
      // Get current time context
      var hour = new Date().getHours();
      var isNight = hour >= 20 || hour < 6;
      var timeContext = isNight ? 'late at night' : (hour < 12 ? 'this morning' : 'today');
      
      // CRITICAL: Kidnapping / Abduction
      if (msg.includes('kidnap') || msg.includes('abduct') || msg.includes('taken') || msg.includes('grabbed') || 
          msg.includes('snatched') || msg.includes('ji mi') || msg.includes('sace')) {
        response.urgency = 'critical';
        response.triggerSOS = true;
        response.message = "ðŸš¨ THIS IS EXTREMELY SERIOUS!\n\n" +
          "If you or someone is being kidnapped RIGHT NOW:\n\n" +
          "1. ACTIVATE SOS IMMEDIATELY - Hold the red button for 3 seconds\n" +
          "2. If you can, note: vehicle color/type, direction of travel, number of people\n" +
          "3. Drop any personal items if possible - they can help track you\n" +
          "4. If you have phone access, keep this line open\n\n" +
          "If reporting for someone else:\n" +
          "â€¢ Call 112 or 199 IMMEDIATELY\n" +
          "â€¢ Contact the nearest police station\n" +
          "â€¢ Share last known location\n\n" +
          "DO NOT attempt rescue alone. Get authorities involved NOW.";
        response.suggestedActions = ['ðŸš¨ Activate SOS NOW', 'Call 112', 'Call 199'];
      }
      
      // Being followed
      else if (msg.includes('follow') || msg.includes('behind me') || msg.includes('stalking') || 
               msg.includes('tailing') || msg.includes('watching me') || msg.includes('n táº¹le mi') ||
               msg.includes('na-eso m') || msg.includes('yana bin ni')) {
        response.urgency = 'high';
        response.triggerTimer = true;
        response.message = "âš ï¸ Being followed is dangerous. Stay calm and act smart:\n\n" +
          "IMMEDIATE ACTIONS:\n" +
          "â€¢ Change direction 2-3 times to confirm you're being followed\n" +
          "â€¢ Head to a PUBLIC, CROWDED place - mall, busy store, filling station\n" +
          "â€¢ DO NOT go home - don't reveal where you live\n" +
          "â€¢ DO NOT go to isolated areas, even if it seems like a shortcut\n\n" +
          "WHILE MOVING:\n" +
          "â€¢ Call someone and talk loudly about your location\n" +
          "â€¢ Take photos/videos discreetly if safe\n" +
          "â€¢ Enter any open shop and explain your situation\n\n" +
          (isNight ? "âš ï¸ It's late - prioritize getting to a safe, well-lit location with other people.\n\n" : "") +
          "If they approach or situation escalates, USE THE SOS BUTTON.";
        response.suggestedActions = ['Start Check-In Timer', 'Call 112 or 199', 'Use SOS if escalates', 'Share Location'];
      }
      
      // One Chance
      else if (msg.includes('one chance') || msg.includes('one-chance') || msg.includes('suspicious vehicle') ||
               msg.includes('suspicious car') || msg.includes('taxi') || msg.includes('keke') || msg.includes('bus')) {
        response.urgency = 'high';
        response.message = "ðŸš— ONE CHANCE AWARENESS:\n\n" +
          "BEFORE entering any vehicle:\n" +
          "â€¢ Check for central lock control - avoid if you can't see it\n" +
          "â€¢ Trust your instincts - if something feels wrong, DON'T enter\n" +
          "â€¢ Avoid vehicles with tinted windows you can't see through\n" +
          "â€¢ Note the plate number and send to someone before entering\n\n" +
          "IF ALREADY INSIDE a suspicious vehicle:\n" +
          "â€¢ Stay calm - panicking alerts them\n" +
          "â€¢ Press SOS button discreetly if possible\n" +
          "â€¢ If doors are unlocked, exit at the next traffic stop\n" +
          "â€¢ Create a scene if in public - shout, honk, attract attention\n" +
          "â€¢ If you have a window, signal to other motorists\n\n" +
          "RED FLAGS:\n" +
          "â€¢ Driver takes unusual route\n" +
          "â€¢ Other passengers seem to know the driver\n" +
          "â€¢ Doors lock automatically after entering";
        response.suggestedActions = ['Start Trip Monitor', 'Share Live Location', 'Note Plate Number'];
      }
      
      // Armed Robbery
      else if (msg.includes('robbery') || msg.includes('robber') || msg.includes('gun') || msg.includes('knife') ||
               msg.includes('weapon') || msg.includes('thief') || msg.includes('stealing') || msg.includes('ole')) {
        response.urgency = 'critical';
        response.message = "ðŸš¨ ARMED ROBBERY GUIDANCE:\n\n" +
          "IF HAPPENING NOW:\n" +
          "â€¢ DO NOT resist - your life is more valuable than property\n" +
          "â€¢ Keep hands visible, move slowly\n" +
          "â€¢ Comply with demands calmly\n" +
          "â€¢ Avoid eye contact but try to note details: height, clothing, voice, scars\n" +
          "â€¢ Don't chase them when they leave\n\n" +
          "AFTER THEY LEAVE:\n" +
          "â€¢ Activate SOS immediately\n" +
          "â€¢ Call 112 or 199\n" +
          "â€¢ Note direction they went, vehicle if any\n" +
          "â€¢ Don't touch anything - preserve evidence\n" +
          "â€¢ Check on others around you\n\n" +
          "REPORTING:\n" +
          "â€¢ Time of incident\n" +
          "â€¢ Number of attackers\n" +
          "â€¢ Weapons seen\n" +
          "â€¢ Vehicle details if applicable\n" +
          "â€¢ Items taken";
        response.suggestedActions = ['Activate SOS', 'Call 112', 'Report Incident'];
      }
      
      // Area Safety Check
      else if (msg.includes('safe') && (msg.includes('area') || msg.includes('place') || msg.includes('location') ||
               msg.includes('ikeja') || msg.includes('lekki') || msg.includes('vi') || msg.includes('yaba') ||
               msg.includes('surulere') || msg.includes('maryland') || msg.includes('oshodi'))) {
        response.urgency = 'low';
        response.message = "ðŸ“ AREA SAFETY CHECK:\n\n" +
          "I can see alerts in your area from the community. Here's general guidance:\n\n" +
          "CHECK THE HUB TAB for real-time alerts from your community - it shows:\n" +
          "â€¢ Recent incidents by region\n" +
          "â€¢ Time since reported\n" +
          "â€¢ Severity levels\n\n" +
          "GENERAL SAFETY " + (isNight ? "AT NIGHT" : "TIPS") + ":\n" +
          (isNight ? 
            "â€¢ Avoid walking alone after dark\nâ€¢ Stick to well-lit, busy roads\nâ€¢ Have your emergency contacts ready\nâ€¢ Consider using the Check-In Timer\n" :
            "â€¢ Stay aware of your surroundings\nâ€¢ Keep valuables hidden\nâ€¢ Trust your instincts\nâ€¢ Know your exit routes\n"
          ) +
          "\nWant me to help you start trip monitoring or set a check-in timer?";
        response.suggestedActions = ['Check Hub Alerts', 'Start Trip Monitor', 'Set Check-In Timer'];
      }
      
      // Emergency numbers
      else if (msg.includes('emergency') || msg.includes('number') || msg.includes('call') || msg.includes('police') ||
               msg.includes('help') || msg.includes('ambulance') || msg.includes('fire')) {
        response.urgency = 'medium';
        response.message = "ðŸ“ž NIGERIAN EMERGENCY NUMBERS:\n\n" +
          "ðŸš” POLICE:\n" +
          "â€¢ 112 (National Emergency)\n" +
          "â€¢ 199 (Police Emergency)\n" +
          "â€¢ 767 (Lagos LNSC)\n\n" +
          "ðŸš’ FIRE SERVICE:\n" +
          "â€¢ 112\n\n" +
          "ðŸ¥ AMBULANCE/MEDICAL:\n" +
          "â€¢ 112\n" +
          "â€¢ LASAMBUS (Lagos): 767\n\n" +
          "ðŸ›¡ï¸ OTHER:\n" +
          "â€¢ NSCDC: 0800-226-786\n" +
          "â€¢ DSS: 09-234-3987\n\n" +
          "ðŸ’¡ TIP: Save these numbers offline. In SafeAlert, you can also use the SOS button to alert your personal emergency contacts automatically.";
        response.suggestedActions = ['Call 112', 'Call 199', 'View All Contacts'];
      }
      
      // Night Safety
      else if (msg.includes('night') || msg.includes('dark') || msg.includes('late') || isNight) {
        response.urgency = isNight ? 'high' : 'medium';
        response.triggerTimer = true;
        response.message = "ðŸŒ™ NIGHT SAFETY ADVICE:\n\n" +
          (isNight ? "It's currently nighttime - extra caution is needed.\n\n" : "") +
          "BEFORE GOING OUT:\n" +
          "â€¢ Tell someone your destination and expected return time\n" +
          "â€¢ Start a Check-In Timer in SafeAlert\n" +
          "â€¢ Ensure your phone is charged\n" +
          "â€¢ Have emergency numbers saved\n\n" +
          "WHILE OUT:\n" +
          "â€¢ Stick to well-lit, busy areas\n" +
          "â€¢ Avoid shortcuts through dark streets\n" +
          "â€¢ Stay alert - don't use earphones\n" +
          "â€¢ Keep your phone accessible but not visible\n" +
          "â€¢ Travel with others when possible\n\n" +
          "TRANSPORT:\n" +
          "â€¢ Use trusted services (Uber/Bolt/verified taxis)\n" +
          "â€¢ Share your trip details with someone\n" +
          "â€¢ Verify plate numbers match the app";
        response.suggestedActions = ['Start Check-In Timer', 'Share Trip', 'View Area Alerts'];
      }
      
      // Report incident
      else if (msg.includes('report') || msg.includes('incident') || msg.includes('happened') || msg.includes('saw')) {
        response.urgency = 'medium';
        response.message = "ðŸ“ REPORTING AN INCIDENT:\n\n" +
          "Use the REPORT feature in SafeAlert to:\n" +
          "â€¢ Submit details about what happened\n" +
          "â€¢ Include location (auto-detected or manual)\n" +
          "â€¢ Attach photos/videos as evidence\n" +
          "â€¢ Rate severity level\n" +
          "â€¢ Choose anonymous reporting if needed\n\n" +
          "YOUR REPORT:\n" +
          "â€¢ Alerts the community in real-time\n" +
          "â€¢ Helps others avoid dangerous areas\n" +
          "â€¢ Creates a record for authorities\n" +
          "â€¢ Could save lives\n\n" +
          "For IMMEDIATE emergencies, use SOS button first, then report.";
        response.suggestedActions = ['Report Now', 'Use SOS First', 'Call Police'];
      }
      
      // Default helpful response
      else {
        response.urgency = 'low';
        response.message = "I'm here to help keep you safe. Here's what I can assist with:\n\n" +
          "ðŸ†˜ EMERGENCY FEATURES:\n" +
          "â€¢ SOS Button - Alerts all your emergency contacts\n" +
          "â€¢ Check-In Timer - Alerts contacts if you don't check in\n" +
          "â€¢ Evidence Recorder - Record audio/video\n\n" +
          "ðŸ“ AWARENESS:\n" +
          "â€¢ Real-time community alerts\n" +
          "â€¢ Trip monitoring with live location sharing\n" +
          "â€¢ Area safety information\n\n" +
          "ðŸ’¬ ASK ME ABOUT:\n" +
          "â€¢ \"Someone is following me\"\n" +
          "â€¢ \"Is this area safe?\"\n" +
          "â€¢ \"One chance vehicle signs\"\n" +
          "â€¢ \"What to do during robbery\"\n" +
          "â€¢ \"Emergency numbers\"\n\n" +
          "How can I help you " + timeContext + "?";
        response.suggestedActions = ['Check Area Safety', 'Start Check-In', 'View Alerts'];
      }
      
      // Add to conversation history for context
      conversationHistory.push({ role: 'user', content: userMessage });
      conversationHistory.push({ role: 'assistant', content: response.message });
      
      // Keep only last 10 messages
      if (conversationHistory.length > 10) {
        conversationHistory = conversationHistory.slice(-10);
      }
      
      // Simulate slight delay for natural feel
      await new Promise(resolve => setTimeout(resolve, 500 + Math.random() * 500));
      
      return response;
    }
    
    // Ask AI with a preset question
    function askAI(question) {
      document.getElementById('aiChatInput').value = question;
      sendAIMessage();
    }
    
    // Reset AI chat - start fresh conversation
    function resetAIChat() {
      var container = document.getElementById('aiChatContainer');
      var lang = languageConfig[currentLanguage];
      
      // Clear conversation history
      conversationHistory = [];
      
      // Reset isAIThinking flag
      isAIThinking = false;
      
      // Get language-specific buttons
      var buttons = aiQuickButtons[currentLanguage] || aiQuickButtons.english;
      var welcomeText = aiWelcomeTexts[currentLanguage] || aiWelcomeTexts.english;
      
      // Build buttons HTML
      var buttonsHtml = '';
      buttons.forEach(function(btn) {
        buttonsHtml += '<button class="ai-quick-btn" onclick="askAI(\'' + btn.query.replace(/'/g, "\\'") + '\')">' + btn.text + '</button>';
      });
      
      // Rebuild initial message
      container.innerHTML = 
        '<div class="ai-message assistant">' +
          'ðŸ‘‹ ' + lang.greeting + '<br><br>' +
          'ðŸ§  <strong>Understand your situation</strong> - I analyze context, time, and location<br>' +
          'ðŸŽ¯ <strong>Give personalized advice</strong> - Context-aware safety guidance<br>' +
          'ðŸ“Š <strong>Assess risks</strong> - Based on current alerts and patterns<br>' +
          'ðŸ—£ï¸ <strong>Parse voice reports</strong> - Speak naturally, I\'ll understand<br><br>' +
          '<span id="aiWelcomeText">' + welcomeText + '</span>' +
          '<div class="ai-quick-actions" id="aiQuickActions">' + buttonsHtml + '</div>' +
        '</div>';
      
      showToast('ðŸ”„ Chat reset');
    }
    
    // Send message to AI
    async function sendAIMessage() {
      var input = document.getElementById('aiChatInput');
      var message = input.value.trim();
      
      if (!message || isAIThinking) return;
      
      isAIThinking = true;
      var container = document.getElementById('aiChatContainer');
      
      try {
        // Add user message
        container.innerHTML += '<div class="ai-message user">' + escapeHtml(message) + '</div>';
        input.value = '';
        
        // Add thinking indicator
        var thinkingId = 'thinking-' + Date.now();
        container.innerHTML += '<div class="ai-message assistant" id="' + thinkingId + '" style="opacity: 0.6;"><span class="ai-thinking">ðŸ¤” Thinking...</span></div>';
        container.scrollTop = container.scrollHeight;
        
        // Call Claude AI
        var response = await callClaudeAI(message);
        
        // Remove thinking indicator
        var thinkingEl = document.getElementById(thinkingId);
        if (thinkingEl) thinkingEl.remove();
        
        // Build response HTML
        var urgencyBadge = '';
        if (response.urgency === 'critical') {
          urgencyBadge = '<span style="background:rgba(255,55,95,0.2);color:#FF375F;padding:4px 10px;border-radius:10px;font-size:11px;font-weight:600;margin-bottom:8px;display:inline-block;">ðŸš¨ CRITICAL</span><br>';
        } else if (response.urgency === 'high') {
          urgencyBadge = '<span style="background:rgba(255,159,10,0.2);color:#FF9F0A;padding:4px 10px;border-radius:10px;font-size:11px;font-weight:600;margin-bottom:8px;display:inline-block;">âš ï¸ HIGH PRIORITY</span><br>';
        }
        
        var actionsHtml = '';
        if (response.suggestedActions && response.suggestedActions.length > 0) {
          actionsHtml = '<div class="ai-quick-actions">';
          response.suggestedActions.forEach(function(action) {
            actionsHtml += '<button class="ai-quick-btn" onclick="handleAIAction(\'' + escapeHtml(action) + '\')">' + escapeHtml(action) + '</button>';
          });
          actionsHtml += '</div>';
        }
        
        container.innerHTML += '<div class="ai-message assistant">' + urgencyBadge + escapeHtml(response.message).replace(/\n/g, '<br>') + actionsHtml + '</div>';
        container.scrollTop = container.scrollHeight;
        
        // Handle automatic triggers
        if (response.triggerSOS) {
          showToast('ðŸš¨ AI recommends activating SOS!');
        }
        
        if (response.triggerTimer) {
          showToast('â±ï¸ AI suggests starting a Check-In Timer');
        }
        
      } catch (error) {
        console.error('SendAIMessage error:', error);
        
        // Remove thinking indicator if exists
        var thinkingEl = document.querySelector('[id^="thinking-"]');
        if (thinkingEl) thinkingEl.remove();
        
        // Show error message
        container.innerHTML += '<div class="ai-message assistant" style="border-color: rgba(255,55,95,0.3);">Sorry, I encountered an error. Please try again or use the emergency features directly.</div>';
        container.scrollTop = container.scrollHeight;
      }
      
      isAIThinking = false;
    }
    
    // Escape HTML to prevent XSS
    function escapeHtml(text) {
      var div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // Handle AI suggested actions
    function handleAIAction(action) {
      var actionLower = action.toLowerCase();
      
      if (actionLower.includes('sos') || actionLower.includes('emergency button')) {
        showToast('Hold the SOS button for 3 seconds');
        switchScreen('homeScreen');
      } else if (actionLower.includes('timer') || actionLower.includes('check-in')) {
        switchScreen('checkinScreen');
      } else if (actionLower.includes('call') && (actionLower.includes('112') || actionLower.includes('police') || actionLower.includes('emergency'))) {
        window.location.href = 'tel:112';
      } else if (actionLower.includes('call') && actionLower.includes('199')) {
        window.location.href = 'tel:199';
      } else if (actionLower.includes('alert') || actionLower.includes('hub') || actionLower.includes('view')) {
        switchScreen('hubScreen');
      } else if (actionLower.includes('share location') || actionLower.includes('send location')) {
        showToast('ðŸ“ Location shared with emergency contacts');
      } else if (actionLower.includes('contact') || actionLower.includes('setting')) {
        switchScreen('settingsScreen');
      } else if (actionLower.includes('report') || actionLower.includes('incident')) {
        switchScreen('reportScreen');
      } else if (actionLower.includes('record') || actionLower.includes('evidence')) {
        switchScreen('recordScreen');
      } else if (actionLower.includes('map') || actionLower.includes('safe zone') || actionLower.includes('route')) {
        switchScreen('mapScreen');
      } else {
        // If action is a question, ask the AI
        askAI(action);
      }
    }
    
    // =============================================
    // AI-POWERED VOICE REPORT PARSING
    // =============================================
    async function parseVoiceReport(transcript) {
      var parsePrompt = `Parse this incident report and extract structured data. Report: "${transcript}"

Respond ONLY with a valid JSON object in this format:
{
  "incidentType": "kidnapping|robbery|one_chance|suspicious|shooting|other",
  "severity": "low|medium|high",
  "location": "extracted location or null",
  "description": "cleaned up description",
  "vehicleInfo": "any vehicle details or null",
  "suspectCount": number or null,
  "weaponsInvolved": true|false|null
}`;

      try {
        var response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 500,
            messages: [{
              role: 'user',
              content: parsePrompt
            }]
          })
        });
        
        var data = await response.json();
        var responseText = data.content[0].text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        return JSON.parse(responseText);
        
      } catch (error) {
        console.error('Voice parse error:', error);
        return null;
      }
    }
    
    // Auto-fill report form from voice
    async function fillReportFromVoice(transcript) {
      showToast('ðŸ¤– AI is analyzing your report...');
      
      var parsed = await parseVoiceReport(transcript);
      
      if (parsed) {
        // Map incident type to selector
        var typeMap = {
          'kidnapping': 'kidnapping',
          'robbery': 'robbery',
          'one_chance': 'onechance',
          'suspicious': 'cultist',
          'shooting': 'shooting',
          'other': 'other'
        };
        
        if (parsed.incidentType && typeMap[parsed.incidentType]) {
          var typeEl = document.querySelector('.incident-type[onclick*="' + typeMap[parsed.incidentType] + '"]');
          if (typeEl) {
            selectIncidentType(typeMap[parsed.incidentType], typeEl);
          }
        }
        
        // Set severity
        if (parsed.severity) {
          var sevEl = document.querySelector('.severity-option.' + parsed.severity);
          if (sevEl) {
            selectSeverity(parsed.severity, sevEl);
          }
        }
        
        // Fill description
        if (parsed.description) {
          document.getElementById('reportDescription').value = parsed.description;
        }
        
        // Fill location if found
        if (parsed.location) {
          document.getElementById('manualLocation').value = parsed.location;
          selectedLocation = parsed.location;
        }
        
        showToast('âœ… Report auto-filled by AI! Review and submit.');
      } else {
        showToast('Could not parse. Please fill manually.');
      }
    }
    
    // =============================================
    // AI RISK ASSESSMENT
    // =============================================
    async function assessRisk(destination) {
      var ctx = getAIContext();
      
      var riskPrompt = `Assess the safety risk for traveling to ${destination} from ${ctx.location}.
Current time: ${ctx.time} (${ctx.isDarkOutside ? 'dark' : 'daylight'})
Recent alerts: ${ctx.recentAlerts.join('; ')}

Respond ONLY with valid JSON:
{
  "riskScore": 1-10,
  "riskLevel": "low|moderate|high|dangerous",
  "warnings": ["warning1", "warning2"],
  "recommendations": ["rec1", "rec2"],
  "safetyTips": "brief safety tip"
}`;

      try {
        var response = await fetch('https://api.anthropic.com/v1/messages', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            model: 'claude-sonnet-4-20250514',
            max_tokens: 500,
            messages: [{
              role: 'user',
              content: riskPrompt
            }]
          })
        });
        
        var data = await response.json();
        var responseText = data.content[0].text.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        return JSON.parse(responseText);
        
      } catch (error) {
        console.error('Risk assessment error:', error);
        return null;
      }
    }
    
    function toggleAIVoice() {
      var btn = document.getElementById('aiVoiceBtn');
      
      if (aiVoiceActive) {
        stopAIVoice();
      } else {
        if (!voiceRecognition) {
          if (!initVoiceRecognition()) {
            showToast('âš ï¸ Voice not supported');
            return;
          }
        }
        
        aiVoiceActive = true;
        btn.classList.add('listening');
        showToast('ðŸŽ¤ Speak your message...');
        
        try {
          voiceRecognition.start();
        } catch(e) {
          console.log('AI voice error:', e);
        }
      }
    }
    
    function stopAIVoice() {
      aiVoiceActive = false;
      var btn = document.getElementById('aiVoiceBtn');
      if (btn) btn.classList.remove('listening');
      
      if (voiceRecognition) {
        try { voiceRecognition.stop(); } catch(e) {}
      }
    }
    
    // Initialize voice on load
    setTimeout(function() {
      initVoiceRecognition();
    }, 2000);
    
    // =============================================
    // PWA SERVICE WORKER REGISTRATION
    // =============================================
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('service-worker.js')
          .then(function(registration) {
            console.log('âœ… ServiceWorker registered:', registration.scope);
            
            // Check for updates
            registration.addEventListener('updatefound', function() {
              var newWorker = registration.installing;
              newWorker.addEventListener('statechange', function() {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  // New version available
                  showUpdateNotification();
                }
              });
            });
          })
          .catch(function(error) {
            console.log('âš ï¸ ServiceWorker registration failed:', error);
          });
      });
    }
    
    // Show update notification
    function showUpdateNotification() {
      var toast = document.createElement('div');
      toast.className = 'pwa-update-toast';
      toast.innerHTML = 'ðŸ”„ New version available! <button onclick="location.reload()">Update</button>';
      toast.style.cssText = 'position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:#1C1C1E;border:1px solid #FF375F;padding:12px 20px;border-radius:30px;z-index:10000;display:flex;align-items:center;gap:12px;font-size:14px;';
      toast.querySelector('button').style.cssText = 'background:#FF375F;border:none;color:#fff;padding:8px 16px;border-radius:20px;font-weight:600;cursor:pointer;';
      document.body.appendChild(toast);
    }
    
    // PWA Install Prompt
    var deferredPrompt;
    window.addEventListener('beforeinstallprompt', function(e) {
      e.preventDefault();
      deferredPrompt = e;
      showInstallButton();
    });
    
    function showInstallButton() {
      // Add install button to settings or show banner
      var installBanner = document.createElement('div');
      installBanner.id = 'installBanner';
      installBanner.innerHTML = '<div style="display:flex;align-items:center;gap:12px;"><span style="font-size:24px;">ðŸ“²</span><div><strong>Install SafeAlert</strong><br><span style="font-size:12px;color:#8E8E93;">Add to home screen for quick access</span></div></div><button id="installBtn" style="background:#FF375F;border:none;color:#fff;padding:10px 20px;border-radius:20px;font-weight:600;cursor:pointer;">Install</button><button id="dismissInstall" style="background:none;border:none;color:#8E8E93;font-size:20px;cursor:pointer;">âœ•</button>';
      installBanner.style.cssText = 'position:fixed;bottom:90px;left:16px;right:16px;max-width:400px;margin:0 auto;background:#1C1C1E;border:1px solid rgba(255,255,255,0.1);padding:16px;border-radius:20px;z-index:9999;display:flex;align-items:center;justify-content:space-between;gap:12px;animation:slideUp 0.3s ease;';
      document.body.appendChild(installBanner);
      
      document.getElementById('installBtn').addEventListener('click', installPWA);
      document.getElementById('dismissInstall').addEventListener('click', function() {
        installBanner.remove();
        localStorage.setItem('installDismissed', 'true');
      });
    }
    
    function installPWA() {
      if (!deferredPrompt) return;
      
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then(function(choiceResult) {
        if (choiceResult.outcome === 'accepted') {
          console.log('âœ… User accepted install');
          showToast('âœ… SafeAlert installed!');
        }
        deferredPrompt = null;
        var banner = document.getElementById('installBanner');
        if (banner) banner.remove();
      });
    }
    
    // Check if running as PWA
    function isPWA() {
      return window.matchMedia('(display-mode: standalone)').matches || 
             window.navigator.standalone === true;
    }
    
    // PWA-specific adjustments
    if (isPWA()) {
      document.body.classList.add('pwa-mode');
      console.log('ðŸ“± Running as PWA');
    }
    
    // Handle offline/online status
    function updateOnlineStatus() {
      if (!navigator.onLine) {
        showToast('ðŸ“¡ You\'re offline. Some features may be limited.');
        document.body.classList.add('offline-mode');
      } else {
        document.body.classList.remove('offline-mode');
      }
    }
    
    window.addEventListener('online', function() {
      showToast('âœ… Back online!');
      document.body.classList.remove('offline-mode');
    });
    
    window.addEventListener('offline', function() {
      showToast('ðŸ“¡ You\'re offline');
      document.body.classList.add('offline-mode');
    });
    
    // Initial online check
    updateOnlineStatus();
    
    // =============================================
    // SWIPE TO DISMISS - KIDNAP ALERT
    // =============================================
    (function initSwipeToDismiss() {
      var banner = document.getElementById('kidnapBanner');
      if (!banner) return;
      
      var startX = 0;
      var currentX = 0;
      var isDragging = false;
      var threshold = 100; // pixels to swipe before dismissing
      
      banner.addEventListener('touchstart', function(e) {
        startX = e.touches[0].clientX;
        currentX = startX;
        isDragging = true;
        banner.classList.add('swiping');
      }, { passive: true });
      
      banner.addEventListener('touchmove', function(e) {
        if (!isDragging) return;
        currentX = e.touches[0].clientX;
        var diffX = currentX - startX;
        
        // Move the banner
        banner.style.transform = 'translateX(' + diffX + 'px)';
        
        // Fade based on distance
        var opacity = 1 - Math.abs(diffX) / 300;
        banner.style.opacity = Math.max(0.3, opacity);
      }, { passive: true });
      
      banner.addEventListener('touchend', function(e) {
        if (!isDragging) return;
        isDragging = false;
        banner.classList.remove('swiping');
        
        var diffX = currentX - startX;
        
        if (Math.abs(diffX) > threshold) {
          // Dismiss the banner
          if (diffX > 0) {
            banner.classList.add('dismissed');
          } else {
            banner.classList.add('dismissed-left');
          }
          
          // Show toast
          showToast('âœ“ Alert dismissed');
          
          // Vibrate if supported
          if (navigator.vibrate) {
            navigator.vibrate(50);
          }
          
          // Completely hide after animation
          setTimeout(function() {
            banner.classList.add('hiding');
          }, 300);
          
          // Store dismissal in localStorage
          localStorage.setItem('kidnapAlertDismissed', Date.now());
          
        } else {
          // Snap back
          banner.style.transform = '';
          banner.style.opacity = '';
        }
      }, { passive: true });
      
      // Also support mouse drag for desktop
      banner.addEventListener('mousedown', function(e) {
        startX = e.clientX;
        currentX = startX;
        isDragging = true;
        banner.classList.add('swiping');
        e.preventDefault();
      });
      
      document.addEventListener('mousemove', function(e) {
        if (!isDragging) return;
        currentX = e.clientX;
        var diffX = currentX - startX;
        banner.style.transform = 'translateX(' + diffX + 'px)';
        var opacity = 1 - Math.abs(diffX) / 300;
        banner.style.opacity = Math.max(0.3, opacity);
      });
      
      document.addEventListener('mouseup', function(e) {
        if (!isDragging) return;
        isDragging = false;
        banner.classList.remove('swiping');
        
        var diffX = currentX - startX;
        
        if (Math.abs(diffX) > threshold) {
          if (diffX > 0) {
            banner.classList.add('dismissed');
          } else {
            banner.classList.add('dismissed-left');
          }
          showToast('âœ“ Alert dismissed');
          if (navigator.vibrate) navigator.vibrate(50);
          setTimeout(function() {
            banner.classList.add('hiding');
          }, 300);
          localStorage.setItem('kidnapAlertDismissed', Date.now());
        } else {
          banner.style.transform = '';
          banner.style.opacity = '';
        }
      });
      
      // Check if already dismissed today
      var dismissed = localStorage.getItem('kidnapAlertDismissed');
      if (dismissed) {
        var dismissedTime = parseInt(dismissed);
        var now = Date.now();
        var hoursSince = (now - dismissedTime) / (1000 * 60 * 60);
        
        // If dismissed less than 24 hours ago, keep it hidden
        if (hoursSince < 24) {
          banner.classList.add('dismissed');
          banner.classList.add('hiding');
        }
      }
    })();
    
    // Function to show kidnap alert again (for testing or new alerts)
    function showKidnapAlert() {
      var banner = document.getElementById('kidnapBanner');
      if (banner) {
        banner.classList.remove('dismissed', 'dismissed-left', 'hiding');
        banner.style.transform = '';
        banner.style.opacity = '';
        localStorage.removeItem('kidnapAlertDismissed');
      }
    }
    
    console.log('ðŸ›¡ï¸ SafeAlert NG loaded successfully!');
    console.log('ðŸ“± PWA Ready: ' + ('serviceWorker' in navigator ? 'Yes' : 'No'));
  </script>
</body>
</html>
